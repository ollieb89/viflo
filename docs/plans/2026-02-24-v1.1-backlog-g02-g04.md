# V1.1 Backlog G-02 G-03 G-04 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add local secret-prevention hooks, expand live `apps/web` tests, and lock in coverage quality enforcement.

**Architecture:** Use root-level Git hooks (Husky + Gitleaks) for developer-side guardrails, augment `apps/web` Vitest coverage with repo-backed live validations, and harden existing coverage ratchet behavior so CI fails on regressions while keeping baseline updates explicit.

**Tech Stack:** pnpm, Husky, Gitleaks, Vitest, TypeScript, GitHub Actions.

### Task 1: G-02 Pre-Commit Hooks (Husky + Gitleaks)

**Files:**

- Modify: `package.json`
- Create: `.husky/pre-commit`
- Create: `.gitleaks.toml`
- Modify: `.github/workflows/ci.yml` (optional CI secret check parity)

**Step 1: Write failing tests/checks first**

- Add/extend CLI tests that assert hook script and gitleaks command wiring exist.

**Step 2: Run test to verify it fails**

- `pnpm run test:cli`

**Step 3: Minimal implementation**

- Add `prepare` script to install Husky hooks.
- Add `precommit:secrets` script running `gitleaks protect --staged --config .gitleaks.toml`.
- Add `.husky/pre-commit` to run lint/tests/secrets check (fast ordering).
- Add basic `.gitleaks.toml` allowlist template tuned for this repo.

**Step 4: Verify passing**

- `pnpm run test:cli`
- `pnpm run precommit:secrets -- --help` (or dry-run equivalent)

### Task 2: G-03 Expand apps/web Live Test Suite

**Files:**

- Create: `apps/web/src/live/` test files (or existing test file extension)
- Modify: `apps/web/package.json` if new script needed

**Step 1: Write failing tests first**

- Add tests that read real repository files and assert:
  - `prompts/sc-reflect.md` and `.toml` exist and have core markers
  - `commands/sg/reflect.md` mirrors core intent markers
  - `INDEX.md` references SC reflect prompt entries

**Step 2: Run test to verify it fails**

- `pnpm --filter @viflo/web run test`

**Step 3: Minimal implementation**

- Add helper(s) under `apps/web/src` for safe file discovery/validation and satisfy tests.

**Step 4: Verify passing**

- `pnpm --filter @viflo/web run test`

### Task 3: G-04 Coverage Ratchet Lock-In

**Files:**

- Modify: `apps/web/scripts/coverage-ratchet.ts`
- Modify: `apps/web/package.json`
- Modify: `.github/workflows/ci.yml` (if needed)

**Step 1: Write failing tests first**

- Add tests for ratchet behavior in CI mode and update mode semantics.

**Step 2: Run test to verify it fails**

- `pnpm --filter @viflo/web run test`

**Step 3: Minimal implementation**

- Ensure CI check mode never auto-updates baseline.
- Keep baseline update explicit through `test:coverage:update`.
- Keep local developer ergonomics for first baseline creation.

**Step 4: Verify passing**

- `pnpm --filter @viflo/web run test`
- `pnpm --filter @viflo/web run test:coverage:ratchet`

### Task 4: Final Validation

- `pnpm run validate:sc-prompts`
- `pnpm run bench:sc-reflect`
- `pnpm run test:cli`
- `pnpm --filter @viflo/web run test`
