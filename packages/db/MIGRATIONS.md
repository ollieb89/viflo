# Database Migrations

This document describes the database migration workflow for Viflo.

## Overview

Viflo uses **PostgreSQL** with **Alembic** (SQLAlchemy 2.0) for database migrations. The database package is located at `packages/db/`.

## Quick Start

### 1. Start PostgreSQL

```bash
# Start the database container
pnpm run db:up

# Or using docker-compose directly
docker-compose -f packages/db/docker-compose.yml up -d
```

### 2. Run Migrations

```bash
# Apply all pending migrations
pnpm run db:migrate

# Or from the packages/db directory
cd packages/db && alembic upgrade head
```

### 3. Reset Database (Fresh Start)

```bash
# Stop, remove volumes, start, and migrate
pnpm run db:reset
```

## Creating New Migrations

### 1. Modify Models

Edit models in `packages/db/src/models/`:

```python
# src/models/my_model.py
from sqlalchemy.orm import Mapped, mapped_column
from models.project import Base

class MyModel(Base):
    __tablename__ = "my_models"

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str]
```

### 2. Generate Migration

```bash
cd packages/db
alembic revision --autogenerate -m "Add my_model table"
```

### 3. Review Migration

Check the generated file in `src/migrations/versions/`:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('my_models', ...)
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('my_models')
    # ### end Alembic commands ###
```

### 4. Apply Migration

```bash
alembic upgrade head
```

## Configuration

### Environment Variables

| Variable            | Default                                                       | Description                  |
| ------------------- | ------------------------------------------------------------- | ---------------------------- |
| `DATABASE_URL`      | `postgresql+asyncpg://postgres:postgres@localhost:5432/viflo` | Full database connection URL |
| `POSTGRES_USER`     | `postgres`                                                    | Database user                |
| `POSTGRES_PASSWORD` | `postgres`                                                    | Database password            |
| `POSTGRES_DB`       | `viflo`                                                       | Database name                |
| `POSTGRES_PORT`     | `5432`                                                        | Database port                |

Copy `.env.template` to `.env` and customize:

```bash
cp .env.template .env
```

## Available Scripts

| Script                | Description                  |
| --------------------- | ---------------------------- |
| `pnpm run db:up`      | Start PostgreSQL container   |
| `pnpm run db:down`    | Stop PostgreSQL container    |
| `pnpm run db:migrate` | Run pending migrations       |
| `pnpm run db:reset`   | Reset database (clean slate) |
| `pnpm run db:test`    | Run integration tests        |

From `packages/db/` directory:

| Script                     | Description            |
| -------------------------- | ---------------------- |
| `pnpm run db:logs`         | View PostgreSQL logs   |
| `pnpm run db:revision`     | Create new migration   |
| `pnpm run db:status`       | Show current migration |
| `pnpm run db:history`      | Show migration history |
| `pnpm run db:migrate:down` | Downgrade one revision |

## CI Integration

The CI workflow includes an `integration` job that:

1. Starts a PostgreSQL service container
2. Installs Python dependencies
3. Runs migrations
4. Executes integration tests

See `.github/workflows/ci.yml` for details.

## Best Practices

1. **Always review auto-generated migrations** — Check for correctness before applying
2. **Test downgrades** — Ensure `alembic downgrade -1` works correctly
3. **Keep migrations atomic** — One logical change per migration
4. **Don't edit applied migrations** — Create new migrations to fix issues
5. **Use transactions** — Migrations run in a transaction when possible

## Troubleshooting

### Cannot connect to database

```bash
# Check if PostgreSQL is running
pnpm run db:up

# Check connection
docker-compose -f packages/db/docker-compose.yml logs postgres
```

### Migration fails

```bash
# Check current migration
alembic current

# Check migration history
alembic history

# Reset and re-apply
pnpm run db:reset
```

### Permission denied

Ensure your `.env` file has correct credentials matching the `docker-compose.yml` configuration.

## Architecture

```
packages/db/
├── src/
│   ├── migrations/          # Alembic migrations
│   │   ├── versions/        # Migration files
│   │   └── env.py          # Alembic environment
│   ├── models/             # SQLAlchemy models
│   │   └── project.py      # Example model
│   └── connection.py       # Database connection
├── tests/integration/      # Integration tests
├── docker-compose.yml      # Local PostgreSQL
├── alembic.ini            # Alembic config
└── pyproject.toml         # Python dependencies
```
