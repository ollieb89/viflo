---
phase: 16-cli-foundation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/paths.cjs
  - bin/lib/writers.cjs
autonomous: true
requirements:
  - INIT-05

must_haves:
  truths:
    - "resolveViFloRoot() returns an absolute path ending in /viflo regardless of process.cwd()"
    - "resolveTargetPath(cwd, ...segments) returns a path.resolve result and throws when cwd is omitted"
    - "writeCLAUDEmd appends a sentinel block when CLAUDE.md has no markers, replaces the block when markers exist, and throws when multiple sentinel blocks are detected"
    - "writeSettingsJson deep-merges viflo's settings into an existing file, preserves unknown keys, deduplicates arrays with existing items first, and viflo scalars win conflicts"
    - "Both writer functions return { written: boolean, reason: string } and emit a console.log skip message when content is unchanged"
  artifacts:
    - path: "bin/lib/paths.cjs"
      provides: "Deterministic absolute path resolution for viflo root and target-project paths"
      exports:
        - resolveViFloRoot
        - resolveTargetPath
    - path: "bin/lib/writers.cjs"
      provides: "Idempotent CLAUDE.md sentinel merge and settings.json deep merge"
      exports:
        - writeCLAUDEmd
        - writeSettingsJson
  key_links:
    - from: "bin/lib/writers.cjs"
      to: "bin/lib/paths.cjs"
      via: "require('./paths.cjs')"
      pattern: "require\\('./paths\\.cjs'\\)"
    - from: "bin/lib/writers.cjs"
      to: "<!-- BEGIN VIFLO -->"
      via: "SENTINEL_START / SENTINEL_END constants"
      pattern: "BEGIN VIFLO"
---

<objective>
Create `bin/lib/paths.cjs` and `bin/lib/writers.cjs` — the two CommonJS library modules that form the stable foundation for all `viflo init` CLI phases.

Purpose: All later phases (17, 18, 19) import these modules directly. Getting path resolution and idempotent file-write semantics correct here means later phases never re-implement or work around them.

Output:
- `bin/lib/paths.cjs` — `resolveViFloRoot()` and `resolveTargetPath(cwd, ...segments)`
- `bin/lib/writers.cjs` — `writeCLAUDEmd(targetCwd, sentinelContent)` and `writeSettingsJson(targetCwd, incomingSettings)`
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cli-foundation/16-CONTEXT.md
@.planning/phases/16-cli-foundation/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bin/lib/paths.cjs</name>
  <files>bin/lib/paths.cjs</files>
  <action>
Create `bin/lib/paths.cjs` as a CommonJS module (`'use strict'`). Use only Node.js built-ins (`path`). No third-party dependencies.

Implement two named exports:

**`resolveViFloRoot()`**
- Returns `path.resolve(__dirname, '..', '..')` — two levels up from `bin/lib/` to the repo root.
- No parameters. Never calls `process.cwd()` or `os.homedir()`.
- JSDoc: "Resolve the viflo installation root. paths.cjs lives at bin/lib/paths.cjs — two levels up is the repo root. Never uses process.cwd() or os.homedir()."

**`resolveTargetPath(cwd, ...segments)`**
- First argument `cwd` is required. If falsy or not a string, throw: `new Error('resolveTargetPath: cwd is required and must be a string')`.
- Returns `path.resolve(cwd, ...segments)`.
- JSDoc: "@param {string} cwd - Explicit working directory of the target project (required). @param {...string} segments - Path segments relative to cwd. @returns {string} Absolute path string."

Export pattern:
```javascript
module.exports = { resolveViFloRoot, resolveTargetPath };
```

Anti-patterns to avoid:
- No `~` literals anywhere.
- No `process.cwd()` or `os.homedir()` calls in production code (tests may mock os).
- No default for `cwd` — the locked decision says it is required.
  </action>
  <verify>
    <automated>node -e "const { resolveViFloRoot, resolveTargetPath } = require('./bin/lib/paths.cjs'); const root = resolveViFloRoot(); if (!root.endsWith('viflo')) throw new Error('root does not end with viflo: ' + root); const t = resolveTargetPath('/tmp/proj', '.claude', 'settings.json'); if (t !== '/tmp/proj/.claude/settings.json') throw new Error('unexpected path: ' + t); try { resolveTargetPath(); throw new Error('should have thrown'); } catch(e) { if (!e.message.includes('cwd is required')) throw e; } console.log('paths.cjs OK');"</automated>
  </verify>
  <done>
    - `bin/lib/paths.cjs` exists and exports `resolveViFloRoot` and `resolveTargetPath`.
    - `resolveViFloRoot()` returns an absolute path ending in `/viflo`.
    - `resolveTargetPath('/tmp/proj', '.claude', 'settings.json')` returns `/tmp/proj/.claude/settings.json`.
    - `resolveTargetPath()` throws with message containing "cwd is required".
    - No `~` literal or `process.cwd()` in the file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bin/lib/writers.cjs</name>
  <files>bin/lib/writers.cjs</files>
  <action>
Create `bin/lib/writers.cjs` as a CommonJS module (`'use strict'`). Use only Node.js built-ins (`fs`, `path`). No third-party dependencies. Import `resolveTargetPath` from `./paths.cjs`.

**Internal helper: `writeIfChanged(filePath, newContent)`**
- Read current file content with `fs.readFileSync(filePath, 'utf-8')`. Catch ENOENT (file does not exist) — treat as `null`.
- If `existing === newContent`: emit `console.log('[viflo] skipped (unchanged): ' + filePath)` and return `{ written: false, reason: 'unchanged' }`.
- Otherwise: call `fs.mkdirSync(path.dirname(filePath), { recursive: true })`, then `fs.writeFileSync(filePath, newContent, 'utf-8')`.
- Return `{ written: true, reason: existing === null ? 'created' : 'updated' }`.

**Sentinel constants (authoritative — NOT the stale STATE.md format):**
```javascript
const SENTINEL_START = '<!-- BEGIN VIFLO -->';
const SENTINEL_END   = '<!-- END VIFLO -->';
```

**Internal helper: `mergeCLAUDEmd(existingContent, sentinelContent)`**
- Count occurrences of SENTINEL_START and SENTINEL_END in `existingContent`.
- If either count > 1: throw `new Error('[viflo] CLAUDE.md contains multiple sentinel blocks. Remove duplicates manually before running viflo init.')`.
- Build `block = SENTINEL_START + '\n' + sentinelContent + '\n' + SENTINEL_END`.
- If startCount === 0 (no existing sentinels): return `existingContent.trimEnd() + '\n\n' + block + '\n'`.
- If startCount === 1: use `indexOf` (not regex) to locate start/end positions. Return `existingContent.slice(0, startIdx) + block + existingContent.slice(endIdx + SENTINEL_END.length)`. Preserve content before and after the block exactly.

**Internal helper: `deepMerge(existing, incoming)`**
- Recursively merge `incoming` into a shallow copy of `existing`.
- For each key in `incoming`:
  - If both values are arrays: `[...new Set([...existing[key], ...incoming[key]])]` (existing first for order stability).
  - If both values are non-null plain objects (not arrays): recurse `deepMerge(existing[key], incoming[key])`.
  - Otherwise: `incoming` value wins (scalars, or type mismatch).
- Unknown keys in `existing` not present in `incoming` are preserved (they stay in the shallow copy).

**Exported: `writeCLAUDEmd(targetCwd, sentinelContent)`**
- `filePath = resolveTargetPath(targetCwd, 'CLAUDE.md')`.
- Read existing content (`fs.readFileSync` + ENOENT catch → empty string `''`).
- If no existing content (file does not exist): `newContent = SENTINEL_START + '\n' + sentinelContent + '\n' + SENTINEL_END + '\n'`.
- If existing content: `newContent = mergeCLAUDEmd(existingContent, sentinelContent)`.
- Return `writeIfChanged(filePath, newContent)`.

**Exported: `writeSettingsJson(targetCwd, incomingSettings)`**
- `filePath = resolveTargetPath(targetCwd, '.claude', 'settings.json')`.
- Read and parse existing JSON (`fs.readFileSync` + JSON.parse; catch ENOENT → `{}`).
- `merged = deepMerge(existing, incomingSettings)`.
- `newContent = JSON.stringify(merged, null, 2) + '\n'` (trailing newline — required, avoids POSIX lint noise).
- Return `writeIfChanged(filePath, newContent)`.

Export pattern:
```javascript
module.exports = { writeCLAUDEmd, writeSettingsJson };
```

Anti-patterns to avoid:
- Never overwrite content outside the sentinel markers.
- Never use regex replace on the sentinel block — use `indexOf` + slice.
- Never write without checking (would break idempotency).
- Always `existing` array first in Set spread for stable order.
- Always add trailing `\n` to JSON output.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const os = require('os');
const path = require('path');
const tmp = fs.mkdtempSync(path.join(os.tmpdir(), 'viflo-test-'));
const { writeCLAUDEmd, writeSettingsJson } = require('./bin/lib/writers.cjs');

// Test 1: writeCLAUDEmd creates file when missing
let r1 = writeCLAUDEmd(tmp, '@skills/nextjs-core.md');
if (!r1.written || r1.reason !== 'created') throw new Error('Test 1 failed: ' + JSON.stringify(r1));

// Test 2: writeCLAUDEmd idempotency
let r2 = writeCLAUDEmd(tmp, '@skills/nextjs-core.md');
if (r2.written || r2.reason !== 'unchanged') throw new Error('Test 2 failed: ' + JSON.stringify(r2));

// Test 3: writeSettingsJson creates + deduplicates
let r3 = writeSettingsJson(tmp, { permissions: { allow: ['Bash(git*)'] } });
if (!r3.written) throw new Error('Test 3 failed: ' + JSON.stringify(r3));
let r4 = writeSettingsJson(tmp, { permissions: { allow: ['Bash(git*)', 'Bash(npm*)'] } });
const content = JSON.parse(fs.readFileSync(path.join(tmp, '.claude', 'settings.json'), 'utf-8'));
if (!content.permissions.allow.includes('Bash(npm*)')) throw new Error('Test 4: missing new entry');
if (content.permissions.allow.filter(x => x === 'Bash(git*)').length !== 1) throw new Error('Test 4: duplicate entry');

// Test 4: sentinel multiple blocks throws
const claudePath = require('path').join(tmp, 'CLAUDE.md');
fs.writeFileSync(claudePath, '<!-- BEGIN VIFLO -->\nfoo\n<!-- END VIFLO -->\n<!-- BEGIN VIFLO -->\nbar\n<!-- END VIFLO -->\n', 'utf-8');
try { writeCLAUDEmd(tmp, 'x'); throw new Error('should have thrown'); } catch(e) { if (!e.message.includes('multiple sentinel')) throw e; }

// Cleanup
fs.rmSync(tmp, { recursive: true });
console.log('writers.cjs OK');
"</automated>
  </verify>
  <done>
    - `bin/lib/writers.cjs` exists and exports `writeCLAUDEmd` and `writeSettingsJson`.
    - `writeCLAUDEmd` creates a new file returning `{ written: true, reason: 'created' }`.
    - Re-running `writeCLAUDEmd` with identical sentinel content returns `{ written: false, reason: 'unchanged' }`.
    - `writeSettingsJson` deep-merges and deduplicates arrays, with existing items preserved and new items appended.
    - Multiple sentinel blocks in CLAUDE.md throws an error containing "multiple sentinel".
    - Sentinel constants use `<!-- BEGIN VIFLO -->` and `<!-- END VIFLO -->` (not the stale `viflo:start`/`viflo:end` format).
    - No `~` literal anywhere in the file.
  </done>
</task>

</tasks>

<verification>
Run both inline verification commands from the repo root:

```bash
node -e "const { resolveViFloRoot, resolveTargetPath } = require('./bin/lib/paths.cjs'); console.log(resolveViFloRoot());"
# Expected: /home/ollie/Development/Tools/viflo

node -e "const { writeCLAUDEmd, writeSettingsJson } = require('./bin/lib/writers.cjs'); console.log('writers loaded OK');"
```

Confirm no `~` literal or `process.cwd()` call appears in either file:
```bash
grep -rn "~\|process\.cwd\|viflo:start\|viflo:end" bin/lib/paths.cjs bin/lib/writers.cjs
# Expected: no output
```
</verification>

<success_criteria>
- `bin/lib/paths.cjs` and `bin/lib/writers.cjs` exist and are valid CommonJS modules.
- Both files use only Node.js built-ins — no `require('some-npm-package')` calls.
- `resolveViFloRoot()` returns an absolute path to the viflo repo root.
- `resolveTargetPath()` without `cwd` throws immediately.
- `writeCLAUDEmd` and `writeSettingsJson` each return `{ written: boolean, reason: string }`.
- Idempotency: second run with same inputs returns `{ written: false, reason: 'unchanged' }`.
- Sentinel format is `<!-- BEGIN VIFLO -->` / `<!-- END VIFLO -->`.
- JSON output includes trailing newline.
- INIT-05 is satisfied at the library level: sentinel merge, Set-dedup, and compute-then-compare prevent content destruction on re-run.
</success_criteria>

<output>
After completion, create `.planning/phases/16-cli-foundation/16-01-SUMMARY.md` following the summary template.
</output>
