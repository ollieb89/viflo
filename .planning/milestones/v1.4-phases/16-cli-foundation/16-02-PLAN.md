---
phase: 16-cli-foundation
plan: "02"
type: execute
wave: 2
depends_on:
  - "16-01"
files_modified:
  - bin/vitest.config.cjs
  - bin/lib/__tests__/paths.test.js
  - bin/lib/__tests__/writers.test.js
  - package.json
autonomous: true
requirements:
  - INIT-05

must_haves:
  truths:
    - "pnpm run test:cli exits 0 — all unit tests pass"
    - "Tests for paths.cjs cover: resolveViFloRoot returns absolute path containing viflo, resolveTargetPath assembles segments correctly, resolveTargetPath throws when cwd is missing"
    - "Tests for writers.cjs cover: writeCLAUDEmd creates/appends/replaces/throws-on-multiple; writeSettingsJson creates/deduplicates/deep-merges/preserves-unknown-keys; both functions return correct status objects and emit skip log on unchanged"
    - "Tests run from a temp directory; __dirname-based resolution is not confused by the test runner's cwd"
    - "No test references the stale sentinel format viflo:start or viflo:end"
  artifacts:
    - path: "bin/vitest.config.cjs"
      provides: "Vitest config scoped to bin/lib/__tests__ only"
      contains: "bin/lib/__tests__"
    - path: "bin/lib/__tests__/paths.test.js"
      provides: "Unit tests for paths.cjs"
      min_lines: 30
    - path: "bin/lib/__tests__/writers.test.js"
      provides: "Unit tests for writers.cjs"
      min_lines: 80
    - path: "package.json"
      provides: "test:cli script wired to vitest run via bin/vitest.config.cjs"
      contains: "test:cli"
  key_links:
    - from: "bin/lib/__tests__/paths.test.js"
      to: "bin/lib/paths.cjs"
      via: "require('../paths.cjs')"
      pattern: "require\\(\\.\\./paths\\.cjs"
    - from: "bin/lib/__tests__/writers.test.js"
      to: "bin/lib/writers.cjs"
      via: "require('../writers.cjs') after vi.mock setup"
      pattern: "require\\(\\.\\./writers\\.cjs"
    - from: "package.json test:cli"
      to: "bin/vitest.config.cjs"
      via: "--config bin/vitest.config.cjs"
      pattern: "vitest.config.cjs"
---

<objective>
Create the Vitest test scaffold and full unit test suites for `paths.cjs` and `writers.cjs`, then wire a `test:cli` script into the root `package.json`.

Purpose: Automated regression gate. Phase 16's success criteria require that tests pass in CI — this plan delivers the tests and the command to run them.

Output:

- `bin/vitest.config.cjs` — Vitest config scoped to `bin/lib/__tests__/`
- `bin/lib/__tests__/paths.test.js` — unit tests for paths module
- `bin/lib/__tests__/writers.test.js` — unit tests for writers module
- `package.json` — `"test:cli"` script added alongside existing `"test"` script
  </objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cli-foundation/16-CONTEXT.md
@.planning/phases/16-cli-foundation/16-RESEARCH.md
@.planning/phases/16-cli-foundation/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vitest config and paths unit tests</name>
  <files>bin/vitest.config.cjs, bin/lib/__tests__/paths.test.js</files>
  <action>
**Step A: Create `bin/vitest.config.cjs`**

Vitest 1.x supports CJS config files. Write:

```javascript
"use strict";
const { defineConfig } = require("vitest/config");

module.exports = defineConfig({
  test: {
    include: ["bin/lib/__tests__/**/*.test.{js,cjs}"],
    environment: "node",
  },
});
```

This scopes the test run to `bin/lib/__tests__/` only — it does NOT touch the web app's tests in `apps/web/`.

**Step B: Create `bin/lib/__tests__/paths.test.js`**

Vitest CJS test file. Use `require` for imports (not `import`). Use `vi.mock` before requiring the module under test. Use `vi.resetModules()` in `beforeEach` to avoid require-cache issues across tests.

Cover these cases:

**`resolveViFloRoot()`**

- Returns a string (typeof === 'string').
- The returned path is absolute (starts with `/`).
- The returned path ends with `/viflo` (or `path.sep + 'viflo'`).
- Does NOT equal `process.cwd()` when tests run from a different directory (assert `result` does NOT depend on cwd by checking it contains `bin` as a parent).
- IMPORTANT: Do NOT mock `__dirname` — it's not a function. Assert on the shape of the path, not an exact match against a temp path.

**`resolveTargetPath(cwd, ...segments)`**

- `resolveTargetPath('/tmp/my-project', '.claude', 'settings.json')` returns `/tmp/my-project/.claude/settings.json`.
- `resolveTargetPath('/tmp/my-project')` returns `/tmp/my-project`.
- `resolveTargetPath()` throws with message matching `/cwd is required/`.
- `resolveTargetPath(null, 'foo')` throws with message matching `/cwd is required/`.
- `resolveTargetPath(42, 'foo')` throws with message matching `/cwd is required/`.

CJS test file structure:

```javascript
'use strict';
const { describe, it, expect, vi, beforeEach } = require('vitest');
const path = require('path');

// Mock os so any accidental os.homedir() call is detectable
vi.mock('os', () => ({ homedir: vi.fn(() => '/mock/home') }));

beforeEach(() => {
  vi.resetModules();
});

describe('resolveViFloRoot', () => {
  it('returns a string', () => { ... });
  it('returns an absolute path', () => { ... });
  it('ends with /viflo', () => { ... });
});

describe('resolveTargetPath', () => {
  it('assembles cwd + segments into absolute path', () => { ... });
  it('throws when cwd is undefined', () => { ... });
  it('throws when cwd is null', () => { ... });
  it('throws when cwd is a number', () => { ... });
});
```

Note: The `require('../paths.cjs')` call must happen INSIDE each `it()` or in a `beforeEach` that fires after `vi.resetModules()` — not at the top level of the file — to ensure mocks are applied before module load.
</action>
<verify>
<automated>pnpm exec vitest run --config bin/vitest.config.cjs bin/lib/**tests**/paths.test.js</automated>
<manual>All paths.test.js test cases pass. No test references viflo:start or viflo:end.</manual>
</verify>
<done> - `bin/vitest.config.cjs` exists with `include: ['bin/lib/__tests__/**/*.test.{js,cjs}']`. - `bin/lib/__tests__/paths.test.js` exists with at least 7 test cases covering resolveViFloRoot and resolveTargetPath. - `pnpm exec vitest run --config bin/vitest.config.cjs bin/lib/__tests__/paths.test.js` exits 0.
</done>
</task>

<task type="auto">
  <name>Task 2: Create writers unit tests and wire test:cli script</name>
  <files>bin/lib/__tests__/writers.test.js, package.json</files>
  <action>
**Step A: Create `bin/lib/__tests__/writers.test.js`**

Full unit test suite for `writers.cjs`. Use `fs`, `os`, `path` from Node built-ins. Use a real temp directory (via `fs.mkdtempSync`) for file I/O tests — do NOT mock the filesystem for writers tests (real file operations are the point). Mock `os` in case `paths.cjs` or `writers.cjs` ever calls `os.homedir()` accidentally.

Test groups and cases:

**`writeCLAUDEmd`**

1. Creates CLAUDE.md with sentinel block when file does not exist → returns `{ written: true, reason: 'created' }`. File content contains `<!-- BEGIN VIFLO -->` and `<!-- END VIFLO -->`.
2. Returns `{ written: false, reason: 'unchanged' }` on second call with same sentinelContent. Console.log spy emits `[viflo] skipped (unchanged)`.
3. Appends sentinel block at end of existing CLAUDE.md that has no markers (existing content is preserved before the block).
4. Replaces existing sentinel block when CLAUDE.md already has one — content outside the block is unchanged.
5. Throws containing "multiple sentinel" when CLAUDE.md has two sentinel blocks.
6. Sentinel constants are `<!-- BEGIN VIFLO -->` and `<!-- END VIFLO -->` — verify the actual file content, not a hardcoded string.

**`writeSettingsJson`** 7. Creates `.claude/settings.json` (including directory) when it does not exist → returns `{ written: true, reason: 'created' }`. 8. Returns `{ written: false, reason: 'unchanged' }` on second call with same settings. 9. Deep-merges: existing key `foo: 1` is preserved when incoming has only `bar: 2`. 10. Array dedup: existing `allow: ['Bash(git*)']` + incoming `allow: ['Bash(git*)', 'Bash(npm*)']` → result has exactly one `'Bash(git*)'` and one `'Bash(npm*)'`. Existing item comes first. 11. Scalar conflict: incoming scalar wins (e.g. existing `version: 1`, incoming `version: 2` → result `version: 2`). 12. Deep nested merge: existing `{ permissions: { allow: ['A'] } }` merged with `{ permissions: { deny: ['B'] } }` → result has both `allow` and `deny` under `permissions`. 13. Output JSON has trailing newline (read raw file and check `content.endsWith('\n')`).

Use `beforeEach` to create a fresh `tmpDir = fs.mkdtempSync(...)` and `afterEach` to `fs.rmSync(tmpDir, { recursive: true })`.

Use `vi.spyOn(console, 'log')` in the idempotency tests to confirm the skip message fires.

CJS file structure:

```javascript
'use strict';
const { describe, it, expect, vi, beforeEach, afterEach } = require('vitest');
const fs = require('fs');
const os = require('os');
const path = require('path');

vi.mock('os', () => ({ homedir: vi.fn(() => '/mock/home') }));

let tmpDir;
beforeEach(() => {
  vi.resetModules();
  tmpDir = fs.mkdtempSync(path.join('/tmp', 'viflo-writers-test-'));
});
afterEach(() => {
  fs.rmSync(tmpDir, { recursive: true, force: true });
  vi.restoreAllMocks();
});

describe('writeCLAUDEmd', () => { ... });
describe('writeSettingsJson', () => { ... });
```

Note: Use `require('../writers.cjs')` inside each `it()` or in a `beforeEach` that fires after `vi.resetModules()`.

**Step B: Add `test:cli` to root `package.json`**

Read the current `package.json`. Add `"test:cli": "pnpm exec vitest run --config bin/vitest.config.cjs"` to the `"scripts"` object, alongside the existing `"test"` script. Preserve all other fields exactly. Write the updated JSON back with `JSON.stringify(pkg, null, 2) + '\n'`.

The final scripts section should look like:

```json
"scripts": {
  "lint": "...",
  "lint:fix": "...",
  "type-check": "...",
  "test": "pnpm --filter @viflo/web test",
  "test:cli": "pnpm exec vitest run --config bin/vitest.config.cjs",
  "build": "..."
}
```

  </action>
  <verify>
    <automated>pnpm run test:cli</automated>
    <manual>All 13+ test cases in writers.test.js pass. The test:cli script appears in package.json scripts.</manual>
  </verify>
  <done>
    - `bin/lib/__tests__/writers.test.js` exists with at least 13 test cases covering all writeCLAUDEmd and writeSettingsJson behaviors.
    - `package.json` has `"test:cli"` script pointing to `bin/vitest.config.cjs`.
    - `pnpm run test:cli` exits 0 — all paths and writers tests pass.
    - No test file references `viflo:start` or `viflo:end` (stale format).
  </done>
</task>

</tasks>

<verification>
Run the full test suite:

```bash
pnpm run test:cli
```

Expected: all tests pass (7+ paths tests, 13+ writers tests), exit 0.

Confirm no stale sentinel format in tests:

```bash
grep -rn "viflo:start\|viflo:end" bin/lib/__tests__/
# Expected: no output
```

Confirm existing web tests still pass (non-regression):

```bash
pnpm test
```

</verification>

<success_criteria>

- `pnpm run test:cli` exits 0 with all tests passing.
- Tests cover all locked decision behaviors: sentinel append/replace/throw, idempotency return value and console log, settings.json deep-merge, Set-dedup (existing items first), scalar conflict resolution, trailing newline.
- `bin/vitest.config.cjs` scoped to `bin/lib/__tests__/` — web tests not affected.
- `package.json` `test:cli` script uses the config file.
- INIT-05 verified by tests: re-running writer functions with identical input returns `{ written: false, reason: 'unchanged' }`.
  </success_criteria>

<output>
After completion, create `.planning/phases/16-cli-foundation/16-02-SUMMARY.md` following the summary template.
</output>
