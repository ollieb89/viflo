---
phase: 19-polish
plan: "02"
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - bin/lib/__tests__/viflo.test.js
  - package.json
autonomous: true
requirements: [INIT-06, INIT-07, INIT-08]

must_haves:
  truths:
    - "`viflo init --dry-run` integration tests verify no files are written and expected output lines appear"
    - "Integration tests verify all four canonical output labels (`created`, `updated`, `skipped`, `merged`) appear in real-run stdout with absolute paths"
    - "`package.json` has a `bin` field mapping `viflo` to `bin/viflo.cjs`"
    - "All 55+ tests pass (45 prior + new tests for Polish requirements)"
  artifacts:
    - path: "bin/lib/__tests__/viflo.test.js"
      provides: "Integration tests for --dry-run, labelled output, and absolute path assertions"
      min_lines: 230
    - path: "package.json"
      provides: 'bin field: { "viflo": "bin/viflo.cjs" }'
      contains: '"bin"'
  key_links:
    - from: "bin/lib/__tests__/viflo.test.js"
      to: "bin/viflo.cjs"
      via: "spawnSync child process invocation"
      pattern: "spawnSync.*viflo\\.cjs.*--dry-run"
    - from: "package.json"
      to: "bin/viflo.cjs"
      via: "bin field"
      pattern: "\"viflo\".*\"bin/viflo\\.cjs\""
---

<objective>
Add integration tests for Phase 19 Polish features (dry-run, labelled output with absolute paths) and wire `package.json` bin field.

Purpose: Verify all INIT-06/07/08 requirements with runnable tests and make the CLI installable via npm/npx.
Output: New describe block in viflo.test.js with ~10 tests; package.json updated with bin field.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/lib/__tests__/viflo.test.js
@.planning/phases/19-polish/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Polish integration tests to viflo.test.js</name>
  <files>bin/lib/__tests__/viflo.test.js</files>
  <action>
Add a new `describe('viflo init polish — dry-run and labelled output', () => { ... })` block at the end of bin/lib/__tests__/viflo.test.js.

The file-scope `beforeEach`/`afterEach` hooks (tmpDir creation/cleanup) already apply — do not re-declare them.

Write the following test cases (approximately 10 tests):

**Dry-run tests (INIT-06):**

1. `--dry-run --minimal — exits 0 and creates no files`
   - Run `node viflo.cjs init --minimal --dry-run tmpDir`
   - Assert: `result.status === 0`
   - Assert: `fs.existsSync(path.join(tmpDir, 'CLAUDE.md'))` is false
   - Assert: `fs.existsSync(path.join(tmpDir, '.claude', 'settings.json'))` is false

2. `--dry-run --minimal — stdout contains [dry-run] lines with absolute paths`
   - Run `node viflo.cjs init --minimal --dry-run tmpDir`
   - Assert: `result.stdout` contains `[dry-run]`
   - Assert: `result.stdout` contains `tmpDir` (absolute path fragment appears in output)

3. `--dry-run --full — exits 0 and creates no files`
   - Run `node viflo.cjs init --full --dry-run tmpDir`
   - Assert: `result.status === 0`
   - Assert: `fs.existsSync(path.join(tmpDir, '.planning'))` is false
   - Assert: `fs.existsSync(path.join(tmpDir, 'CLAUDE.md'))` is false

4. `--dry-run --full — stdout includes planning scaffold file paths`
   - Run `node viflo.cjs init --full --dry-run tmpDir`
   - Assert: `result.stdout` contains `PROJECT.md`
   - Assert: `result.stdout` contains `STATE.md`
   - Assert: `result.stdout` contains `ROADMAP.md`
   - Assert: `result.stdout` contains `config.json`

5. `--dry-run flag order flexibility — --dry-run before mode flag also works`
   - Run `node viflo.cjs init --dry-run --minimal tmpDir`
   - Assert: `result.status === 0`
   - Assert: `fs.existsSync(path.join(tmpDir, 'CLAUDE.md'))` is false

**Labelled output tests (INIT-07):**

6. `--minimal real run — stdout shows "created" with absolute path for CLAUDE.md`
   - Run `node viflo.cjs init --minimal tmpDir`
   - Assert: `result.stdout` matches `/created\s+.*CLAUDE\.md/`
   - Assert: stdout contains `tmpDir` (absolute path)

7. `--minimal real run — stdout shows "created" with absolute path for settings.json`
   - Run `node viflo.cjs init --minimal tmpDir`
   - Assert: `result.stdout` matches `/created\s+.*settings\.json/`

8. `--minimal second run — stdout shows "skipped" labels`
   - Run init twice
   - Second run: Assert: `result.stdout` matches `/skipped\s+/`

9. `--full real run — stdout shows "created" for all scaffold files with absolute paths`
   - Run `node viflo.cjs init --full tmpDir`
   - Assert: `result.stdout` matches `/created\s+.*PROJECT\.md/`
   - Assert: `result.stdout` contains `tmpDir` (absolute path in output)

10. `--minimal with existing CLAUDE.md — stdout shows "merged" label`
    - Pre-create CLAUDE.md with content `'# Existing\n'`
    - Run `node viflo.cjs init --minimal tmpDir`
    - Assert: `result.stdout` matches `/merged\s+.*CLAUDE\.md/`

Use the `spawnSync(process.execPath, [cliPath, ...], { encoding: 'utf-8' })` pattern established in the file. Tests reference `cliPath` and `tmpDir` which are already file-scoped.
</action>
<verify>
<automated>pnpm --filter=root test:cli 2>&1 | tail -10</automated>
<manual>Confirm new test count: should be 55+ total (45 prior + ~10 new). All tests pass.</manual>
</verify>
<done>
New describe block with ~10 tests covers INIT-06 (dry-run: no files written, correct output) and INIT-07 (labelled output with absolute paths). All tests pass.
</done>
</task>

<task type="auto">
  <name>Task 2: Wire package.json bin field (INIT-08)</name>
  <files>package.json</files>
  <action>
Add a `"bin"` field to the root `package.json` at `/home/ollie/Development/Tools/viflo/package.json`.

The current package.json has no `"bin"` field. Add it after the `"scripts"` field:

```json
"bin": {
  "viflo": "bin/viflo.cjs"
},
```

This makes the CLI invocable as `npx viflo` after npm install or as `pnpm exec viflo` from within the repo.

No other fields in package.json should be changed.

After adding the bin field, verify that `bin/viflo.cjs` is executable by Node (it is a CJS module, no shebang required for `node bin/viflo.cjs` invocation — npm bin wiring uses `node` implicitly for `.cjs` files when invoked via `npx`). Note: per STATE.md decision [17-02]: "No shebang added to bin/viflo.cjs — Phase 19 handles bin wiring as planned." The bin field itself is the wiring; no shebang is required for the npm bin mechanism to work with `.cjs` extension files (npm auto-prepends the node interpreter).
</action>
<verify>
<automated>node -e "const p = require('./package.json'); console.assert(p.bin && p.bin.viflo === 'bin/viflo.cjs', 'bin field missing'); console.log('OK: bin field present')"</automated>
<manual>Run `node -e "require('./package.json')" | node -p "require('./package.json').bin"` — should output `{ viflo: 'bin/viflo.cjs' }`</manual>
</verify>
<done>
`package.json` has `"bin": { "viflo": "bin/viflo.cjs" }`. INIT-08 complete.
</done>
</task>

</tasks>

<verification>
Run full CLI test suite: `pnpm --filter=root test:cli`
All tests pass (55+ total including new Polish tests).

Verify bin field:

```bash
node -e "const p = require('./package.json'); console.log(JSON.stringify(p.bin))"
# Expect: {"viflo":"bin/viflo.cjs"}
```

</verification>

<success_criteria>

- ~10 new integration tests covering INIT-06 (dry-run) and INIT-07 (labelled output + absolute paths) — all pass
- `package.json` has `"bin": { "viflo": "bin/viflo.cjs" }` — INIT-08 satisfied
- Full test suite (55+ tests) passes without regression
  </success_criteria>

<output>
After completion, create `.planning/phases/19-polish/19-02-SUMMARY.md`
</output>
