---
phase: 18-full-mode
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/writers.cjs
  - bin/viflo.cjs
autonomous: true
requirements:
  - INIT-03
  - INIT-04

must_haves:
  truths:
    - "Running viflo init --full creates .planning/ with PROJECT.md, STATE.md, ROADMAP.md, and config.json"
    - "Running viflo init --full on a project that already has .planning/ files skips each existing file without overwriting"
    - "Running viflo init --full on a project with no CLAUDE.md creates a richer starter template with project sections + sentinel block"
    - "Running viflo init --full where CLAUDE.md already exists only updates the sentinel block â€” content outside is unchanged"
    - "Every file action emits a labelled line: created, updated, or skipped (already exists)"
    - "A summary line like 'Done. 3 files created, 2 skipped.' appears after the file list"
    - "A first-run nudge appears only when all files were created (no skips)"
  artifacts:
    - path: "bin/lib/writers.cjs"
      provides: "writePlanningScaffold() and writeCLAUDEmdTemplate() exported functions"
      exports: ["writeCLAUDEmd", "writeSettingsJson", "writePlanningScaffold", "writeCLAUDEmdTemplate"]
    - path: "bin/viflo.cjs"
      provides: "CLI entry point handling --full flag"
      contains: "hasFullFlag"
  key_links:
    - from: "bin/viflo.cjs"
      to: "bin/lib/writers.cjs"
      via: "require('./lib/writers.cjs')"
      pattern: "writePlanningScaffold|writeCLAUDEmdTemplate"
    - from: "bin/viflo.cjs"
      to: ".planning/"
      via: "writePlanningScaffold(targetDir)"
      pattern: "writePlanningScaffold"
---

<objective>
Implement the --full flag for viflo init by adding two library functions to writers.cjs and updating the CLI entry point to orchestrate full-mode execution.

Purpose: Allow a developer starting a new project to run `viflo init --full` and immediately have viflo skill imports, Claude Code permissions, and a GSD planning scaffold ready to use in one command.

Output: Extended bin/lib/writers.cjs with writePlanningScaffold() and writeCLAUDEmdTemplate(); updated bin/viflo.cjs that handles --full as a superset of --minimal.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-full-mode/18-CONTEXT.md
@.planning/phases/17-minimal-mode/17-02-SUMMARY.md
@bin/lib/writers.cjs
@bin/viflo.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add writePlanningScaffold() and writeCLAUDEmdTemplate() to writers.cjs</name>
  <files>bin/lib/writers.cjs</files>
  <action>
Add two new exported functions to bin/lib/writers.cjs, appended after the existing writeSettingsJson function. Do NOT modify existing functions â€” only add new ones.

**Function 1: writePlanningScaffold(targetCwd)**

Writes four stub files into `{targetCwd}/.planning/`. Each file is written only if it does not already exist (skip if present). Returns an array of result objects: `{ path, written, reason }` where `reason` is 'created' or 'skipped (already exists)'.

Use `writeIfChanged` for files that don't exist yet. For existing files, skip them without calling `writeIfChanged` at all (check `fs.existsSync` first â€” if exists, push `{ path, written: false, reason: 'skipped (already exists)' }` and continue).

The four stub file contents:

a) `.planning/PROJECT.md`:
```
# Project

## Goals

## Stack

## Architecture

## Conventions
```
(Minimal section headers only â€” no placeholder text or instructions, per user decision.)

b) `.planning/ROADMAP.md`:
```
# Roadmap

## Milestones

### ðŸ“‹ v1.0 MVP

## Phases

<!-- Example phase entry â€” fill in your own below:
### Phase 1: Feature Name
**Goal**: What this phase achieves
**Depends on**: Phase 0
**Requirements**: REQ-01, REQ-02
**Plans**: TBD
-->

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
```
(Minimal milestone scaffold with a commented example phase entry showing GSD format, per user decision.)

c) `.planning/config.json`:
```json
{
  "mode": "interactive",
  "depth": "standard",
  "profile": "balanced",
  "workflow": {
    "research": false,
    "plan_check": true,
    "verifier": true,
    "auto_advance": false
  },
  "parallelization": {
    "enabled": true
  },
  "git": {
    "commit_docs": true,
    "branching_strategy": "none"
  }
}
```
(GSD defaults pre-populated, works out of the box, per user decision. This matches the real config.json schema from the viflo repo itself.)

d) `.planning/STATE.md`:
```
# Project State

## Project Reference

See: .planning/PROJECT.md

## Current Position

Phase: â€”
Plan: â€”
Status: Not started

## Accumulated Context

### Key Decisions (summary)

### Pending Todos

### Blockers/Concerns

None.

## Session Continuity

Last session: â€”
Stopped at: â€”
Resume with: /gsd:new-project to plan your first phase
```
(Minimal valid STATE.md that GSD tools can parse â€” not empty but structurally complete, per user decision.)

Create parent directory with `fs.mkdirSync(planningDir, { recursive: true })` before writing any file. Use `path.join(targetCwd, '.planning')` for the planning dir.

**Function 2: writeCLAUDEmdTemplate(targetCwd, sentinelContent)**

Writes a richer CLAUDE.md starter template when the file does not exist. If CLAUDE.md already exists, falls back to the same `writeCLAUDEmd(targetCwd, sentinelContent)` behaviour (only updates sentinel block).

Check `fs.existsSync(resolveTargetPath(targetCwd, 'CLAUDE.md'))`. If it does not exist, write the full template:

```
# Project

A brief description of this project.

## Tech Stack

- Language:
- Framework:
- Database:

## Development Workflow

This project uses [GSD methodology](https://github.com/olivermonberg/viflo) with `/gsd:` commands.

Key commands:
- `/gsd:new-project` â€” plan and start a new project milestone
- `/gsd:plan-phase N` â€” plan a specific phase
- `/gsd:execute-phase N` â€” execute a planned phase

<!-- BEGIN VIFLO -->
{sentinelContent}
<!-- END VIFLO -->
```

If CLAUDE.md already exists, call `writeCLAUDEmd(targetCwd, sentinelContent)` and return its result directly.

Return `{ written, reason }` in both cases (same shape as writeCLAUDEmd return value).

Update the module.exports line at the bottom to export all four functions:
`module.exports = { writeCLAUDEmd, writeSettingsJson, writePlanningScaffold, writeCLAUDEmdTemplate };`
  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && node -e "const w = require('./bin/lib/writers.cjs'); console.log(typeof w.writePlanningScaffold, typeof w.writeCLAUDEmdTemplate);"</automated>
    <manual>Output should be: function function</manual>
  </verify>
  <done>
    - `writePlanningScaffold` and `writeCLAUDEmdTemplate` exported from bin/lib/writers.cjs
    - `node -e "require('./bin/lib/writers.cjs')"` exits 0 with no errors
    - Existing exports (writeCLAUDEmd, writeSettingsJson) still present and unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Update bin/viflo.cjs to handle --full flag</name>
  <files>bin/viflo.cjs</files>
  <action>
Update bin/viflo.cjs to support `--full` mode. The `--full` flag is a superset of `--minimal`: it runs all minimal logic plus planning scaffold creation.

**Changes to make:**

1. Add imports for the two new writer functions. Update the require line for writers:
   ```js
   const { writeCLAUDEmd, writeSettingsJson, writePlanningScaffold, writeCLAUDEmdTemplate } = require('./lib/writers.cjs');
   ```

2. Add flag detection after `hasMinimalFlag`:
   ```js
   const hasFullFlag = args.includes('--full');
   ```

3. Update validation: accept either `--minimal` or `--full`. The current check rejects anything without `--minimal`. Change to:
   ```js
   if (!hasMinimalFlag && !hasFullFlag) {
     process.stderr.write('Usage: viflo init --minimal [path]\n       viflo init --full [path]\n');
     process.exit(1);
   }
   ```

4. Replace the core logic section with mode-aware logic. Keep the existing `--minimal` behaviour intact. Add `--full` branch:

   For `--minimal` (unchanged behaviour):
   ```js
   if (hasMinimalFlag && !hasFullFlag) {
     const claudeResult = writeCLAUDEmd(targetDir, sentinelContent);
     const settingsResult = writeSettingsJson(targetDir, defaultSettings);
     const claudeStatus = claudeResult.written ? claudeResult.reason : 'skipped';
     const settingsStatus = settingsResult.written ? settingsResult.reason : 'skipped';
     console.log('[viflo] CLAUDE.md: ' + claudeStatus);
     console.log('[viflo] .claude/settings.json: ' + settingsStatus);
     process.exit(0);
   }
   ```

   For `--full`:
   ```js
   if (hasFullFlag) {
     // Step 1: CLAUDE.md â€” richer template or sentinel-only merge
     const claudeResult = writeCLAUDEmdTemplate(targetDir, sentinelContent);
     // Step 2: settings.json â€” same as --minimal
     const settingsResult = writeSettingsJson(targetDir, defaultSettings);
     // Step 3: .planning/ scaffold â€” four stub files
     const scaffoldResults = writePlanningScaffold(targetDir);

     // Build full results list for output
     const allResults = [
       { label: 'CLAUDE.md', written: claudeResult.written, reason: claudeResult.reason },
       { label: '.claude/settings.json', written: settingsResult.written, reason: settingsResult.reason },
       ...scaffoldResults.map(r => ({
         label: r.path,
         written: r.written,
         reason: r.reason,
       })),
     ];

     let created = 0;
     let skipped = 0;
     for (const r of allResults) {
       if (r.written) {
         console.log('  created  ' + r.label);
         created++;
       } else {
         console.log('  skipped  ' + r.label + ' (' + (r.reason || 'already exists') + ')');
         skipped++;
       }
     }

     console.log('');
     console.log('Done. ' + created + ' file' + (created !== 1 ? 's' : '') + ' created, ' + skipped + ' skipped.');

     // First-run nudge: only when everything was created (no skips)
     if (skipped === 0) {
       console.log('');
       console.log('Next: edit .planning/PROJECT.md and run /gsd:new-project to plan your first milestone.');
     }

     process.exit(0);
   }
   ```

5. Keep the `defaultSettings` object and the `viFloRoot`/`importLines`/`sentinelContent` setup unchanged â€” they are shared by both modes.

The `writeIfChanged` internal log line in writers.cjs emits `[viflo] skipped (unchanged): path` to stdout. This output comes from inside writers.cjs and is separate from the CLI output layer. For `--full` mode, this internal log line may appear alongside the formatted output â€” that is acceptable for this phase (Phase 19 polish handles output cleanup if needed).
  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && node bin/viflo.cjs init --full /tmp/viflo-fulltest-$$ && ls /tmp/viflo-fulltest-$$/.planning/ && rm -rf /tmp/viflo-fulltest-$$</automated>
    <manual>Output should show "created" lines for CLAUDE.md, .claude/settings.json, and four .planning/ files, followed by "Done. 6 files created, 0 skipped." and the first-run nudge.</manual>
  </verify>
  <done>
    - `viflo init --full [path]` exits 0 on a fresh directory
    - `.planning/PROJECT.md`, `.planning/STATE.md`, `.planning/ROADMAP.md`, `.planning/config.json` all created
    - CLAUDE.md created with richer template (project sections + sentinel block)
    - Running `--full` a second time exits 0 and shows all files as skipped
    - `viflo init --minimal [path]` still works exactly as before (no regression)
    - `pnpm test:cli` passes all 35 existing tests
  </done>
</task>

</tasks>

<verification>
Run full CLI test suite to confirm no regressions:
`cd /home/ollie/Development/Tools/viflo && pnpm test:cli`

All 35 existing tests must pass. Manually verify full mode end-to-end:
1. `node bin/viflo.cjs init --full /tmp/verify-full` â€” check output format and files created
2. `node bin/viflo.cjs init --full /tmp/verify-full` â€” second run, all skipped
3. `node bin/viflo.cjs init --minimal /tmp/verify-minimal` â€” confirm minimal still works
</verification>

<success_criteria>
- `writePlanningScaffold` and `writeCLAUDEmdTemplate` exported from bin/lib/writers.cjs
- `viflo init --full [path]` creates all 6 files (CLAUDE.md, settings.json, 4 .planning/ stubs)
- CLAUDE.md created fresh by --full contains project sections + sentinel block
- CLAUDE.md already existing: only sentinel block updated, rest untouched
- Second run of --full: all files skipped, exits 0
- `viflo init --minimal` unchanged: all 35 existing tests pass
- Summary line and first-run nudge printed correctly
</success_criteria>

<output>
After completion, create `.planning/phases/18-full-mode/18-01-SUMMARY.md`
</output>
