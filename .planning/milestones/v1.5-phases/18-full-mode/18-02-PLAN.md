---
phase: 18-full-mode
plan: "02"
type: execute
wave: 2
depends_on:
  - "18-01"
files_modified:
  - bin/lib/__tests__/viflo.test.js
autonomous: true
requirements:
  - INIT-03
  - INIT-04

must_haves:
  truths:
    - "All --full behaviours are covered by automated integration tests"
    - "Tests confirm .planning/ scaffold files are created on first run"
    - "Tests confirm each .planning/ file is skipped individually if it already exists"
    - "Tests confirm CLAUDE.md created fresh by --full has project sections above the sentinel block"
    - "Tests confirm CLAUDE.md that already exists is not altered outside the sentinel block"
    - "Tests confirm --full output includes a summary line and first-run nudge on first run"
    - "Tests confirm --full output shows skipped files with (already exists) suffix on repeat run"
    - "All 35 prior tests still pass (no regressions)"
  artifacts:
    - path: "bin/lib/__tests__/viflo.test.js"
      provides: "Integration tests for viflo init --full"
      contains: "viflo init --full"
  key_links:
    - from: "bin/lib/__tests__/viflo.test.js"
      to: "bin/viflo.cjs"
      via: "spawnSync(process.execPath, [cliPath, 'init', '--full', tmpDir])"
      pattern: "--full"
---

<objective>
Add a comprehensive integration test suite for `viflo init --full` to bin/lib/__tests__/viflo.test.js, covering all INIT-03 and INIT-04 behaviours using the existing spawnSync test pattern.

Purpose: Automated verification that the full mode CLI works correctly — scaffold creation, per-file idempotency, CLAUDE.md template vs merge, and output format.

Output: Extended viflo.test.js with a `viflo init --full` describe block; full test suite passes.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-full-mode/18-CONTEXT.md
@.planning/phases/18-full-mode/18-01-SUMMARY.md
@bin/lib/__tests__/viflo.test.js
@bin/viflo.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --full integration tests to viflo.test.js</name>
  <files>bin/lib/__tests__/viflo.test.js</files>
  <action>
Append a new `describe('viflo init --full', ...)` block to bin/lib/__tests__/viflo.test.js after the existing `--minimal` describe block. Do NOT modify the existing tests.

Use the same test infrastructure already in the file: `spawnSync`, `tmpDir`, `beforeEach`/`afterEach`. The `beforeEach`/`afterEach` hooks are at file scope and apply to all describe blocks in the file — no need to redeclare them.

Add the following test cases:

**Test 1: fresh project — creates .planning/ with all four stub files**

```js
it("fresh project — creates .planning/ with all four stub files", () => {
  const result = spawnSync(
    process.execPath,
    [cliPath, "init", "--full", tmpDir],
    {
      encoding: "utf-8",
    },
  );
  expect(result.status).toBe(0);
  expect(fs.existsSync(path.join(tmpDir, ".planning", "PROJECT.md"))).toBe(
    true,
  );
  expect(fs.existsSync(path.join(tmpDir, ".planning", "STATE.md"))).toBe(true);
  expect(fs.existsSync(path.join(tmpDir, ".planning", "ROADMAP.md"))).toBe(
    true,
  );
  expect(fs.existsSync(path.join(tmpDir, ".planning", "config.json"))).toBe(
    true,
  );
});
```

**Test 2: fresh project — config.json is valid JSON with GSD defaults**

```js
it("fresh project — config.json is valid JSON with GSD defaults", () => {
  spawnSync(process.execPath, [cliPath, "init", "--full", tmpDir], {
    encoding: "utf-8",
  });
  const configPath = path.join(tmpDir, ".planning", "config.json");
  const parsed = JSON.parse(fs.readFileSync(configPath, "utf-8"));
  expect(parsed.profile).toBe("balanced");
  expect(typeof parsed.workflow).toBe("object");
  expect(parsed.workflow.plan_check).toBe(true);
});
```

**Test 3: fresh project — CLAUDE.md contains project sections above sentinel**

```js
it("fresh project — CLAUDE.md contains project sections and sentinel block", () => {
  spawnSync(process.execPath, [cliPath, "init", "--full", tmpDir], {
    encoding: "utf-8",
  });
  const content = fs.readFileSync(path.join(tmpDir, "CLAUDE.md"), "utf-8");
  expect(content).toContain("# Project");
  expect(content).toContain("## Tech Stack");
  expect(content).toContain("## Development Workflow");
  expect(content).toContain("<!-- BEGIN VIFLO -->");
  expect(content).toContain("<!-- END VIFLO -->");
  // Project sections must appear BEFORE the sentinel block
  const sentinelIdx = content.indexOf("<!-- BEGIN VIFLO -->");
  const projectIdx = content.indexOf("# Project");
  expect(projectIdx).toBeLessThan(sentinelIdx);
});
```

**Test 4: CLAUDE.md already exists — only sentinel block updated, rest preserved**

```js
it("CLAUDE.md already exists — only sentinel block updated, not replaced", () => {
  const existingContent = "# My Existing Project\n\nSome content I wrote.\n";
  fs.writeFileSync(path.join(tmpDir, "CLAUDE.md"), existingContent, "utf-8");

  spawnSync(process.execPath, [cliPath, "init", "--full", tmpDir], {
    encoding: "utf-8",
  });

  const content = fs.readFileSync(path.join(tmpDir, "CLAUDE.md"), "utf-8");
  expect(content).toContain("# My Existing Project");
  expect(content).toContain("Some content I wrote.");
  expect(content).toContain("<!-- BEGIN VIFLO -->");
  expect(content).toContain("<!-- END VIFLO -->");
  // Template sections must NOT appear (CLAUDE.md was not replaced)
  expect(content).not.toContain("## Tech Stack");
});
```

**Test 5: idempotency — second --full run skips all existing files**

```js
it("idempotency — second --full run exits 0 and skips all existing files", () => {
  spawnSync(process.execPath, [cliPath, "init", "--full", tmpDir], {
    encoding: "utf-8",
  });
  const projectMdFirst = fs.readFileSync(
    path.join(tmpDir, ".planning", "PROJECT.md"),
    "utf-8",
  );

  const secondResult = spawnSync(
    process.execPath,
    [cliPath, "init", "--full", tmpDir],
    {
      encoding: "utf-8",
    },
  );
  expect(secondResult.status).toBe(0);
  // No file content changed
  const projectMdSecond = fs.readFileSync(
    path.join(tmpDir, ".planning", "PROJECT.md"),
    "utf-8",
  );
  expect(projectMdSecond).toBe(projectMdFirst);
  // Output indicates skipped
  expect(secondResult.stdout).toContain("skipped");
});
```

**Test 6: per-file .planning/ idempotency — pre-existing file skipped, absent file created**

```js
it("per-file idempotency — pre-existing .planning/ file is skipped, missing file is created", () => {
  // Pre-create only STATE.md with custom content
  fs.mkdirSync(path.join(tmpDir, ".planning"), { recursive: true });
  const customState = "# My Custom State\n";
  fs.writeFileSync(
    path.join(tmpDir, ".planning", "STATE.md"),
    customState,
    "utf-8",
  );

  spawnSync(process.execPath, [cliPath, "init", "--full", tmpDir], {
    encoding: "utf-8",
  });

  // STATE.md must be unchanged
  const stateContent = fs.readFileSync(
    path.join(tmpDir, ".planning", "STATE.md"),
    "utf-8",
  );
  expect(stateContent).toBe(customState);
  // Other scaffold files must have been created
  expect(fs.existsSync(path.join(tmpDir, ".planning", "PROJECT.md"))).toBe(
    true,
  );
  expect(fs.existsSync(path.join(tmpDir, ".planning", "config.json"))).toBe(
    true,
  );
});
```

**Test 7: output — summary line appears on fresh run**

```js
it("output — summary line shows created count on first run", () => {
  const result = spawnSync(
    process.execPath,
    [cliPath, "init", "--full", tmpDir],
    {
      encoding: "utf-8",
    },
  );
  expect(result.status).toBe(0);
  expect(result.stdout).toMatch(/Done\. \d+ files? created, \d+ skipped\./);
});
```

**Test 8: output — first-run nudge appears when all files created**

```js
it("output — first-run nudge appears when all files are created", () => {
  const result = spawnSync(
    process.execPath,
    [cliPath, "init", "--full", tmpDir],
    {
      encoding: "utf-8",
    },
  );
  expect(result.status).toBe(0);
  expect(result.stdout).toContain("Next:");
});
```

**Test 9: output — first-run nudge absent on repeat run**

```js
it("output — first-run nudge absent on repeat run", () => {
  spawnSync(process.execPath, [cliPath, "init", "--full", tmpDir], {
    encoding: "utf-8",
  });
  const secondResult = spawnSync(
    process.execPath,
    [cliPath, "init", "--full", tmpDir],
    {
      encoding: "utf-8",
    },
  );
  expect(secondResult.status).toBe(0);
  expect(secondResult.stdout).not.toContain("Next:");
});
```

**Test 10: --minimal flag still works after --full changes (regression guard)**

```js
it("--minimal flag still exits 0 and creates CLAUDE.md + settings.json", () => {
  const result = spawnSync(
    process.execPath,
    [cliPath, "init", "--minimal", tmpDir],
    {
      encoding: "utf-8",
    },
  );
  expect(result.status).toBe(0);
  expect(fs.existsSync(path.join(tmpDir, "CLAUDE.md"))).toBe(true);
  expect(fs.existsSync(path.join(tmpDir, ".claude", "settings.json"))).toBe(
    true,
  );
  // .planning/ must NOT be created by --minimal
  expect(fs.existsSync(path.join(tmpDir, ".planning"))).toBe(false);
});
```

  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && pnpm test:cli</automated>
    <manual>All tests pass. Suite should show at least 45 tests total (35 existing + 10 new). Zero failures.</manual>
  </verify>
  <done>
    - 10 new tests added in a `describe('viflo init --full', ...)` block
    - All 10 new tests pass
    - All 35 prior tests still pass (zero regressions)
    - pnpm test:cli exits 0
  </done>
</task>

</tasks>

<verification>
`cd /home/ollie/Development/Tools/viflo && pnpm test:cli`

Expected: all tests pass (35 prior + 10 new = 45 total). Zero failures, zero skipped.
</verification>

<success_criteria>

- `pnpm test:cli` passes with 45+ tests and 0 failures
- `describe('viflo init --full', ...)` block present in viflo.test.js with 10 tests
- Every INIT-03 and INIT-04 requirement covered by at least one test
- --minimal regression guard test passes (no .planning/ created by --minimal)
  </success_criteria>

<output>
After completion, create `.planning/phases/18-full-mode/18-02-SUMMARY.md`
</output>
