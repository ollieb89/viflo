---
phase: 17-minimal-mode
plan: "02"
type: execute
wave: 2
depends_on:
  - "17-01"
files_modified:
  - bin/viflo.cjs
  - bin/lib/__tests__/viflo.test.js
autonomous: true
requirements:
  - INIT-01
  - INIT-02

must_haves:
  truths:
    - "Running `node bin/viflo.cjs init --minimal` in a temp project without CLAUDE.md creates CLAUDE.md with a sentinel block containing @-import lines for all viflo skills"
    - "Running `node bin/viflo.cjs init --minimal` creates .claude/settings.json with safe default permissions.allow entries"
    - "Running `node bin/viflo.cjs init --minimal` a second time on an already-configured project exits 0 and modifies no files"
    - "Running `node bin/viflo.cjs init --minimal /nonexistent/path` exits non-zero and prints 'Directory not found' to stderr"
    - "Running `node bin/viflo.cjs init --minimal /explicit/path` targets /explicit/path, not process.cwd()"
  artifacts:
    - path: "bin/viflo.cjs"
      provides: "CLI entry point — parses argv, orchestrates --minimal init"
      min_lines: 50
    - path: "bin/lib/__tests__/viflo.test.js"
      provides: "Integration tests for bin/viflo.cjs --minimal command"
      min_lines: 50
  key_links:
    - from: "bin/viflo.cjs"
      to: "bin/lib/skills.cjs"
      via: "require('./lib/skills.cjs')"
      pattern: "require\\('./lib/skills\\.cjs'\\)"
    - from: "bin/viflo.cjs"
      to: "bin/lib/writers.cjs"
      via: "writeCLAUDEmd + writeSettingsJson"
      pattern: "writeCLAUDEmd|writeSettingsJson"
    - from: "bin/viflo.cjs"
      to: "bin/lib/paths.cjs"
      via: "resolveViFloRoot() for skill scanning, resolveTargetPath() for target validation"
      pattern: "resolveViFloRoot|resolveTargetPath"
---

<objective>
Implement `bin/viflo.cjs` as the CLI entry point for `viflo init --minimal`. Wire the skills scanner and file writers together into a complete, idempotent `--minimal` command with argument parsing, path validation, and integration tests.

Purpose: This is the user-facing surface of Phase 17. The library layer (Phase 16) and skill scanner (Plan 01) are done — this plan wires them into a single runnable CLI command.
Output: `bin/viflo.cjs` (executable entry point), `bin/lib/__tests__/viflo.test.js` (integration tests).
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-minimal-mode/17-CONTEXT.md
@bin/lib/paths.cjs
@bin/lib/writers.cjs
@bin/lib/skills.cjs
@bin/lib/__tests__/writers.test.js
@bin/vitest.config.cjs
@.planning/phases/17-minimal-mode/17-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bin/viflo.cjs CLI entry point</name>
  <files>bin/viflo.cjs</files>
  <action>
    Create bin/viflo.cjs as the CLI entry point. Use 'use strict'; header.

    Argument parsing: use process.argv directly (no minimist — no external dependency needed).
    Parse: node bin/viflo.cjs init --minimal [optional-path]

    Argument layout:
    - argv[2] === 'init' — subcommand (required)
    - argv[3] === '--minimal' — mode flag (for Phase 17; check for this string)
    - argv[4] — optional positional target path (if present and not starting with '--', use it; otherwise default to process.cwd())

    Implementation steps:
    1. Extract subcommand and flags from process.argv.slice(2)
    2. If subcommand !== 'init': print usage to stderr, exit 1
    3. If --minimal flag not present: print "Usage: viflo init --minimal [path]" to stderr, exit 1
    4. Resolve target directory: use positional arg (argv[4]) if provided, else process.cwd()
    5. Validate target exists: use fs.existsSync(targetDir). If not: console.error('Directory not found: ' + targetDir), process.exit(1)
    6. Call resolveViFloRoot() to get viflo install root
    7. Call scanSkills(viFloRoot) to get the @-import lines array. Join with '\n' for sentinelContent.
    8. Define safe default permissions: { permissions: { allow: ["Bash", "Read", "Write", "Edit", "Glob", "Grep", "WebFetch", "mcp__*"] } }
       (Per user decision: Claude's discretion for exact entries — these are the standard Claude Code tool names)
    9. Call writeCLAUDEmd(targetDir, sentinelContent)
    10. Call writeSettingsJson(targetDir, defaultSettings)
    11. Print basic output (console.log) for each result — Phase 19 formalises this, but Phase 17 needs something:
        e.g. "[viflo] CLAUDE.md: created|updated|skipped" and "[viflo] .claude/settings.json: created|updated|skipped"
    12. process.exit(0) on success

    File must use CJS (no ESM). Do NOT add #!/usr/bin/env node shebang — Phase 19 handles bin wiring.

    Require at top: fs (for existsSync), and the three lib modules:
      const { resolveViFloRoot, resolveTargetPath } = require('./lib/paths.cjs');
      const { writeCLAUDEmd, writeSettingsJson } = require('./lib/writers.cjs');
      const { scanSkills } = require('./lib/skills.cjs');

  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && node bin/viflo.cjs init --minimal /tmp/viflo-smoke-$$ && cat /tmp/viflo-smoke-$$/CLAUDE.md | grep -c 'BEGIN VIFLO'</automated>
    <manual>Output should be "1" (one sentinel block). CLAUDE.md should contain @-import lines. Check .claude/settings.json exists in the temp dir.</manual>
  </verify>
  <done>node bin/viflo.cjs init --minimal /tmp/some-dir creates CLAUDE.md with sentinel block and .claude/settings.json; invalid path exits non-zero with "Directory not found"</done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for bin/viflo.cjs --minimal</name>
  <files>bin/lib/__tests__/viflo.test.js</files>
  <action>
    Create bin/lib/__tests__/viflo.test.js to integration-test the --minimal command end-to-end.

    Use the same test patterns as writers.test.js:
    - 'use strict'; header
    - vitest globals (no imports)
    - beforeEach: vi.resetModules() + tmpDir = fs.mkdtempSync('/tmp/viflo-cli-test-')
    - afterEach: fs.rmSync(tmpDir, { recursive: true }) + vi.restoreAllMocks()

    Test by spawning the CLI via Node's child_process.spawnSync:
      const result = spawnSync(process.execPath, [cliPath, 'init', '--minimal', tmpDir], { encoding: 'utf-8' })
    where cliPath = path.resolve(__dirname, '../../viflo.cjs')

    Test cases (min 6):

    1. Fresh project — creates CLAUDE.md:
       spawnSync with tmpDir, check result.status === 0,
       CLAUDE.md exists at path.join(tmpDir, 'CLAUDE.md'),
       file contains '<!-- BEGIN VIFLO -->' and '<!-- END VIFLO -->'

    2. CLAUDE.md contains @-import lines from viflo skills:
       Read CLAUDE.md after run, check it contains at least one line matching /^@.*SKILL\.md$/m

    3. Fresh project — creates .claude/settings.json:
       check file exists at path.join(tmpDir, '.claude', 'settings.json'),
       parse JSON and check permissions.allow is an array with at least one entry

    4. Idempotency — second run on same dir exits 0 and produces no file changes:
       run twice, compare CLAUDE.md content (must be identical between runs),
       check stdout of second run contains 'skipped' for both files

    5. Invalid path exits non-zero with clear message:
       spawnSync with '/nonexistent/viflo-test-path-does-not-exist',
       check result.status !== 0,
       check result.stderr contains 'Directory not found'

    6. Optional positional path argument — uses given path not cwd:
       spawnSync passing tmpDir as explicit path arg,
       verify CLAUDE.md created in tmpDir (not process.cwd())

    Note: spawnSync inherits the real viflo install location for resolveViFloRoot(), so real skill dirs
    are scanned. Test cases that check @-import lines should use /^@.*SKILL\.md$/m regex, not hardcoded paths.

  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && pnpm run test:cli</automated>
    <manual>All 6+ viflo.test.js tests pass. Full test suite (paths + writers + skills + viflo) shows zero failures.</manual>
  </verify>
  <done>pnpm run test:cli exits 0 with all integration tests passing, including idempotency and invalid-path tests</done>
</task>

</tasks>

<verification>
Full CLI test suite: pnpm run test:cli — all tests pass (zero failures across paths, writers, skills, viflo suites).

Manual smoke test:
mkdir /tmp/viflo-smoke-test && node bin/viflo.cjs init --minimal /tmp/viflo-smoke-test
cat /tmp/viflo-smoke-test/CLAUDE.md # must have sentinel block with @-lines
cat /tmp/viflo-smoke-test/.claude/settings.json # must have permissions.allow array
node bin/viflo.cjs init --minimal /tmp/viflo-smoke-test # second run: all skipped
rm -rf /tmp/viflo-smoke-test

Invalid path test:
node bin/viflo.cjs init --minimal /nonexistent/path
echo "Exit: $?" # must be non-zero
</verification>

<success_criteria>

- pnpm run test:cli passes with zero failures across all test suites
- CLAUDE.md created with sentinel block + real @-import lines on first run
- .claude/settings.json created with permissions.allow array on first run
- Second run on same target: both files skipped (no modifications)
- Non-existent target: exits non-zero with "Directory not found" in stderr
- Optional positional path arg targets the given directory, not process.cwd()
  </success_criteria>

<output>
After completion, create `.planning/phases/17-minimal-mode/17-02-SUMMARY.md`
</output>
