---
phase: 17-minimal-mode
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - bin/lib/skills.cjs
  - bin/lib/__tests__/skills.test.js
autonomous: true
requirements:
  - INIT-01

must_haves:
  truths:
    - "scanSkills(rootDir) returns an array of absolute @-import lines, one per skill directory found in rootDir/.agent/skills/"
    - "scanSkills returns lines sorted alphabetically by skill name"
    - "scanSkills returns an empty array when .agent/skills/ does not exist (new project has no skills dir)"
    - "scanSkills(rootDir) uses rootDir as the viflo install root — paths point into rootDir/.agent/skills/<skill>/SKILL.md"
  artifacts:
    - path: "bin/lib/skills.cjs"
      provides: "Runtime skill scanner returning @-import lines"
      exports: ["scanSkills"]
    - path: "bin/lib/__tests__/skills.test.js"
      provides: "TDD test suite for scanSkills"
      min_lines: 40
  key_links:
    - from: "bin/lib/skills.cjs"
      to: "bin/lib/paths.cjs"
      via: "require('./paths.cjs')"
      pattern: "require\\('./paths\\.cjs'\\)"
    - from: "bin/lib/skills.cjs"
      to: ".agent/skills/ filesystem"
      via: "fs.readdirSync with withFileTypes"
      pattern: "readdirSync.*withFileTypes"
---

<objective>
Implement and test the skills scanner library function that discovers all viflo skills at runtime and returns `@`-import lines for use in the CLAUDE.md sentinel block.

Purpose: The CLI entry point needs to produce the correct set of `@` import lines without a hardcoded list. This library function provides that — it scans `.agent/skills/` at runtime so new skills are picked up automatically.
Output: `bin/lib/skills.cjs` exporting `scanSkills(rootDir)`, plus a passing test suite.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-minimal-mode/17-CONTEXT.md
@bin/lib/paths.cjs
@bin/lib/__tests__/writers.test.js
@bin/vitest.config.cjs
</context>

<feature>
  <name>scanSkills — runtime skill directory scanner</name>
  <files>bin/lib/skills.cjs, bin/lib/__tests__/skills.test.js</files>
  <behavior>
    scanSkills(rootDir: string) -> string[]

    Cases:
    - rootDir has .agent/skills/ with 3 subdirs → returns 3 sorted "@{rootDir}/.agent/skills/{name}/SKILL.md" lines
    - rootDir has .agent/skills/ with 0 subdirs → returns []
    - rootDir/.agent/skills/ does not exist (ENOENT) → returns []
    - rootDir/.agent/skills/ contains a file (not dir) alongside dirs → only dirs included
    - Returned lines are alphabetically sorted by skill directory name

    Implementation rules:
    - Use fs.readdirSync(skillsDir, { withFileTypes: true }) to list entries
    - Filter to isDirectory() entries only
    - Build absolute path: `@${path.join(rootDir, '.agent', 'skills', entry.name, 'SKILL.md')}`
    - Catch ENOENT from readdirSync → return []
    - Re-throw non-ENOENT errors
    - Sort result array alphabetically before returning
    - Export: module.exports = { scanSkills }
    - File header: 'use strict'; — consistent with other bin/lib/*.cjs files

    Do NOT use resolveViFloRoot() inside this function — rootDir is passed explicitly by the caller.
    The caller (bin/viflo.cjs) will call scanSkills(resolveViFloRoot()) to get the installed skills.

  </behavior>
  <implementation>
    Write test file FIRST (RED phase), then implement skills.cjs (GREEN phase).

    Test file structure (follow writers.test.js pattern exactly):
    - 'use strict' header
    - Use vitest globals (vi/describe/it/expect/beforeEach) — do NOT import them
    - beforeEach: vi.resetModules() + create a fresh tmpDir with fs.mkdtempSync
    - afterEach: fs.rmSync(tmpDir, { recursive: true, force: true }) + vi.restoreAllMocks()
    - lazy require: const { scanSkills } = require('../skills.cjs') inside each it()
    - Test cases (min 5):
      1. returns empty array when .agent/skills/ does not exist
      2. returns empty array when skills dir exists but has no subdirectories
      3. returns one @-line for a single skill directory
      4. returns multiple @-lines sorted alphabetically for multiple skill dirs
      5. ignores files (non-directories) inside .agent/skills/
    - Use fs.mkdirSync to set up fake skill directories inside tmpDir for tests
    - Assert exact string format: `@${tmpDir}/.agent/skills/${name}/SKILL.md`

  </implementation>
</feature>

<tasks>

<task type="tdd">
  <name>Task 1: TDD — scanSkills skill directory scanner</name>
  <files>bin/lib/__tests__/skills.test.js, bin/lib/skills.cjs</files>
  <action>
    RED phase:
    Create bin/lib/__tests__/skills.test.js with at least 5 test cases covering:
    (a) ENOENT on .agent/skills/ → empty array
    (b) empty skills dir → empty array
    (c) single skill dir → one @-import line with absolute path ending in /SKILL.md
    (d) multiple skill dirs → alphabetically sorted @-import lines
    (e) mixed files + dirs in skills dir → only dirs included
    Use vitest globals (no imports), lazy require pattern inside each it(). Run:
      pnpm run test:cli
    Confirm ALL new tests FAIL (skills.cjs does not exist yet). Commit: test(17-01): add failing tests for scanSkills

    GREEN phase:
    Create bin/lib/skills.cjs:
    - 'use strict'; header
    - require 'fs', 'path' (no other dependencies needed)
    - scanSkills(rootDir): use fs.readdirSync(path.join(rootDir, '.agent', 'skills'), { withFileTypes: true }),
      catch ENOENT → return [], filter isDirectory() only,
      map to `@${path.join(rootDir, '.agent', 'skills', entry.name, 'SKILL.md')}`,
      sort alphabetically, return result
    - module.exports = { scanSkills }
    Run: pnpm run test:cli
    Confirm ALL tests PASS. Commit: feat(17-01): implement scanSkills runtime skill scanner

  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && pnpm run test:cli</automated>
    <manual>Confirm skills.test.js tests appear in output and all pass. Zero failures.</manual>
  </verify>
  <done>pnpm run test:cli exits 0, all scanSkills tests pass including the 5 required cases, bin/lib/skills.cjs exists and exports scanSkills</done>
</task>

</tasks>

<verification>
Run full CLI test suite: pnpm run test:cli
All tests pass (existing 23 + new skills tests).
bin/lib/skills.cjs exists and exports scanSkills.
bin/lib/__tests__/skills.test.js exists with min 5 test cases.
</verification>

<success_criteria>

- pnpm run test:cli passes with zero failures
- scanSkills correctly handles missing dir, empty dir, mixed entries, and multiple skills
- @-import lines use absolute paths built from rootDir (not resolveViFloRoot() — caller responsibility)
- Alphabetical sort confirmed by test
  </success_criteria>

<output>
After completion, create `.planning/phases/17-minimal-mode/17-01-SUMMARY.md`
</output>
