---
phase: 11-foundation-skills
plan: 03
type: execute
wave: 3
depends_on:
  - 11-01
  - 11-02
files_modified:
  - .agent/skills/prompt-engineering/SKILL.md
  - .agent/skills/prompt-engineering/references/anti-patterns.md
autonomous: true
requirements:
  - PROMPT-03
  - PROMPT-04
gap_closure: true

must_haves:
  truths:
    - "The output format specification pattern in SKILL.md uses the correct Anthropic SDK API surface — a developer copying the code block will not get a runtime error"
    - "The AFTER block in anti-patterns.md anti-pattern #3 uses the correct Anthropic SDK API surface — the corrected example is actually correct"
  artifacts:
    - path: ".agent/skills/prompt-engineering/SKILL.md"
      provides: "Output format specification pattern with correct output_config and message.parsed_output"
      contains: "output_config"
    - path: ".agent/skills/prompt-engineering/references/anti-patterns.md"
      provides: "Anti-pattern #3 AFTER block with correct output_config and message.parsed_output"
      contains: "output_config"
  key_links:
    - from: ".agent/skills/prompt-engineering/SKILL.md"
      to: "@anthropic-ai/sdk messages.parse"
      via: "output_config: { format: zodOutputFormat(...) } parameter"
      pattern: "output_config"
    - from: ".agent/skills/prompt-engineering/references/anti-patterns.md"
      to: "@anthropic-ai/sdk messages.parse"
      via: "output_config: { format: zodOutputFormat(...) } in AFTER block"
      pattern: "output_config"
---

<objective>
Fix four incorrect lines across two files where the structured output pattern uses the OpenAI-compatible API surface instead of the Anthropic SDK surface. This is a mechanical gap closure — no logic changes, only API parameter name and response accessor corrections.

Purpose: PROMPT-03 and PROMPT-04 are partially satisfied because the output format specification code block in SKILL.md and the AFTER block in anti-patterns.md anti-pattern #3 both use `response_format:` and `response.choices[0].message.parsed` — the OpenAI API surface. The Anthropic SDK uses `output_config: { format: zodOutputFormat(...) }` and `message.parsed_output`. A developer copying either block will get a runtime error.

Output: Two files with correct Anthropic SDK API surface in the structured output code blocks.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.agent/skills/prompt-engineering/SKILL.md
@.agent/skills/prompt-engineering/references/anti-patterns.md
@.planning/phases/11-foundation-skills/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix structured output API surface in SKILL.md and anti-patterns.md</name>
  <files>
    .agent/skills/prompt-engineering/SKILL.md
    .agent/skills/prompt-engineering/references/anti-patterns.md
  </files>
  <action>
Apply four targeted line changes. Do NOT modify any other content in either file.

**SKILL.md — two changes (in the Output Format Specification pattern code block):**

Current line 244:
```
  response_format: zodOutputFormat(SentimentSchema, 'sentiment'),
```
Replace with:
```
  output_config: { format: zodOutputFormat(SentimentSchema, 'sentiment') },
```

Current line 247:
```
const result = response.choices[0].message.parsed;
```
Replace with:
```
const result = message.parsed_output;
```

Note: The variable on the left side of the assignment should match the variable returned by `client.messages.parse`. In the SKILL.md context, the call is `const response = await client.messages.parse({...})` — update the destructured access: change `response.choices[0].message.parsed` to `response.parsed_output` (keeping the `response` variable name consistent with its declaration on line 235). The correct access path on the Anthropic SDK is `.parsed_output` directly on the message object returned from `messages.parse`.

So line 247 becomes:
```
const result = response.parsed_output;
```

**anti-patterns.md — two changes (in the anti-pattern #3 AFTER block):**

Current line 111:
```
  response_format: zodOutputFormat(SentimentSchema, 'sentiment'),
```
Replace with:
```
  output_config: { format: zodOutputFormat(SentimentSchema, 'sentiment') },
```

Current line 114:
```
const result = response.choices[0].message.parsed;
```
Replace with:
```
const result = response.parsed_output;
```

The variable name `response` is already used on the preceding line (`const response = await client.messages.parse({...})`), so `.parsed_output` directly on `response` is the correct access path.

**Verification of correct API (from 11-RESEARCH.md):**
```typescript
const message = await client.messages.parse({
  model: 'claude-sonnet-4-6',
  max_tokens: 256,
  messages: [...],
  output_config: {
    format: zodOutputFormat(SentimentSchema, 'sentiment'),
  },
});
console.log(message.parsed_output?.sentiment);
```
The parameter is `output_config: { format: zodOutputFormat(...) }` and the response accessor is `.parsed_output` on the returned message object.
  </action>
  <verify>
    <automated>grep -n "output_config\|parsed_output\|response_format\|choices\[0\]" /home/ollie/Development/Tools/viflo/.agent/skills/prompt-engineering/SKILL.md && echo "---" && grep -n "output_config\|parsed_output\|response_format\|choices\[0\]" /home/ollie/Development/Tools/viflo/.agent/skills/prompt-engineering/references/anti-patterns.md</automated>
    <manual>Confirm: both files show "output_config" and "parsed_output" in the structured output code blocks, and neither file contains "response_format:" or "choices[0]".</manual>
  </verify>
  <done>
    - SKILL.md line 244: `response_format:` replaced with `output_config: { format: ... }`
    - SKILL.md line 247: `response.choices[0].message.parsed` replaced with `response.parsed_output`
    - anti-patterns.md line 111: `response_format:` replaced with `output_config: { format: ... }`
    - anti-patterns.md line 114: `response.choices[0].message.parsed` replaced with `response.parsed_output`
    - Neither file contains `response_format:` or `choices[0]` in any code block
  </done>
</task>

</tasks>

<verification>
After the task completes:
1. `grep "response_format" .agent/skills/prompt-engineering/SKILL.md` — must return no results
2. `grep "choices\[0\]" .agent/skills/prompt-engineering/SKILL.md` — must return no results
3. `grep "output_config" .agent/skills/prompt-engineering/SKILL.md` — must return the corrected line
4. `grep "parsed_output" .agent/skills/prompt-engineering/SKILL.md` — must return the corrected line
5. `grep "response_format" .agent/skills/prompt-engineering/references/anti-patterns.md` — must return no results
6. `grep "choices\[0\]" .agent/skills/prompt-engineering/references/anti-patterns.md` — must return no results
7. `grep "output_config" .agent/skills/prompt-engineering/references/anti-patterns.md` — must return the corrected AFTER block line
8. `grep "parsed_output" .agent/skills/prompt-engineering/references/anti-patterns.md` — must return the corrected AFTER block line
</verification>

<success_criteria>
The gap is closed when:
- SKILL.md output format specification pattern uses `output_config: { format: zodOutputFormat(SentimentSchema, 'sentiment') }` and `response.parsed_output`
- anti-patterns.md anti-pattern #3 AFTER block uses `output_config: { format: zodOutputFormat(SentimentSchema, 'sentiment') }` and `response.parsed_output`
- A developer copying either code block will not encounter a runtime error from wrong API surface usage
- PROMPT-03 and PROMPT-04 are fully satisfied (not partially)
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-skills/11-03-SUMMARY.md` using the summary template.
</output>
