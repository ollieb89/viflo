# Plan 09-01: Workspace Configuration

<plan phase="9" plan="1">
  <overview>
    <phase_name>Workspace & Developer Tooling â€” Workspace Configuration</phase_name>
    <goal>Fix pnpm workspace configuration so single `pnpm install` works for all packages</goal>
  </overview>
  
  <dependencies>
    <complete>Phase 8: Verification & Requirements Closure</complete>
  </dependencies>
  
  <reference>
    <context>09-CONTEXT.md</context>
    <requirement>CI-02 gap closure</requirement>
  </reference>

  <tasks>
    <task type="auto" priority="1">
      <name>Audit current pnpm-workspace.yaml</name>
      <files>pnpm-workspace.yaml</files>
      <action>
        Check current workspace configuration. Identify why apps/web 
        dependencies aren't being installed by root pnpm install.
      </action>
      <verify>Understand current workspace structure and issue</verify>
    </task>

    <task type="auto" priority="1">
      <name>Update pnpm-workspace.yaml with proper globs</name>
      <files>pnpm-workspace.yaml</files>
      <action>
        Update pnpm-workspace.yaml to explicitly declare workspace packages:
        ```yaml
        packages:
          - 'apps/*'
          - 'packages/*'
        ```
        This ensures all apps and packages are included in the workspace.
      </action>
      <verify>File contains proper glob patterns for apps/* and packages/*</verify>
    </task>

    <task type="auto" priority="1">
      <name>Verify apps/web package.json has correct name</name>
      <files>apps/web/package.json</files>
      <action>
        Ensure apps/web/package.json has proper name field (@viflo/web)
        and is recognized as a workspace package.
      </action>
      <verify>Package name is correct and unique</verify>
    </task>

    <task type="auto" priority="1">
      <name>Test single pnpm install locally</name>
      <files>.</files>
      <action>
        Run `pnpm install` from root and verify:
        1. Root dependencies installed
        2. apps/web dependencies installed in apps/web/node_modules
        3. No need to run separate install in apps/web
      </action>
      <verify>Single install works, apps/web has node_modules</verify>
    </task>

    <task type="auto" priority="1">
      <name>Update CI workflow to use single install</name>
      <files>.github/workflows/ci.yml</files>
      <action>
        Remove the separate `cd apps/web && pnpm install` step.
        Keep only single `pnpm install --frozen-lockfile` at root.
        Ensure all subsequent commands (lint, type-check, test) still work.
      </action>
      <verify>CI file has single install step, no cd apps/web install</verify>
    </task>

    <task type="auto" priority="1">
      <name>Verify workspace commands work from root</name>
      <files>package.json</files>
      <action>
        Ensure root package.json scripts can reference workspace packages:
        - `pnpm --filter @viflo/web test` works
        - Or test command properly targets apps/web
      </action>
      <verify>Root commands can execute workspace package scripts</verify>
    </task>

    <task type="manual" priority="2">
      <name>Test CI pipeline end-to-end</name>
      <action>
        Push branch and verify CI passes with single install step.
        Check that all steps complete successfully:
        - install
        - lint
        - type-check
        - test
        - coverage ratchet
        - build
      </action>
      <verify>CI passes with new workspace configuration</verify>
      <done>CI workflow verified working</done>
    </task>
  </tasks>
</plan>
