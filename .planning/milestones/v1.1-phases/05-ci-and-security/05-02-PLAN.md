---
phase: 05-ci-and-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .pre-commit-config.yaml
  - .secrets.baseline
  - CONTRIBUTING.md
autonomous: true
requirements:
  - QUAL-01
  - QUAL-02

must_haves:
  truths:
    - "Running `git commit` with a plaintext secret in a staged file is blocked by the pre-commit hook"
    - "The pre-commit hook runs both gitleaks and detect-secrets before every commit"
    - "Developers can install the pre-commit hooks with a single documented command"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hook configuration using the Python pre-commit framework"
      contains: "gitleaks|detect-secrets"
    - path: ".secrets.baseline"
      provides: "detect-secrets baseline file marking known/allowed patterns"
      contains: "version"
    - path: "CONTRIBUTING.md"
      provides: "Developer onboarding instructions for installing pre-commit hooks"
      contains: "pre-commit install"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: "gitleaks hook"
      via: "repo: https://github.com/gitleaks/gitleaks"
      pattern: "gitleaks/gitleaks"
    - from: ".pre-commit-config.yaml"
      to: "detect-secrets hook"
      via: "repo: https://github.com/Yelp/detect-secrets"
      pattern: "Yelp/detect-secrets"
    - from: ".secrets.baseline"
      to: "detect-secrets"
      via: "detect-secrets scan > .secrets.baseline"
      pattern: "results"
---

<objective>
Configure pre-commit secret scanning to block committed secrets before they reach the repo.

Purpose: Every developer commit runs gitleaks and detect-secrets, blocking plaintext secrets from ever entering the repository history. This satisfies QUAL-01 (hooks configured) and QUAL-02 (secret blocked in practice).
Output: `.pre-commit-config.yaml`, `.secrets.baseline`, and updated `CONTRIBUTING.md` with installation instructions.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ci-and-security/05-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .pre-commit-config.yaml and generate .secrets.baseline</name>
  <files>.pre-commit-config.yaml, .secrets.baseline</files>
  <action>
    Create `.pre-commit-config.yaml` using the Python `pre-commit` framework. Per user decision: run both gitleaks and detect-secrets; secrets scanning only (no lint/type-check in pre-commit — those run in CI).

    Config structure:
    ```yaml
    repos:
      - repo: https://github.com/gitleaks/gitleaks
        rev: v8.21.2   # pin to a recent stable version — check https://github.com/gitleaks/gitleaks/releases for latest v8.x tag
        hooks:
          - id: gitleaks

      - repo: https://github.com/Yelp/detect-secrets
        rev: v1.5.0    # matches installed version (detect-secrets --version = 1.5.0)
        hooks:
          - id: detect-secrets
            args: ['--baseline', '.secrets.baseline']
    ```

    Pin exact versions using the `rev` field. For gitleaks, use the latest v8.x release tag (v8.21.2 or newer). For detect-secrets, use v1.5.0 (already installed locally).

    After creating the config, generate the `.secrets.baseline` file:
    ```bash
    detect-secrets scan > .secrets.baseline
    ```
    Run this from the repo root. This scans the current codebase and creates a baseline of any patterns that already exist (so the hook doesn't flag pre-existing content). If `detect-secrets` is not available via PATH, try `/home/ollie/.local/bin/detect-secrets scan > .secrets.baseline`.

    The `.secrets.baseline` file should be committed to the repo so the hook has a reference point. Do NOT gitignore it.

    Do NOT install the hooks themselves (`pre-commit install`) — that's the developer's responsibility after cloning. Document the installation command in CONTRIBUTING.md (Task 2).

  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && python3 -c "import yaml; cfg = yaml.safe_load(open('.pre-commit-config.yaml')); repos = [r['repo'] for r in cfg['repos']]; assert any('gitleaks' in r for r in repos), 'gitleaks missing'; assert any('detect-secrets' in r for r in repos), 'detect-secrets missing'; print('pre-commit config OK:', repos)"</automated>
    <manual>Confirm .secrets.baseline exists and contains valid JSON with a "version" key</manual>
  </verify>
  <done>.pre-commit-config.yaml exists with pinned gitleaks and detect-secrets hooks. .secrets.baseline exists as valid JSON generated by `detect-secrets scan`.</done>
</task>

<task type="auto">
  <name>Task 2: Update CONTRIBUTING.md with pre-commit installation instructions</name>
  <files>CONTRIBUTING.md</files>
  <action>
    Add a "Pre-commit Hooks (Secret Scanning)" section to CONTRIBUTING.md. Per user decision: installation documented as `pip install pre-commit && pre-commit install`.

    Insert a new section after the "### Step 3: Set Up the Development Environment" block (which already shows `pnpm install` and `pip3 install -r scripts/requirements.txt`). Add it as a sub-step or follow-up block within that section.

    New section content to insert:

    ```markdown
    ### Pre-commit Hooks (Secret Scanning)

    This repository uses [pre-commit](https://pre-commit.com/) to run secret scanning before every commit. The hooks run `gitleaks` and `detect-secrets` to prevent accidental credential exposure.

    Install the hooks after cloning:

    ```bash
    pip install pre-commit
    pre-commit install
    ```

    Once installed, the hooks run automatically on `git commit`. To run them manually against all files:

    ```bash
    pre-commit run --all-files
    ```

    If a commit is blocked, the hook will print the detected secret's file and line. Remove the secret, use an environment variable instead, and re-commit.
    ```

    Place this section after the existing Step 3 environment setup block and before Step 4 (Make Your Changes). Keep the existing Markdown structure intact.

    Also verify the secrets smoke-test: stage a file containing a fake secret pattern (`FAKE_SECRET=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`) and confirm that detect-secrets would flag it. Do this test locally — do NOT commit the fake secret. Just verify the hook configuration is syntactically valid:
    ```bash
    /home/ollie/.local/bin/detect-secrets scan --baseline .secrets.baseline --list-all-plugins 2>/dev/null || true
    ```

  </action>
  <verify>
    <automated>cd /home/ollie/Development/Tools/viflo && grep -n "pre-commit install" CONTRIBUTING.md && echo "CONTRIBUTING.md updated"</automated>
    <manual>Read the new CONTRIBUTING.md section to confirm it describes pip install pre-commit && pre-commit install correctly</manual>
  </verify>
  <done>CONTRIBUTING.md contains a "Pre-commit Hooks" section with `pip install pre-commit && pre-commit install` instructions and manual-run command.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `.pre-commit-config.yaml` is valid YAML with gitleaks and detect-secrets repos: `python3 -c "import yaml; yaml.safe_load(open('.pre-commit-config.yaml')); print('valid')"`
2. `.secrets.baseline` exists and is valid JSON: `python3 -c "import json; json.load(open('.secrets.baseline')); print('valid baseline')"`
3. CONTRIBUTING.md contains pre-commit install instructions: `grep -c "pre-commit install" CONTRIBUTING.md`
4. Smoke test — the hook would block a fake secret (manual verification):
   ```bash
   echo "TEST_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" > /tmp/fake-secret.txt
   /home/ollie/.local/bin/detect-secrets scan /tmp/fake-secret.txt
   ```
   Confirm output shows a detected secret entry.
</verification>

<success_criteria>

- QUAL-01: Pre-commit hooks run gitleaks and detect-secrets before every commit (configuration committed to repo)
- QUAL-02: A plaintext secret committed to the repo is blocked by the pre-commit hook (verified via smoke test)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-ci-and-security/05-02-SUMMARY.md` documenting:
- Files created (.pre-commit-config.yaml, .secrets.baseline)
- Files modified (CONTRIBUTING.md)
- Hook versions pinned (gitleaks rev, detect-secrets rev)
- How .secrets.baseline was generated
- Smoke test result confirming detect-secrets flags test secrets
</output>
