---
phase: 14-stripe-payments
plan: "02"
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - .agent/skills/stripe-payments/references/webhook-patterns.md
  - .agent/skills/stripe-payments/references/subscription-patterns.md
autonomous: true
requirements: [STRIPE-02, STRIPE-03, STRIPE-05]

must_haves:
  truths:
    - "webhook-patterns.md uses API version 2026-01-28.clover and stripe v20.x throughout — no stale 2025-01-27.acacia references"
    - "webhook-patterns.md shows the complete webhook handler with atomic idempotency SQL as the canonical reference pattern"
    - "subscription-patterns.md covers all four subscription lifecycle events with raw Stripe status strings"
    - "subscription-patterns.md shows Customer Portal session creation and trial period configuration"
    - "Both reference files are internally consistent with the patterns promoted into SKILL.md in Plan 01"
  artifacts:
    - path: ".agent/skills/stripe-payments/references/webhook-patterns.md"
      provides: "Complete verified webhook handler + idempotency schema"
      contains: "2026-01-28"
    - path: ".agent/skills/stripe-payments/references/webhook-patterns.md"
      provides: "Atomic idempotency SQL pattern"
      contains: "ON CONFLICT (stripe_event_id) DO NOTHING"
    - path: ".agent/skills/stripe-payments/references/subscription-patterns.md"
      provides: "Four-event subscription lifecycle handler"
      contains: "invoice.payment_failed"
    - path: ".agent/skills/stripe-payments/references/subscription-patterns.md"
      provides: "Customer Portal session and trial configuration"
      contains: "billingPortal.sessions.create"
  key_links:
    - from: ".agent/skills/stripe-payments/SKILL.md"
      to: ".agent/skills/stripe-payments/references/webhook-patterns.md"
      via: "See references link at top of SKILL.md"
      pattern: "references/webhook-patterns"
    - from: ".agent/skills/stripe-payments/SKILL.md"
      to: ".agent/skills/stripe-payments/references/subscription-patterns.md"
      via: "See references link at top of SKILL.md"
      pattern: "references/subscription-patterns"
---

<objective>
Update `.agent/skills/stripe-payments/references/webhook-patterns.md` and `.agent/skills/stripe-payments/references/subscription-patterns.md` to be consistent with the rewritten SKILL.md from Plan 01 — updating the Stripe API version from `2025-01-27.acacia` to `2026-01-28.clover`, stripe SDK from v17.x to v20.x, ensuring `await headers()` is async (Next.js 15), and verifying all four subscription lifecycle events are fully documented.

Purpose: Reference files are the canonical deep-dive for patterns summarized in SKILL.md. They must stay in sync with the SKILL.md rewrite — stale API versions or inconsistent patterns in reference files undermine the skill's value as a production reference.

Output: Both reference files updated and internally consistent with SKILL.md Plan 01 output.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-stripe-payments/14-CONTEXT.md
@.planning/phases/14-stripe-payments/14-RESEARCH.md
@.planning/phases/14-stripe-payments/14-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update webhook-patterns.md to stripe v20 and Next.js 15</name>
  <files>.agent/skills/stripe-payments/references/webhook-patterns.md</files>
  <action>
Read the existing `.agent/skills/stripe-payments/references/webhook-patterns.md` file in full. Then update it for consistency with the SKILL.md rewrite from Plan 01.

**Specific changes required:**

1. **API version:** Replace all occurrences of `2025-01-27.acacia` with `2026-01-28.clover`

2. **Stripe SDK version:** Update any version references from v17.x to v20.x (or stripe v20.3.1) in comments or headers

3. **`headers()` async pattern:** Ensure all webhook handler examples use the async form:
   - Correct: `const sig = (await headers()).get('stripe-signature');`
   - Or: `const headersList = await headers(); const sig = headersList.get('stripe-signature');`
   - Incorrect (sync, Next.js 14 pattern): `headers().get('stripe-signature')` without await

4. **Idempotency section:** Verify that `INSERT INTO stripe_events ... ON CONFLICT (stripe_event_id) DO NOTHING` is present. If any check-then-insert patterns exist (SELECT then INSERT), replace them with the atomic pattern.

5. **`await req.text()` placement:** Ensure all webhook handler examples call `await req.text()` before any other body access — this is the canonical first operation.

6. **`stripe_events` table schema:** Ensure the schema definition matches exactly:

   ```sql
   CREATE TABLE IF NOT EXISTS stripe_events (
     stripe_event_id TEXT PRIMARY KEY,
     event_type      TEXT NOT NULL,
     processed_at    TIMESTAMPTZ DEFAULT NOW()
   );
   ```

7. **Stripe CLI commands:** If Stripe CLI local dev instructions are present, ensure they include both forwarding and trigger commands:
   ```bash
   stripe listen --forward-to localhost:3000/api/webhooks/stripe
   stripe trigger checkout.session.completed
   ```

Do not change the overall structure of the file beyond these targeted updates. Preserve any content that is already correct.
</action>
<verify>
<automated>
cd /home/ollie/Development/Tools/viflo
grep -c "2026-01-28" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "await req.text()" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "ON CONFLICT (stripe_event_id) DO NOTHING" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "await headers()" .agent/skills/stripe-payments/references/webhook-patterns.md

# Must be 0 — stale version should be gone

grep -c "2025-01-27" .agent/skills/stripe-payments/references/webhook-patterns.md
</automated>
<manual>Verify the webhook handler example in the reference file has `await req.text()` as the first body operation. Confirm no `headers().get()` calls (without await) remain. Confirm idempotency SQL is atomic (INSERT...ON CONFLICT, not SELECT then INSERT).</manual>
</verify>
<done>
`2026-01-28` appears ≥1 time. `await req.text()` appears ≥1 time. `ON CONFLICT (stripe_event_id) DO NOTHING` appears ≥1 time. `await headers()` appears ≥1 time. `2025-01-27` appears 0 times (stale version eliminated).
</done>
</task>

<task type="auto">
  <name>Task 2: Update subscription-patterns.md with all four events and portal/trial patterns</name>
  <files>.agent/skills/stripe-payments/references/subscription-patterns.md</files>
  <action>
Read the existing `.agent/skills/stripe-payments/references/subscription-patterns.md` file in full. Then update it for consistency with the SKILL.md rewrite from Plan 01.

**Specific changes required:**

1. **API version:** Replace all occurrences of `2025-01-27.acacia` with `2026-01-28.clover`

2. **Stripe SDK version:** Update any version references from v17.x to v20.x in comments or headers

3. **All four subscription lifecycle events:** Verify all four critical events are fully documented with TypeScript examples:
   - `customer.subscription.created` — UPDATE users SET subscription_status, stripe_subscription_id
   - `customer.subscription.updated` — same UPDATE as created (handles plan changes)
   - `customer.subscription.deleted` — UPDATE users SET subscription_status = 'canceled', stripe_subscription_id = NULL
   - `invoice.payment_failed` — UPDATE users SET subscription_status = 'past_due'; note Stripe Smart Retries

4. **Raw Stripe status strings:** Ensure the status values stored in the database are raw Stripe strings (`'active'`, `'canceled'`, `'past_due'`, `'trialing'`, etc.) — NOT app-specific enums or mappings.

5. **Database schema alignment:** Ensure the users table schema matches the SKILL.md schema from Plan 01:

   ```sql
   ALTER TABLE users
     ADD COLUMN IF NOT EXISTS stripe_customer_id      TEXT UNIQUE,
     ADD COLUMN IF NOT EXISTS stripe_subscription_id  TEXT UNIQUE,
     ADD COLUMN IF NOT EXISTS subscription_status     TEXT DEFAULT 'free';
   ```

6. **Customer Portal pattern:** Ensure `stripe.billingPortal.sessions.create()` is present with:
   - Note about enabling the portal in Stripe Dashboard > Settings > Billing first
   - Note about looking up `customerId` from the database using the authenticated user's ID (not from the request body)
   - Return URL pointing to dashboard/account page

7. **Trial periods:** Ensure `subscription_data.trial_period_days` pattern is present in a Checkout Session with `mode: 'subscription'`. Include the note about `trial_will_end` event (fires 3 days before trial ends) and `trial_settings.end_behavior.missing_payment_method`.

8. **Smart Retries callout:** For `invoice.payment_failed`, ensure the handler includes a comment/note: "Stripe Smart Retries handles recovery — no custom dunning needed."

Do not change the overall structure of the file beyond these targeted updates. Preserve any content that is already correct.
</action>
<verify>
<automated>
cd /home/ollie/Development/Tools/viflo
grep -c "2026-01-28" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "invoice.payment_failed" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "billingPortal.sessions.create" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "trial_period_days" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "subscription_status" .agent/skills/stripe-payments/references/subscription-patterns.md

# Must be 0 — stale version should be gone

grep -c "2025-01-27" .agent/skills/stripe-payments/references/subscription-patterns.md
</automated>
<manual>Confirm all four subscription events are documented with TypeScript UPDATE queries. Confirm subscription status values are raw Stripe strings (not enums). Confirm Customer Portal section notes the Dashboard enable requirement. Confirm trial section includes trial_will_end event note.</manual>
</verify>
<done>
`2026-01-28` appears ≥1 time. `invoice.payment_failed` appears ≥1 time. `billingPortal.sessions.create` appears ≥1 time. `trial_period_days` appears ≥1 time. `subscription_status` appears ≥2 times. `2025-01-27` appears 0 times.
</done>
</task>

</tasks>

<verification>
Run the automated checks from both verify blocks. All positive grep counts must be ≥1. Stale version counts must be 0.

```bash
cd /home/ollie/Development/Tools/viflo
echo "=== webhook-patterns.md ==="
grep -c "2026-01-28" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "await req.text()" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "ON CONFLICT (stripe_event_id) DO NOTHING" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "await headers()" .agent/skills/stripe-payments/references/webhook-patterns.md
grep -c "2025-01-27" .agent/skills/stripe-payments/references/webhook-patterns.md

echo "=== subscription-patterns.md ==="
grep -c "2026-01-28" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "invoice.payment_failed" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "billingPortal.sessions.create" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "trial_period_days" .agent/skills/stripe-payments/references/subscription-patterns.md
grep -c "2025-01-27" .agent/skills/stripe-payments/references/subscription-patterns.md
```

</verification>

<success_criteria>

- Both reference files have API version `2026-01-28.clover` — no stale `2025-01-27.acacia` references remain
- webhook-patterns.md: `await req.text()` first; atomic `INSERT ... ON CONFLICT DO NOTHING`; async `await headers()`; `stripe_events` table schema correct
- subscription-patterns.md: all four lifecycle events; raw Stripe status strings; Customer Portal with Dashboard enable note; `trial_period_days` with `trial_will_end` note; Smart Retries callout on `invoice.payment_failed`
- Both files internally consistent with SKILL.md from Plan 01 — a developer can read SKILL.md for the quick summary and dive into reference files for production-complete implementations
  </success_criteria>

<output>
After completion, create `.planning/phases/14-stripe-payments/14-02-SUMMARY.md` following the summary template at `/home/ollie/.claude/get-shit-done/templates/summary.md`.

Include:

- Specific changes made to each reference file
- Grep counts for all verification checks
- Confirmation that stale API version is eliminated from both files
- Requirements addressed: STRIPE-02, STRIPE-03, STRIPE-05
  </output>
