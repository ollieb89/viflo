---
phase: 14-stripe-payments
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - .agent/skills/stripe-payments/SKILL.md
autonomous: true
requirements: [STRIPE-01, STRIPE-02, STRIPE-03, STRIPE-04, STRIPE-05]

must_haves:
  truths:
    - "Developer can follow the Quick Start and accept a one-time payment via Stripe Checkout in under 15 minutes with fewer than 30 lines of code"
    - "The webhook handler section leads with `await req.text()` as the first code example — raw body extraction is the headline, not a footnote"
    - "The idempotency section shows `INSERT ... ON CONFLICT (stripe_event_id) DO NOTHING` in the main SKILL.md body — not in references, not in a footnote"
    - "The subscription lifecycle section covers all four critical events: customer.subscription.created, customer.subscription.updated, customer.subscription.deleted, invoice.payment_failed"
    - "The Gotchas section names at least 3 pitfalls (raw body destruction, non-atomic idempotency, PCI scope creep) in Symptom → Cause → Fix format"
    - "The Customer Portal section shows `stripe.billingPortal.sessions.create()` with a note to enable the portal in Stripe Dashboard > Settings > Billing"
    - "Trial periods are shown via `subscription_data.trial_period_days` on a Checkout Session in subscription mode"
  artifacts:
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Complete Stripe skill at auth-systems depth"
      min_lines: 350
      contains: "Quick Start"
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Raw-body webhook pattern as first webhook example"
      contains: "await req.text()"
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Atomic idempotency SQL in main body"
      contains: "ON CONFLICT (stripe_event_id) DO NOTHING"
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Four subscription lifecycle events covered"
      contains: "invoice.payment_failed"
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Customer Portal integration"
      contains: "billingPortal.sessions.create"
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Trial period pattern"
      contains: "trial_period_days"
    - path: ".agent/skills/stripe-payments/SKILL.md"
      provides: "Gotchas section with 3 required pitfalls"
      contains: "PCI scope"
  key_links:
    - from: ".agent/skills/stripe-payments/SKILL.md"
      to: ".agent/skills/stripe-payments/references/webhook-patterns.md"
      via: "See references link at top of file"
      pattern: "references/webhook-patterns"
    - from: ".agent/skills/stripe-payments/SKILL.md"
      to: ".agent/skills/stripe-payments/references/subscription-patterns.md"
      via: "See references link at top of file"
      pattern: "references/subscription-patterns"
---

<objective>
Rewrite `.agent/skills/stripe-payments/SKILL.md` from 91 lines to auth-systems depth (~400 lines), covering a Quick Start (one-time payment via Checkout), raw-body webhook handling with atomic idempotency, subscription lifecycle (four critical events), Customer Portal, trial periods, and a terse Gotchas section with the 3 required pitfalls plus 2 bonus pitfalls.

Purpose: Deliver STRIPE-01 through STRIPE-05. The current SKILL.md is a thin decision matrix with no Quick Start, no Gotchas, an outdated API version (2025-01-27.acacia vs 2026-01-28.clover), and no idempotency section in the main body. This plan promotes verified patterns from the existing reference files into the main skill body, following the same depth standard achieved in Phase 12 (RAG) and Phase 13 (Agent Architecture).

Output: `.agent/skills/stripe-payments/SKILL.md` (~380-430 lines, ≤500 lines per INFRA-02)
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-stripe-payments/14-CONTEXT.md
@.planning/phases/14-stripe-payments/14-RESEARCH.md
@.planning/phases/13-agent-architecture/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SKILL.md to auth-systems depth</name>
  <files>.agent/skills/stripe-payments/SKILL.md</files>
  <action>
Rewrite `.agent/skills/stripe-payments/SKILL.md` completely. The current file is 91 lines; the target is ~380-430 lines at auth-systems depth (≤500 per INFRA-02). Use Phase 12 (RAG) and Phase 13 (Agent Architecture) SKILL.md files as the depth template.

**Read first before writing:**
- `.agent/skills/stripe-payments/references/webhook-patterns.md` — existing verified webhook handler and Prisma schema
- `.agent/skills/stripe-payments/references/subscription-patterns.md` — lifecycle event handling, plan changes, portal patterns

**Locked decisions from CONTEXT.md (non-negotiable):**
- Next.js App Router Route Handlers throughout — all code examples use Route Handlers
- Stripe Checkout (hosted page) is the primary Quick Start path; Payment Element is noted as a brief callout only (no full example)
- Webhook route handler: `await req.text()` is the first operation, shown as the first code example — not a footnote
- Quick Start: fewer than 30 lines total including the client call; assume Postgres is available (state this dependency before the first code example)
- TypeScript only — no JS variants
- Stripe SDK initialized once in a Setup section (`const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2026-01-28.clover' })`); all later sections reference it without re-initializing
- Environment variables inline: `process.env.STRIPE_SECRET_KEY` — no config abstraction layer
- Four subscription events: `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_failed`
- Subscription status stored as Stripe's string directly — no app-specific enum mapping
- Full database schema shown with migration SQL: includes `stripe_customer_id`, `stripe_subscription_id`, `subscription_status`, `stripe_event_id` columns
- Failed payment recovery: acknowledge `invoice.payment_failed`, point to Stripe Smart Retries — no custom dunning
- Gotchas tone: Symptom → Cause → Fix (terse, three lines per pitfall, no narrative prose)
- Three required pitfalls: raw body destruction, non-atomic idempotency, PCI scope creep
- Two bonus pitfalls: test/live key confusion and Stripe CLI required for local webhook testing
- Idempotency SQL `INSERT ... ON CONFLICT (stripe_event_id) DO NOTHING` must appear in the **main body**, not in references
- `await req.text()` must be the **first code example** in the Webhooks section

**Required document structure (sections in this order):**

```
---
name: stripe-payments
description: [update to reflect new depth — include: Checkout, webhooks, idempotency, subscriptions, Customer Portal, Gotchas]
---

# Stripe Payments

> See `references/webhook-patterns.md` for complete webhook handler with Prisma schema.
> See `references/subscription-patterns.md` for subscription lifecycle, plan changes, and portal patterns.

## Setup

Single SDK initialization block. `apiVersion: '2026-01-28.clover'`. Environment variables block showing all four required vars.

## Quick Start — Accept a One-Time Payment

**Prerequisites:** Postgres database available (needed for webhook idempotency table in production).

Step 1 (server): Route Handler creating a Checkout Session with `mode: 'payment'`. Under 15 lines. No re-init of stripe — reference Setup section.

Step 2 (client): Minimal fetch call redirecting to session.url. Under 5 lines.

Total including both steps: under 30 lines. Brief callout: "Prefer Checkout over Payment Element for most use cases — SAQ A vs SAQ A-EP."

## Webhooks

Open with: "Webhook handlers have one rule: call `await req.text()` before anything else."

First code example: full Route Handler showing `await req.text()` as line 1, `(await headers()).get('stripe-signature')`, then `stripe.webhooks.constructEvent()`. Include error handling. Include the atomic idempotency SQL block immediately after signature verification — in the same code example or directly adjacent (not in a footnote, not in a separate section).

Show `INSERT INTO stripe_events (stripe_event_id, event_type) VALUES ($1, $2) ON CONFLICT (stripe_event_id) DO NOTHING` with the row count check (`if (result.rowCount === 0) return new Response('Already processed', { status: 200 })`).

Database schema block (SQL):
```sql
CREATE TABLE IF NOT EXISTS stripe_events (
  stripe_event_id TEXT PRIMARY KEY,
  event_type      TEXT NOT NULL,
  processed_at    TIMESTAMPTZ DEFAULT NOW()
);
```

Local development callout: `stripe listen --forward-to localhost:3000/api/webhooks/stripe` and `stripe trigger checkout.session.completed`.

## Subscription Lifecycle

Database schema (SQL ALTER TABLE):
```sql
ALTER TABLE users
  ADD COLUMN IF NOT EXISTS stripe_customer_id      TEXT UNIQUE,
  ADD COLUMN IF NOT EXISTS stripe_subscription_id  TEXT UNIQUE,
  ADD COLUMN IF NOT EXISTS subscription_status     TEXT DEFAULT 'free';
```

Full switch statement covering all four events using raw Stripe status strings. For `customer.subscription.created` and `customer.subscription.updated`: UPDATE users SET subscription_status, stripe_subscription_id. For `customer.subscription.deleted`: UPDATE users SET subscription_status = 'canceled', stripe_subscription_id = NULL. For `invoice.payment_failed`: UPDATE users SET subscription_status = 'past_due'. Callout: "Point to Stripe Smart Retries — no custom dunning needed."

## Customer Portal

Brief explanation: "Lets users manage their own subscriptions (upgrades, downgrades, cancellations, invoice history) without custom UI."

Note: "Enable the Customer Portal in Stripe Dashboard > Settings > Billing before calling this API."

Route Handler creating a billing portal session. Note: "Always look up customerId from your database using the authenticated user's ID — never trust client-provided customerId."

## Trial Periods

Checkout Session with `mode: 'subscription'` and `subscription_data.trial_period_days: 14`. Note: "When the trial ends, Stripe fires `customer.subscription.trial_will_end` (3 days before), then transitions to `active` (charges card) or `past_due`/`canceled` based on `trial_settings.end_behavior.missing_payment_method`." Brief note on proration for mid-cycle plan changes: upgrades use `proration_behavior: 'create_prorations'`; downgrades use `'none'`.

## Gotchas

Use **Symptom → Cause → Fix** format. Three lines max per pitfall. No narrative prose.

**Gotcha 1: Raw Body Destruction**
Symptom: `constructEvent()` always throws "No signatures found" even with correct secret.
Cause: `req.json()`, `req.formData()`, or Express bodyParser consumed the stream before `constructEvent()` reads it.
Fix: Call `await req.text()` as the absolute first line of the webhook handler — before any other body access.

**Gotcha 2: Non-Atomic Idempotency**
Symptom: Same event processed twice — duplicate charges, duplicate subscription records, users billed twice.
Cause: `SELECT` → if not exists → `INSERT` has a race window; two concurrent Stripe retries both pass the SELECT, then both INSERT.
Fix: `INSERT ... ON CONFLICT (stripe_event_id) DO NOTHING`; check `result.rowCount === 0` and return 200 immediately if already processed.

**Gotcha 3: PCI Scope Creep**
Symptom: Compliance audit flags raw card numbers, CVV, or expiry appearing in server request bodies.
Cause: Custom HTML payment form (`<input>` for card fields) passes raw card data through your server — SAQ D (300+ controls).
Fix: Use Stripe Checkout or Payment Element only. See https://docs.stripe.com/security/guide. SAQ A requires only ~20 controls.

**Gotcha 4: Test vs. Live Key Confusion**
Symptom: Charges appear in Stripe test dashboard while app is "live"; `constructEvent()` fails in production only.
Cause: `STRIPE_SECRET_KEY=sk_test_...` deployed to production, or webhook signing secret from test endpoint used with live webhook.
Fix: `sk_test_` = test mode, `sk_live_` = live mode. Signing secrets are per-endpoint — test and live endpoints have different `whsec_` values. Verify all three env vars before go-live.

**Gotcha 5: Stripe CLI Required for Local Webhook Testing**
Symptom: Webhook handler never receives events in local development; developer testing by making real purchases.
Cause: `localhost` is unreachable from Stripe's servers; ngrok adds complexity.
Fix: `stripe listen --forward-to localhost:3000/api/webhooks/stripe` — handles tunneling and signing. `stripe trigger checkout.session.completed` fires specific events without real purchases.

## Version Context

| Library | Version | Notes |
|---|---|---|
| stripe (npm) | 20.3.1 | Official Node.js SDK |
| Next.js | 15.x | App Router Route Handlers; `await headers()` is async |
| Stripe API version | 2026-01-28.clover | Current as of 2026-02-24; set in `new Stripe()` |
```

**Style rules (from CONTEXT.md and Phase 12/13 precedent):**
- TypeScript only — no JS variants
- Gotcha code blocks use inline code spans for patterns, not full code blocks (keeps line count down)
- No horizontal rules between every section — use `##` headings to separate
- Keep total line count ≤500 (INFRA-02). Target 380-430.
- All env vars shown as `process.env.STRIPE_SECRET_KEY` inline — no abstraction
  </action>
  <verify>
    <automated>
cd /home/ollie/Development/Tools/viflo
wc -l .agent/skills/stripe-payments/SKILL.md | awk '{if ($1 >= 350 && $1 <= 500) print "PASS: " $1 " lines"; else print "FAIL: " $1 " lines (expected 350–500)"}'
grep -c "await req.text()" .agent/skills/stripe-payments/SKILL.md
grep -c "ON CONFLICT (stripe_event_id) DO NOTHING" .agent/skills/stripe-payments/SKILL.md
grep -c "invoice.payment_failed" .agent/skills/stripe-payments/SKILL.md
grep -c "billingPortal.sessions.create" .agent/skills/stripe-payments/SKILL.md
grep -c "trial_period_days" .agent/skills/stripe-payments/SKILL.md
grep -c "PCI\|pci" .agent/skills/stripe-payments/SKILL.md
grep -c "2026-01-28" .agent/skills/stripe-payments/SKILL.md
grep -c "Quick Start" .agent/skills/stripe-payments/SKILL.md
    </automated>
    <manual>Verify the Quick Start reads coherently for a developer starting from scratch. Confirm `await req.text()` is the first operation in the webhook code example (not buried after other calls). Confirm the idempotency SQL appears in the main body (not only in references/). Confirm the Gotchas are terse three-liners with no narrative prose.</manual>
  </verify>
  <done>
    SKILL.md is 350–500 lines. `await req.text()` appears ≥2 times (headline example + Gotcha fix). `ON CONFLICT (stripe_event_id) DO NOTHING` appears ≥1 time in main body. `invoice.payment_failed` appears ≥1 time. `billingPortal.sessions.create` appears ≥1 time. `trial_period_days` appears ≥1 time. PCI appears ≥1 time. API version `2026-01-28` appears ≥1 time. "Quick Start" section heading present.
  </done>
</task>

</tasks>

<verification>
Run the automated checks from the verify block. All grep counts must be ≥1. Line count must be 350–500.

```bash
cd /home/ollie/Development/Tools/viflo
wc -l .agent/skills/stripe-payments/SKILL.md
grep -c "await req.text()" .agent/skills/stripe-payments/SKILL.md
grep -c "ON CONFLICT (stripe_event_id) DO NOTHING" .agent/skills/stripe-payments/SKILL.md
grep -c "invoice.payment_failed" .agent/skills/stripe-payments/SKILL.md
grep -c "billingPortal.sessions.create" .agent/skills/stripe-payments/SKILL.md
grep -c "trial_period_days" .agent/skills/stripe-payments/SKILL.md
grep -c "PCI\|pci" .agent/skills/stripe-payments/SKILL.md
grep -c "2026-01-28" .agent/skills/stripe-payments/SKILL.md
grep -c "Quick Start" .agent/skills/stripe-payments/SKILL.md
```
</verification>

<success_criteria>
- SKILL.md is 350–500 lines (INFRA-02 compliant)
- Quick Start: one-time payment via Checkout, under 30 lines total (STRIPE-01)
- Webhooks section: `await req.text()` as first code example; `constructEvent()` signature verification shown; atomic idempotency SQL in main body (STRIPE-02)
- Subscription lifecycle: all four events (created, updated, deleted, payment_failed); status stored as Stripe strings; Smart Retries for recovery (STRIPE-03)
- Gotchas: 3 required pitfalls (raw body destruction, non-atomic idempotency, PCI scope creep) + 2 bonus pitfalls; Symptom → Cause → Fix format (STRIPE-04)
- Customer Portal: `billingPortal.sessions.create()` shown; Dashboard enable note included; trial periods with `trial_period_days` shown (STRIPE-05)
- API version updated to `2026-01-28.clover` (stripe v20.x); no stale `2025-01-27.acacia` references
</success_criteria>

<output>
After completion, create `.planning/phases/14-stripe-payments/14-01-SUMMARY.md` following the summary template at `/home/ollie/.claude/get-shit-done/templates/summary.md`.

Include:
- Final line count of SKILL.md
- Grep counts for all 9 verification checks
- Any deviations from the plan and how they were handled
- Requirements addressed: STRIPE-01, STRIPE-02, STRIPE-03, STRIPE-04, STRIPE-05
</output>
