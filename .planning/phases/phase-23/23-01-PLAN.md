<plan phase="23" plan="1">
  <overview>
    <phase_name>GitHub Actions Data Ingestion</phase_name>
    <goal>Create database schema and ingestion pipeline for GitHub Actions workflow runs</goal>
  </overview>

  <dependencies>
    <complete>Phase 22: Database Ops for Integration</complete>
  </dependencies>

  <tasks>
    <task type="auto" priority="1">
      <name>Create telemetry database migration</name>
      <files>packages/db/src/migrations/versions/002_add_telemetry_tables.py</files>
      <action>
        Create Alembic migration for telemetry tables:
        - workflow_runs table with enhanced schema:
          - github_run_id (BigInteger, part of unique constraint)
          - run_attempt (Integer, default 1, part of unique constraint)
          - workflow_name, branch, commit_sha
          - event_type (VARCHAR 50) - push, pull_request, schedule
          - status, conclusion
          - started_at, completed_at, duration_seconds
          - html_url
          - created_at with default NOW()
          - Unique constraint: (github_run_id, run_attempt)
        - Appropriate indexes for time-series queries:
          - idx_workflow_runs_created_at
          - idx_workflow_runs_github_run_id
      </action>
      <verify>Migration applies cleanly: alembic upgrade head</verify>
      <done>Telemetry tables migration committed</done>
    </task>

    <task type="auto" priority="1">
      <name>Create workflow_run SQLAlchemy model</name>
      <files>packages/db/src/models/workflow_run.py</files>
      <action>
        Implement WorkflowRun model:
        - github_run_id (BigInteger, not null)
        - run_attempt (Integer, default 1)
        - workflow_name, branch, commit_sha
        - event_type (String 50) - push, pull_request, schedule, etc.
        - status, conclusion
        - started_at, completed_at, duration_seconds
        - html_url
        - created_at
        - Add __table_args__ with unique constraint on (github_run_id, run_attempt)
      </action>
      <verify>Model imports and creates table correctly</verify>
      <done>WorkflowRun model with all fields including run_attempt and event_type</done>
    </task>

    <task type="auto" priority="1">
      <name>Create llm_call SQLAlchemy model (enhanced)</name>
      <files>packages/db/src/models/llm_call.py</files>
      <action>
        Implement LlmCall model:
        - timestamp, phase, model
        - prompt_name (String 255) - specific prompt template or task ID
        - input_tokens, output_tokens, total_tokens
        - estimated_cost (Decimal 10,6)
        - success (Boolean)
        - error_message (Text) - failure reason when success is false
        - duration_ms, session_id
        - created_at
        - Add __table_args__ with unique constraint on (timestamp, session_id, prompt_name)
      </action>
      <verify>Model imports and creates table correctly</verify>
      <done>LlmCall model with enhanced fields (prompt_name, error_message)</done>
    </task>

    <task type="auto" priority="1">
      <name>Create GitHub API client module</name>
      <files>packages/telemetry/src/github_client.py</files>
      <action>
        Implement GitHub API client:
        - Accept token from GITHUB_TOKEN or GITHUB_PERSONAL_TOKEN env var
        - List workflow runs for repository with pagination
        - Get run details including duration, run_attempt, event_type
        - Handle API rate limits with exponential backoff
        - Support --since parameter for backfill (default: 30 days ago)
        - Filter to completed runs only (status=completed)
      </action>
      <verify>Client fetches workflow runs from GitHub API with all fields</verify>
      <done>github_client.py with list_workflow_runs() including run_attempt and event_type</done>
    </task>

    <task type="auto" priority="1">
      <name>Create workflow ingestion script</name>
      <files>packages/telemetry/src/ingest_workflows.py</files>
      <action>
        Implement workflow ingestion:
        - Fetch recent workflow runs from GitHub API (last 30 days default)
        - Transform to WorkflowRun models including run_attempt and event_type
        - UPSERT to database using on_conflict_do_update for (github_run_id, run_attempt)
        - Support --since flag for custom date range backfill
        - Add data pruning: delete records older than 6 months at end of run
        - Log ingestion summary (runs fetched, inserted, updated, skipped)
      </action>
      <verify>Script ingests workflows to database without duplicates</verify>
      <done>ingest_workflows.py with UPSERT logic and data pruning</done>
    </task>

    <task type="auto" priority="2">
      <name>Add pnpm scripts for telemetry</name>
      <files>package.json, packages/telemetry/package.json</files>
      <action>
        Add telemetry scripts:
        - telemetry:ingest:github - runs ingest_workflows.py
        - telemetry:ingest:all - runs all ingestion
        - telemetry:status - show counts and latest run dates
        Use poetry run python ... or virtual environment activation
      </action>
      <verify>pnpm run telemetry:ingest:github works with env var</verify>
      <done>Telemetry scripts in package.json with Python env handling</done>
    </task>

    <task type="auto" priority="2">
      <name>Create GitHub Actions cron workflow</name>
      <files>.github/workflows/telemetry.yml</files>
      <action>
        Create scheduled workflow:
        - Runs every 6 hours (cron: '0 */6 * * *')
        - Sets up Python and PostgreSQL
        - Sets GITHUB_TOKEN from secrets (automatic for Actions)
        - Runs ingest_workflows.py
        - Prunes data older than 6 months
      </action>
      <verify>Workflow runs successfully in CI</verify>
      <done>telemetry.yml cron workflow with GITHUB_TOKEN auth</done>
    </task>

    <task type="manual" priority="3">
      <name>Document GitHub API token setup</name>
      <action>
        Update documentation:
        - How to set GITHUB_PERSONAL_TOKEN for local dev
        - Required token scopes (repo, workflow read)
        - Where to set in GitHub Actions (secrets - automatic GITHUB_TOKEN)
        - Hybrid approach: GITHUB_TOKEN in Actions, GITHUB_PERSONAL_TOKEN locally
      </action>
      <verify>Documentation reviewed and merged</verify>
    </task>

  </tasks>
</plan>
