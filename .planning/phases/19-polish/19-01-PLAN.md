---
phase: 19-polish
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/viflo.cjs
  - bin/lib/writers.cjs
autonomous: true
requirements: [INIT-06, INIT-07]

must_haves:
  truths:
    - "Running `viflo init --dry-run --minimal /path` prints every planned file action with its resolved absolute path and exits 0 without touching the filesystem"
    - "Running `viflo init --dry-run --full /path` prints every planned file action with resolved absolute paths and exits 0 without touching the filesystem"
    - "Every real-run file action prints a labelled result (`created`, `updated`, `skipped`, or `merged`) followed by the resolved absolute path"
    - "The `[viflo]` internal skip log in writeIfChanged is removed — no internal log lines appear in real or dry-run output"
  artifacts:
    - path: "bin/viflo.cjs"
      provides: "--dry-run flag handling, unified labelled output with absolute paths for both --minimal and --full modes"
      min_lines: 80
    - path: "bin/lib/writers.cjs"
      provides: "Writer functions return { written, reason, filePath } with reason using canonical labels; internal console.log removed"
  key_links:
    - from: "bin/viflo.cjs"
      to: "bin/lib/writers.cjs"
      via: "writer functions return filePath in result object"
      pattern: "result\\.filePath"
    - from: "bin/viflo.cjs"
      to: "stdout"
      via: "unified formatResult() helper"
      pattern: "(created|updated|skipped|merged)\\s+/"
---

<objective>
Add `--dry-run` flag support and unified labelled output with resolved absolute paths to viflo.cjs and writers.cjs.

Purpose: Users need safe preview mode before committing to file writes, and clear per-file feedback on every real run.
Output: viflo.cjs with --dry-run handling; writers.cjs with canonical result labels and filePath in return values; internal log removed.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/viflo.cjs
@bin/lib/writers.cjs
@bin/lib/paths.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor writers.cjs — canonical labels, filePath in return, remove internal log</name>
  <files>bin/lib/writers.cjs</files>
  <action>
Make three targeted changes to bin/lib/writers.cjs:

1. **Remove internal console.log from writeIfChanged**: Delete the line `console.log('[viflo] skipped (unchanged): ' + filePath);` in the `writeIfChanged` function. This was always an internal log leak; output is the CLI's responsibility.

2. **Add `filePath` to all return objects**: Every writer function must include the resolved absolute `filePath` in its return value so the CLI can display it. Update the returns:
   - `writeIfChanged(filePath, newContent)` → return `{ written, reason, filePath }`
   - `writeCLAUDEmd(targetCwd, sentinelContent)` → passes through the filePath from writeIfChanged return (already has `filePath` local — ensure it's in the forwarded return)
   - `writeSettingsJson(targetCwd, incomingSettings)` → same pass-through
   - `writeCLAUDEmdTemplate(targetCwd, sentinelContent)` → same pass-through; in the branch that falls back to `writeCLAUDEmd`, the filePath is already resolved as `const filePath = resolveTargetPath(targetCwd, 'CLAUDE.md')` — include it
   - `writePlanningScaffold(targetCwd)` → results array items already have `path` (relative); also add `filePath` (absolute) to each item using `resolveTargetPath(targetCwd, stub.relPath)`

3. **Canonical reason labels**: Standardise the `reason` values returned across all writers:
   - `writePlanningScaffold` currently returns `reason: 'skipped (already exists)'` for existing files — change to `reason: 'skipped'`
   - `writeIfChanged` returns `reason: 'created'` or `reason: 'updated'` — keep these (they are already canonical)
   - `writeCLAUDEmd` calls `writeIfChanged` which handles `created`/`updated`; but when CLAUDE.md already exists AND the sentinel is already present and unchanged, `writeIfChanged` returns `reason: 'unchanged'` — rename this to `'skipped'` in `writeIfChanged`'s return: `return { written: false, reason: 'skipped', filePath }`
   - For `writeCLAUDEmd` and `writeCLAUDEmdTemplate`, when a merge/update occurs on an existing file (existingContent !== null and written: true), the CLI needs to know if it was `merged` vs `created`. The current `writeIfChanged` returns `reason: existing === null ? 'created' : 'updated'` — this is sufficient for settings.json but for CLAUDE.md sentinel updates the correct label is `merged`. Handle this at the `writeCLAUDEmd` call site in viflo.cjs (Task 2), NOT in writers.cjs — writers just return `created`/`updated`/`skipped`.

   Final canonical reasons from writers: `'created'`, `'updated'`, `'skipped'` (was unchanged/already-exists). The CLI maps `updated` on CLAUDE.md operations to `merged` when appropriate.
  </action>
  <verify>
    <automated>pnpm --filter=root test:cli 2>&1 | tail -5</automated>
    <manual>Confirm all 45 existing tests still pass — no regressions from internal log removal or return shape changes</manual>
  </verify>
  <done>All 45 tests pass; `writeIfChanged` no longer emits any console.log; every writer returns `{ written, reason, filePath }`; `writePlanningScaffold` results include absolute `filePath`; reason values are `created`/`updated`/`skipped` only.</done>
</task>

<task type="auto">
  <name>Task 2: Add --dry-run flag and unified labelled output to viflo.cjs</name>
  <files>bin/viflo.cjs</files>
  <action>
Refactor bin/viflo.cjs to add `--dry-run` support and unified per-file output with resolved absolute paths.

**1. Parse --dry-run flag** (alongside existing flag parsing):
```js
const hasDryRunFlag = args.includes('--dry-run');
```

**2. Add a shared `printResult(label, absolutePath)` helper** at the top of the core logic section:
```js
function printResult(label, absolutePath) {
  console.log('  ' + label.padEnd(8) + ' ' + absolutePath);
}
```
Label is padded to 8 chars so columns align: `created `, `updated `, `skipped `, `merged  `.

**3. --dry-run mode** — implement a `runDryRun(targetDir)` function that:
- Resolves what each operation WOULD do by inspecting the filesystem (read-only):
  - For `CLAUDE.md`: check `fs.existsSync(path.join(targetDir, 'CLAUDE.md'))` → label `would create` or `would merge`
  - For `.claude/settings.json`: check existence → label `would create` or `would update`
  - For `.planning/` scaffold files (--full only): check each of `PROJECT.md`, `STATE.md`, `ROADMAP.md`, `config.json` → label `would create` or `would skip`
- Prints each file with its resolved absolute path and `[dry-run]` prefix on the label
- Does NOT call any writer functions
- Exits 0

Use this pattern for dry-run labels: `[dry-run] would create`, `[dry-run] would merge`, `[dry-run] would update`, `[dry-run] would skip`.

Print as: `  [dry-run] would create  /abs/path/to/file`

**4. --minimal mode real-run output**: replace the existing `claudeStatus`/`settingsStatus` computation and `console.log('[viflo] CLAUDE.md: ...')` lines with `printResult()` calls using absolute paths from the writer return values:
- `writeCLAUDEmd` returns `{ written, reason, filePath }` — map reason: if `written && existingFile`, use `'merged'`; if `written && !existingFile`, use `'created'`; if `!written`, use `'skipped'`
- Since `writeCLAUDEmd` no longer tells us if the file was new or existing, check `fs.existsSync(claudeFilePath)` BEFORE calling writeCLAUDEmd. Store as `claudeExisted = fs.existsSync(resolveTargetPath(targetDir, 'CLAUDE.md'))`.
- Then: `result.written ? (claudeExisted ? 'merged' : 'created') : 'skipped'`
- For `writeSettingsJson`: `result.written ? (settingsExisted ? 'updated' : 'created') : 'skipped'`

**5. --full mode real-run output**: replace the existing `for (const r of allResults)` loop with `printResult()` calls using absolute paths:
- For `claudeResult`: same `claudeExisted` pre-check logic as --minimal
- For `settingsResult`: same `settingsExisted` pre-check logic
- For `scaffoldResults`: each item now has `filePath` (absolute) from the refactored writers — use `r.filePath` directly; label is `r.reason` (already `created`/`skipped`)

**6. Update validation error message** in the usage stderr prints to also mention `--dry-run`:
```
Usage: viflo init --minimal [--dry-run] [path]
       viflo init --full [--dry-run] [path]
```

**7. Dry-run integration point**: add at the top of each mode block (after flag checks pass):
```js
if (hasDryRunFlag) {
  runDryRun(targetDir, hasFullFlag);
  process.exit(0);
}
```

The `runDryRun(targetDir, isFullMode)` function checks existence of each file that WOULD be written and prints the labelled preview. For CLAUDE.md merge detection: if CLAUDE.md exists, the operation is `would merge`; if not, `would create`. For settings.json: `would create` or `would update`. For scaffold files (full mode): each `would create` or `would skip`.
  </action>
  <verify>
    <automated>pnpm --filter=root test:cli 2>&1 | tail -5</automated>
    <manual>
Run manually to inspect output format:
1. `node bin/viflo.cjs init --minimal --dry-run /tmp/dry-test-dir` (create dir first) — should print `[dry-run]` lines with absolute paths, exit 0, no files created
2. `node bin/viflo.cjs init --full --dry-run /tmp/dry-test-dir` — same, includes planning files
3. `node bin/viflo.cjs init --minimal /tmp/real-test-dir` — should print `  created  /tmp/real-test-dir/CLAUDE.md` etc.
    </manual>
  </verify>
  <done>
- `--dry-run` flag prints preview lines with `[dry-run] would create/merge/update/skip` + absolute path, exits 0, no files written
- Real run output: `  created  /abs/path`, `  updated  /abs/path`, `  skipped  /abs/path`, `  merged   /abs/path`
- No `[viflo]` internal prefixes remain in output
- All 45 existing tests pass
  </done>
</task>

</tasks>

<verification>
Run full CLI test suite: `pnpm --filter=root test:cli`
All 45 tests pass (Phase 17 + 18 tests must not regress).

Smoke test dry-run:
```bash
mkdir /tmp/viflo-dry-test
node bin/viflo.cjs init --minimal --dry-run /tmp/viflo-dry-test
# Expect: [dry-run] lines printed, no files created
ls /tmp/viflo-dry-test  # Expect: empty dir
```
</verification>

<success_criteria>
- `--dry-run` with `--minimal` or `--full`: prints per-file preview with absolute paths, no files written
- Real runs: every file action labelled with `created`/`updated`/`skipped`/`merged` + absolute path
- No `[viflo]` internal log lines in any output
- All 45 existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-polish/19-01-SUMMARY.md`
</output>
