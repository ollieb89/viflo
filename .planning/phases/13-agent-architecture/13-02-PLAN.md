---
phase: 13-agent-architecture
plan: "02"
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - .agent/skills/agent-architecture/references/multi-agent-patterns.md
  - .agent/skills/agent-architecture/references/memory-orchestration.md
autonomous: true
requirements: [AGENT-03, AGENT-04, AGENT-05]

must_haves:
  truths:
    - "references/multi-agent-patterns.md is aligned with LangGraph 1.x patterns shown in SKILL.md (create_react_agent, PostgresSaver, recursion_limit)"
    - "references/memory-orchestration.md is aligned with the episodic memory pgvector pattern shown in SKILL.md (agent_episodes table, embedding_model_version column)"
    - "Both reference files follow the Option A (not recommended) / Option B (recommended) convention established in Phase 12"
  artifacts:
    - path: ".agent/skills/agent-architecture/references/multi-agent-patterns.md"
      provides: "Extended LangGraph 1.x patterns — StateGraph, human-in-the-loop interrupt, PostgresSaver production setup"
      contains: "PostgresSaver"
    - path: ".agent/skills/agent-architecture/references/multi-agent-patterns.md"
      provides: "LangGraph version context"
      contains: "LangGraph 1.x"
    - path: ".agent/skills/agent-architecture/references/memory-orchestration.md"
      provides: "agent_episodes table schema with HNSW index and embedding_model_version column"
      contains: "agent_episodes"
    - path: ".agent/skills/agent-architecture/references/memory-orchestration.md"
      provides: "Cross-reference to RAG skill for HNSW index setup"
      contains: "rag-vector-search"
  key_links:
    - from: ".agent/skills/agent-architecture/references/multi-agent-patterns.md"
      to: ".agent/skills/agent-architecture/SKILL.md"
      via: "Pattern names align — create_react_agent in both"
      pattern: "create_react_agent"
    - from: ".agent/skills/agent-architecture/references/memory-orchestration.md"
      to: ".agent/skills/rag-vector-search/references/embedding-pipelines.md"
      via: "agent_episodes mirrors document_chunks schema"
      pattern: "embedding_model_version"
---

<objective>
Update the two reference files in `.agent/skills/agent-architecture/references/` to align with the rewritten SKILL.md from Plan 01 — promoting LangGraph 1.x patterns and pgvector episodic memory to reference-doc depth, matching the convention established in Phase 12 for `embedding-pipelines.md` and `retrieval-patterns.md`.

Purpose: The reference files currently contain content written before the Phase 13 research. This plan brings them to the same standard: Option A (not recommended) vs Option B (recommended) where relevant, LangGraph 1.x naming, agent_episodes schema with HNSW index, and cross-references to the RAG skill.

Output: Updated `references/multi-agent-patterns.md` and `references/memory-orchestration.md`
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-agent-architecture/13-RESEARCH.md
@.planning/phases/13-agent-architecture/13-01-SUMMARY.md
@.agent/skills/rag-vector-search/references/embedding-pipelines.md
@.agent/skills/rag-vector-search/references/retrieval-patterns.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update references/multi-agent-patterns.md for LangGraph 1.x</name>
  <files>.agent/skills/agent-architecture/references/multi-agent-patterns.md</files>
  <action>
Read the current `references/multi-agent-patterns.md`. Update it to align with LangGraph 1.x patterns from the RESEARCH.md and the SKILL.md written in Plan 01.

**Changes required:**

1. **Version header**: Add a version context note at the top: "LangGraph 1.x (stable since October 2025). `create_react_agent` in `langgraph.prebuilt` is the recommended entry point. LangChain `AgentExecutor` / `initialize_agent()` are deprecated — do not use."

2. **Checkpointing section**: If the file mentions `InMemorySaver`, add a production note: "Use `PostgresSaver` from `langgraph-checkpoint-postgres` in production. `InMemorySaver` loses state on server restart."

3. **Option A / Option B convention** (following Phase 12 retrieval-patterns.md precedent): If the file has multiple pattern alternatives (e.g. `create_react_agent` prebuilt vs custom `StateGraph`), label them:
   - Option A: Custom `StateGraph` (not recommended for most cases — use only when prebuilt is insufficient)
   - Option B: `create_react_agent` from `langgraph.prebuilt` (recommended)

4. **Human-in-the-loop**: If the file covers human-in-the-loop, ensure it references `interrupt()` (LangGraph 1.x API). If absent, add a brief section covering `interrupt()` usage for mid-graph human approval gates.

5. **`recursion_limit`**: Ensure every LangGraph agent invocation example shows `"recursion_limit": MAX_TURNS` in the config dict — same guardrail pattern as the SKILL.md manual loop.

6. **TypeScript note**: Add a note that `@langchain/langgraph` exists for TypeScript but patterns here are Python-only (primary ecosystem).

Do NOT replace the entire file. Make targeted updates that bring it into alignment. Preserve any content that is still accurate. Keep changes surgical — this is a reference doc, not a rewrite.
  </action>
  <verify>
    <automated>
      grep -c "PostgresSaver" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/multi-agent-patterns.md
      grep -c "LangGraph 1" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/multi-agent-patterns.md
      grep -c "create_react_agent" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/multi-agent-patterns.md
      grep -c "recursion_limit" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/multi-agent-patterns.md
    </automated>
    <manual>Confirm the file reads consistently — no contradictions between Option A/B labels and the SKILL.md recommendations.</manual>
  </verify>
  <done>
    `PostgresSaver` appears ≥1 time. "LangGraph 1" appears ≥1 time. `create_react_agent` appears ≥1 time. `recursion_limit` appears ≥1 time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update references/memory-orchestration.md for pgvector episodic memory</name>
  <files>.agent/skills/agent-architecture/references/memory-orchestration.md</files>
  <action>
Read the current `references/memory-orchestration.md`. Update it to align with the pgvector episodic memory pattern from RESEARCH.md and the SKILL.md written in Plan 01.

**Changes required:**

1. **agent_episodes schema**: Add or update the episodic memory database schema. Required columns:
   ```sql
   CREATE TABLE agent_episodes (
     id          BIGSERIAL PRIMARY KEY,
     session_id  TEXT NOT NULL,
     role        TEXT NOT NULL,          -- 'user' or 'assistant'
     content     TEXT NOT NULL,
     embedding   VECTOR(1536),
     embedding_model_version TEXT NOT NULL,  -- e.g. 'text-embedding-3-small-v1'
     created_at  TIMESTAMPTZ DEFAULT NOW()
   );
   -- HNSW index for fast ANN search
   CREATE INDEX ON agent_episodes USING hnsw (embedding vector_cosine_ops);
   ```
   Note: `embedding_model_version` column is mandatory — same pattern as `document_chunks` in the RAG skill. Cross-reference: "See `rag-vector-search` skill for HNSW index tuning (`ef_construction`, `m` parameters) and eval patterns."

2. **store_episode / recall_episodes functions**: If the file contains episodic memory code, update it to use:
   - `pgvector.encode(vector)` (not `JSON.stringify`)
   - `embedding_model_version` filter in the recall query (prevents cross-model result contamination)
   - `1 - (embedding <=> %s) AS score` for cosine similarity score

3. **Memory types overview**: If the file has a memory types section (in-context, episodic, semantic, procedural), ensure it is still accurate. Episodic = stored in pgvector with agent_episodes schema.

4. **Cross-reference**: Ensure a sentence linking to the RAG skill exists: "For full HNSW index setup, chunking strategies, and eval patterns, see the `rag-vector-search` skill."

5. **Option A / Option B convention**: If the file covers alternatives (e.g. in-context window vs external episodic store), label them for consistency with Phase 12 pattern:
   - Option A: In-context memory (simple, not recommended beyond ~20 turns — context overflow risk)
   - Option B: pgvector episodic store (recommended for sessions > 20 turns or cross-session recall)

Do NOT replace the entire file. Make targeted updates. Preserve accurate existing content.
  </action>
  <verify>
    <automated>
      grep -c "agent_episodes" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/memory-orchestration.md
      grep -c "embedding_model_version" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/memory-orchestration.md
      grep -c "rag-vector-search" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/memory-orchestration.md
      grep -c "HNSW\|hnsw" /home/ollie/Development/Tools/viflo/.agent/skills/agent-architecture/references/memory-orchestration.md
    </automated>
    <manual>Confirm agent_episodes schema includes embedding_model_version column and HNSW index. Confirm cross-reference to rag-vector-search skill is present.</manual>
  </verify>
  <done>
    `agent_episodes` appears ≥1 time. `embedding_model_version` appears ≥1 time. `rag-vector-search` appears ≥1 time. HNSW appears ≥1 time.
  </done>
</task>

</tasks>

<verification>
Run all grep checks for both reference files:

```bash
cd /home/ollie/Development/Tools/viflo

# multi-agent-patterns.md
grep -c "PostgresSaver" .agent/skills/agent-architecture/references/multi-agent-patterns.md
grep -c "LangGraph 1" .agent/skills/agent-architecture/references/multi-agent-patterns.md
grep -c "create_react_agent" .agent/skills/agent-architecture/references/multi-agent-patterns.md
grep -c "recursion_limit" .agent/skills/agent-architecture/references/multi-agent-patterns.md

# memory-orchestration.md
grep -c "agent_episodes" .agent/skills/agent-architecture/references/memory-orchestration.md
grep -c "embedding_model_version" .agent/skills/agent-architecture/references/memory-orchestration.md
grep -c "rag-vector-search" .agent/skills/agent-architecture/references/memory-orchestration.md
grep -c "HNSW\|hnsw" .agent/skills/agent-architecture/references/memory-orchestration.md
```

All 8 counts must be ≥1.
</verification>

<success_criteria>
- `references/multi-agent-patterns.md` contains LangGraph 1.x version note, PostgresSaver production guidance, create_react_agent, and recursion_limit in every agent invocation example
- `references/memory-orchestration.md` contains agent_episodes schema with embedding_model_version column and HNSW index, pgvector.encode() usage, and cross-reference to rag-vector-search skill
- Both files follow the Option A / Option B labeling convention from Phase 12
- No contradictions between SKILL.md and the reference files
</success_criteria>

<output>
After completion, create `.planning/phases/13-agent-architecture/13-02-SUMMARY.md` following the summary template at `/home/ollie/.claude/get-shit-done/templates/summary.md`.

Include:
- Grep counts for all 8 verification checks
- Summary of targeted changes made to each reference file
- Any content preserved vs. replaced
- Requirements addressed: AGENT-03, AGENT-04, AGENT-05
</output>
