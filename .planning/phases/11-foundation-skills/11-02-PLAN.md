---
phase: 11-foundation-skills
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .agent/skills/auth-systems/SKILL.md
  - .agent/skills/auth-systems/references/clerk-patterns.md
  - .agent/skills/auth-systems/references/better-auth-patterns.md
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-05
  - AUTH-06

must_haves:
  truths:
    - "Developer can copy the quick-start block and add Clerk sign-up/sign-in/protected routes to a Next.js App Router app without reading external docs"
    - "Better Auth is presented as the self-hosted alternative (not Auth.js); authjs-patterns.md is replaced by better-auth-patterns.md"
    - "Side-by-side middleware comparison shows the Clerk version then the Better Auth equivalent for the protected-route pattern"
    - "Developer can wire GitHub and Google OAuth through both Clerk (Dashboard config) and Better Auth (socialProviders config)"
    - "Developer can access session data in server components, server actions, and API routes via the documented patterns for both Clerk and Better Auth"
    - "Gotchas section documents the App Router cache pitfall (CVE-2025-29927), DAL pattern with cache(), and must use Next.js 15.2.3+"
    - "Developer can set up a Clerk webhook receiver with svix signature verification and svix-id idempotency check"
  artifacts:
    - path: ".agent/skills/auth-systems/SKILL.md"
      provides: "Quick-start + numbered sections (1. Setup, 2. Configuration, 3. Patterns, 4. Gotchas / Pitfalls)"
      min_lines: 100
    - path: ".agent/skills/auth-systems/references/clerk-patterns.md"
      provides: "Full Clerk implementation: middleware, session access, OAuth, webhook handler"
      min_lines: 80
    - path: ".agent/skills/auth-systems/references/better-auth-patterns.md"
      provides: "Full Better Auth implementation: auth.ts config, route handler, middleware, session access, OAuth"
      min_lines: 80
  key_links:
    - from: ".agent/skills/auth-systems/SKILL.md"
      to: ".agent/skills/auth-systems/references/clerk-patterns.md"
      via: "reference link in header callout"
      pattern: "clerk-patterns\\.md"
    - from: ".agent/skills/auth-systems/SKILL.md"
      to: ".agent/skills/auth-systems/references/better-auth-patterns.md"
      via: "reference link in header callout"
      pattern: "better-auth-patterns\\.md"
    - from: ".agent/skills/auth-systems/SKILL.md"
      to: "clerkMiddleware"
      via: "middleware code block in SKILL.md"
      pattern: "clerkMiddleware"
    - from: ".agent/skills/auth-systems/SKILL.md"
      to: "getSessionCookie"
      via: "Better Auth middleware code block in SKILL.md"
      pattern: "getSessionCookie"
    - from: ".agent/skills/auth-systems/SKILL.md"
      to: "cache()"
      via: "DAL pattern in Gotchas section"
      pattern: "import \\{ cache \\}"
---

<objective>
Rewrite the auth-systems skill to v1.2 depth standard: replace Auth.js with Better Auth as the self-hosted path, add a quick-start, numbered sections with side-by-side comparisons, and a dedicated Gotchas section covering the App Router cache pitfall (CVE-2025-29927) and DAL pattern.

Purpose: The existing skill references Auth.js (maintenance-mode since Sept 2025) as the self-hosted alternative and was built to a thinner standard. It needs Better Auth, a quick-start, the side-by-side middleware comparison, session access patterns for both providers, the Clerk webhook implementation, and the App Router cache pitfall documentation.

Output: A complete, shippable auth-systems skill covering Clerk (managed) and Better Auth (self-hosted) for Next.js App Router with TypeScript.
</objective>

<execution_context>
@/home/ollie/.claude/get-shit-done/workflows/execute-plan.md
@/home/ollie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.agent/skills/auth-systems/SKILL.md
@.agent/skills/auth-systems/references/clerk-patterns.md
@.agent/skills/auth-systems/references/authjs-patterns.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SKILL.md with quick-start, numbered sections, and side-by-side Clerk/Better Auth comparison</name>
  <files>.agent/skills/auth-systems/SKILL.md</files>
  <action>
Rewrite `.agent/skills/auth-systems/SKILL.md` in-place. Update the frontmatter description to reflect Better Auth replacing Auth.js. Keep under 500 lines.

**Structure (exact order):**

```
---
name: auth-systems
description: Use when implementing authentication in Next.js App Router applications. Covers Clerk (managed auth — primary path) and Better Auth (self-hosted alternative) with sign-up, sign-in, protected routes via middleware, OAuth providers, session data access in server components/actions/API routes, Clerk webhook lifecycle sync, and the App Router cache-bypass pitfall (CVE-2025-29927).
---

# Auth Systems

> See `references/clerk-patterns.md` for full Clerk implementation details. See `references/better-auth-patterns.md` for full Better Auth implementation details.

## Quick Start

[Minimal Clerk example — add to an existing Next.js App Router app. Show exactly:
1. npm install @clerk/nextjs
2. Add NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY and CLERK_SECRET_KEY to .env.local (from Clerk Dashboard)
3. Wrap layout.tsx with <ClerkProvider>
4. middleware.ts using clerkMiddleware + createRouteMatcher protecting /dashboard
Show the full middleware.ts code block, copy-paste ready. Add a note: "Self-hosting? Jump to Better Auth in section 1."]

## 1. Setup

### Clerk (Managed Auth — Primary Path)

[Installation: npm install @clerk/nextjs svix]
[Env vars: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY — from Clerk Dashboard -> API Keys]
[layout.tsx: wrap children in <ClerkProvider> from @clerk/nextjs]
[Show full layout.tsx code block with ClerkProvider wrapper]

### Better Auth (Self-Hosted Alternative)

[Status note: "Better Auth replaced Auth.js as the recommended self-hosted auth solution in Sept 2025. Auth.js/NextAuth is maintenance-mode — the core team joined Better Auth. Do not use Auth.js for new projects."]
[Installation: npm install better-auth]
[Database: uses raw pg.Pool in quick-start (zero extra deps). Callout: "If you use Prisma, replace Pool with the Better Auth Prisma adapter: npm install @better-auth/prisma"]
[Env vars: DATABASE_URL, BETTER_AUTH_SECRET (generate with: openssl rand -base64 32), GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET]
[lib/auth.ts: full betterAuth() config with database: new Pool({...}), emailAndPassword: {enabled: true}, socialProviders: {github, google}]
[app/api/auth/[...all]/route.ts: toNextJsHandler(auth) — show full file]
[Run schema migration: npx @better-auth/cli generate then npx @better-auth/cli migrate]

## 2. Configuration

### Protected Routes (Side-by-Side)

**Clerk:**
[Full middleware.ts with clerkMiddleware + createRouteMatcher. Show isPublicRoute matching /sign-in(.*), /sign-up(.*), /api/webhooks(.*). Show auth.protect() in the middleware body. Show the full config.matcher block.]

**Better Auth:**
[Show both approaches:]
- Approach A (fast — cookie check, no DB): `getSessionCookie(request)` from `better-auth/cookies` — use for most routes
- Approach B (full session fetch): `auth.api.getSession({ headers: request.headers })` — use when you need user data in middleware
[Note: Use Approach A in middleware + DAL in server components for defence-in-depth. See Gotchas section.]
[Show full middleware.ts for Approach A with redirect to /sign-in]

### OAuth Providers (GitHub, Google)

**Clerk:**
[Configure in Clerk Dashboard -> User & Authentication -> Social Connections. No code changes required. Add callback URL shown in Dashboard. Note: OAuth config is entirely in the Dashboard; zero code.]

**Better Auth:**
[socialProviders config already shown in lib/auth.ts (section 1). Add note: set up GitHub OAuth app at github.com/settings/applications/new with callback URL: {BASE_URL}/api/auth/callback/github. Same for Google at console.cloud.google.com.]

## 3. Patterns

### Session Data: Server Components, Server Actions, API Routes

**Clerk:**
[Show three code blocks:]
- Server component: `const { userId } = await auth()` from `@clerk/nextjs/server` — for access control (no network call). `const user = await currentUser()` — for display data (network call to Clerk API; wrap in cache() if called multiple times).
- Server action: same `auth()` call at top of action
- API route handler: `const { userId } = await auth()` from `@clerk/nextjs/server`
[Note: prefer `auth()` over `currentUser()` for access control — auth() reads from JWT (no network); currentUser() makes an API call]

**Better Auth:**
[Show three code blocks:]
- Server component: `const session = await auth.api.getSession({ headers: await headers() })` from `next/headers`
- Server action: `const session = await auth.api.getSession({ headers: await headers() })`
- API route handler: `const session = await auth.api.getSession({ headers: request.headers })`

### Clerk Webhook Lifecycle Sync (AUTH-06)

[Brief explanation: sync Clerk user events (created, updated, deleted) to your database. Required if you maintain a local User table.]
[Show full webhook handler: app/api/webhooks/clerk/route.ts with:
- import Webhook from svix
- Extract svix-id, svix-timestamp, svix-signature from headers
- new Webhook(CLERK_WEBHOOK_SECRET).verify(body, headers)
- Idempotency: check db.webhookEvent.findUnique({where: {svixId}}) before processing; return 200 if already exists
- Handle user.created (create user in DB), user.updated, user.deleted
- Full TypeScript with WebhookEvent type from @clerk/nextjs/server]
[Setup note: in Clerk Dashboard -> Webhooks -> Add Endpoint, set URL to {PROD_URL}/api/webhooks/clerk, subscribe to user.created, user.updated, user.deleted. Copy Signing Secret to CLERK_WEBHOOK_SECRET env var.]

## 4. Gotchas / Pitfalls

**1. App Router Cache Bypass (CVE-2025-29927) — Middleware Is Not Enough**

[Explain: Next.js App Router can cache React renders. Middleware auth can be bypassed via x-middleware-subrequest header manipulation (patched in Next.js 15.2.3) — but even after patching, cached renders can return stale auth state. Middleware is the first gate, not the only gate.]

[DAL pattern (Data Access Layer) — always re-verify auth in data-fetching functions:]
```typescript
import { cache } from 'react';
import { auth } from '@clerk/nextjs/server'; // or Better Auth equivalent

// React cache() memoizes within a single render pass — one DB call per request
export const getUser = cache(async () => {
  const { userId } = await auth();
  if (!userId) return null;
  return db.user.findUnique({ where: { clerkId: userId } });
});

// In any Server Component:
export default async function DashboardPage() {
  const user = await getUser(); // memoized — called N times, runs once
  if (!user) redirect('/sign-in');
  return <Dashboard user={user} />;
}
```
[Requirement: Next.js 15.2.3+ (patches CVE-2025-29927). Check: npx next --version]
[Warning signs: auth only in middleware, no cache() on getUser, Next.js version below 15.2.3]

**2. Using currentUser() Everywhere in Clerk**
[Each currentUser() call makes a network request to Clerk's API. Use auth() for access control (reads from JWT — no network). Reserve currentUser() for when you need display data. Always wrap in cache() if called in multiple places per render.]

**3. Better Auth Full Session Fetch in Middleware**
[auth.api.getSession() in middleware makes a DB round trip on every request. Use getSessionCookie() (cookie check) for the middleware fast path. Reserve full session fetch for server components that need user data.]

**4. Deprecated: authMiddleware (Clerk)**
[authMiddleware was deprecated in Clerk 5.x and removed in 6.x. Use clerkMiddleware + createRouteMatcher. Warning sign: any import of authMiddleware from @clerk/nextjs.]

**5. Auth.js / NextAuth as Self-Hosted Alternative**
[Auth.js/NextAuth is maintenance-mode as of Sept 2025. The core team joined Better Auth. Do not use Auth.js for new projects. If migrating from Auth.js, see Better Auth migration docs.]
```

Note: The Clerk webhook handler code block in section 3 must be the full working implementation from RESEARCH.md (verified pattern). Do not summarize — the developer should be able to copy-paste it. Include all imports and the full response logic.
  </action>
  <verify>
    <automated>wc -l .agent/skills/auth-systems/SKILL.md && grep -c "clerkMiddleware\|getSessionCookie\|cache()" .agent/skills/auth-systems/SKILL.md && grep "Better Auth\|better-auth" .agent/skills/auth-systems/SKILL.md | wc -l && grep "authjs\|Auth.js\|NextAuth" .agent/skills/auth-systems/SKILL.md | grep -v "maintenance-mode\|migrating\|Deprecated\|do not use\|Auth.js is" | wc -l</automated>
    <manual>Confirm: SKILL.md has Quick Start (Clerk), numbered sections 1-4, side-by-side Clerk/Better Auth middleware in section 2, DAL pattern with cache() in Gotchas section 4, and line count under 500. The description references better-auth-patterns.md (not authjs-patterns.md).</manual>
  </verify>
  <done>SKILL.md references better-auth-patterns.md (not authjs-patterns.md), has a Quick Start showing Clerk setup, sections numbered 1-4, side-by-side protected-route middleware patterns (Clerk and Better Auth), session data access for both providers, Clerk webhook handler, Gotchas section with DAL pattern and CVE-2025-29927 note, and is under 500 lines.</done>
</task>

<task type="auto">
  <name>Task 2: Create better-auth-patterns.md and upgrade clerk-patterns.md</name>
  <files>
    .agent/skills/auth-systems/references/better-auth-patterns.md
    .agent/skills/auth-systems/references/clerk-patterns.md
  </files>
  <action>
**Part A — Create `better-auth-patterns.md` (replaces authjs-patterns.md):**

Create `.agent/skills/auth-systems/references/better-auth-patterns.md` as a complete Better Auth reference. The authjs-patterns.md file should be DELETED (use Write to overwrite with a redirect stub, or delete via bash) — per research, it must be replaced. After creating better-auth-patterns.md, delete or stub authjs-patterns.md with a single line: `# Deprecated — See better-auth-patterns.md\n\nAuth.js/NextAuth is maintenance-mode as of Sept 2025. This file is replaced by \`better-auth-patterns.md\`.`

Content for `better-auth-patterns.md`:

```markdown
# Better Auth Patterns

> Self-hosted auth alternative to Clerk. Better Auth replaced Auth.js as the recommended self-hosted solution (Sept 2025 — Auth.js team joined Better Auth).

## Installation & Setup

### Install
npm install better-auth

### Environment Variables
DATABASE_URL=postgresql://...
BETTER_AUTH_SECRET=<openssl rand -base64 32>
BETTER_AUTH_URL=http://localhost:3000  # production: your domain
GITHUB_CLIENT_ID=...
GITHUB_CLIENT_SECRET=...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...

### lib/auth.ts — Core Config
[Full betterAuth() config with:
- database: new Pool({ connectionString: process.env.DATABASE_URL })
- emailAndPassword: { enabled: true }
- socialProviders: { github: { clientId, clientSecret }, google: { clientId, clientSecret } }
Full TypeScript import, full code block]

### lib/auth-client.ts — Browser Client
[createAuthClient() from 'better-auth/react' — export const authClient]

### app/api/auth/[...all]/route.ts — Route Handler
[toNextJsHandler(auth) from 'better-auth/next-js' — full file]

### Database Migration
[npx @better-auth/cli generate && npx @better-auth/cli migrate]

## Middleware

### Fast Path (Recommended)
[getSessionCookie(request) from 'better-auth/cookies' — full middleware.ts with redirect]

### Full Session Fetch
[auth.api.getSession({ headers: request.headers }) — use only when middleware needs user data]

### matcher config
[Same Next.js matcher config as Clerk — copy from research]

## Session Access

### Server Component
[auth.api.getSession({ headers: await headers() }) — full code block with redirect if !session]

### Server Action
[auth.api.getSession({ headers: await headers() }) — full action example]

### API Route Handler
[auth.api.getSession({ headers: request.headers }) — full code block]

### DAL Pattern (Defence-in-Depth)
[cache() wrapper around auth.api.getSession — matches the framework-level pattern from SKILL.md but with Better Auth API]

## OAuth Providers

### GitHub Setup
1. Create OAuth app: github.com/settings/applications/new
2. Homepage URL: http://localhost:3000 (production: your domain)
3. Authorization callback URL: {BASE_URL}/api/auth/callback/github
4. Copy Client ID and Client Secret to .env.local

### Google Setup
1. Go to console.cloud.google.com -> APIs & Services -> Credentials
2. Create OAuth 2.0 Client ID (Web application)
3. Authorized redirect URI: {BASE_URL}/api/auth/callback/google
4. Copy Client ID and Secret to .env.local

### Adding More Providers
[Note: Better Auth supports many providers. See better-auth.com/docs/authentication/social for the full list. Add to socialProviders in lib/auth.ts.]

## Client-Side Usage

### Sign In / Sign Up
[authClient.signIn.social({ provider: 'github' }) — example]
[authClient.signIn.email({ email, password }) — example]
[authClient.signUp.email({ email, password, name }) — example]

### Sign Out
[authClient.signOut() — example]

### Get Session (Client Component)
[authClient.useSession() hook — returns { data, isPending, error }; show usage in a Client Component]

## Failure Modes

| Scenario | What Happens | How to Handle |
|---|---|---|
| DATABASE_URL not set | Server error on first auth request | Check env vars before first request; Better Auth logs the missing config |
| BETTER_AUTH_SECRET not set or too short | Sessions can be forged | Always use openssl rand -base64 32; never use a predictable secret |
| Migration not run | Table does not exist error on first login | Run npx @better-auth/cli migrate before first request |
| OAuth callback URL mismatch | Provider returns "redirect_uri_mismatch" error | Callback URL in provider dashboard must exactly match {BASE_URL}/api/auth/callback/{provider} |
| Full session fetch in middleware | DB round trip on every request | Use getSessionCookie() fast path in middleware; reserve full fetch for server components |
| Prisma adapter vs raw pg.Pool | Schema table names differ | Use @better-auth/prisma for Prisma projects; do not mix adapters |
```

**Part B — Upgrade `clerk-patterns.md`:**

Read the existing clerk-patterns.md. It already has the core Clerk patterns. Check for:
1. Is the full webhook handler present (svix verification + idempotency)? If not or if incomplete, add it.
2. Is the DAL pattern (`cache()` + `getUser` wrapper) present? If not, add it after the session section.
3. Update the Version Context table to show `@clerk/nextjs 6.x` and note `authMiddleware` is removed.

Add if missing — webhook handler section:

```typescript
// app/api/webhooks/clerk/route.ts
import { Webhook } from 'svix';
import { headers } from 'next/headers';
import { WebhookEvent } from '@clerk/nextjs/server';

export async function POST(req: Request) {
  const WEBHOOK_SECRET = process.env.CLERK_WEBHOOK_SECRET;
  if (!WEBHOOK_SECRET) throw new Error('CLERK_WEBHOOK_SECRET not set');

  const headerPayload = await headers();
  const svixId = headerPayload.get('svix-id');
  const svixTimestamp = headerPayload.get('svix-timestamp');
  const svixSignature = headerPayload.get('svix-signature');

  if (!svixId || !svixTimestamp || !svixSignature) {
    return new Response('Missing svix headers', { status: 400 });
  }

  const body = await req.text();
  let event: WebhookEvent;
  try {
    event = new Webhook(WEBHOOK_SECRET).verify(body, {
      'svix-id': svixId,
      'svix-timestamp': svixTimestamp,
      'svix-signature': svixSignature,
    }) as WebhookEvent;
  } catch {
    return new Response('Invalid signature', { status: 400 });
  }

  // Idempotency: reject duplicate deliveries (store svix-id in DB)
  const existing = await db.webhookEvent.findUnique({ where: { svixId } });
  if (existing) return new Response('Already processed', { status: 200 });
  await db.webhookEvent.create({ data: { svixId } });

  if (event.type === 'user.created') {
    await db.user.create({
      data: {
        clerkId: event.data.id,
        email: event.data.email_addresses[0].email_address,
      },
    });
  }
  if (event.type === 'user.deleted' && event.data.id) {
    await db.user.delete({ where: { clerkId: event.data.id } });
  }

  return new Response('OK');
}
```

Add if missing — DAL pattern section:

```typescript
// lib/dal.ts — Data Access Layer
// Re-verify auth in every data access function (defence-in-depth vs middleware)
import { cache } from 'react';
import { auth } from '@clerk/nextjs/server';
import { db } from '@/lib/db';
import { redirect } from 'next/navigation';

// cache() memoizes within a single render pass — one DB call even if called N times
export const getUser = cache(async () => {
  const { userId } = await auth();
  if (!userId) return null;
  return db.user.findUnique({ where: { clerkId: userId } });
});

// In any Server Component or Server Action:
export default async function DashboardPage() {
  const user = await getUser();
  if (!user) redirect('/sign-in');
  return <Dashboard user={user} />;
}
```

Ensure clerk-patterns.md version context table is present and accurate:
| Library | Last Verified | Notes |
|---|---|---|
| `@clerk/nextjs` | 6.x | `clerkMiddleware` replaces `authMiddleware` (removed in 6.x) |
| `svix` | latest | Required for Clerk webhook verification |
| Next.js | 15.2.3+ | Required — patches CVE-2025-29927 middleware bypass |
  </action>
  <verify>
    <automated>ls .agent/skills/auth-systems/references/ && wc -l .agent/skills/auth-systems/references/better-auth-patterns.md && grep -c "getSessionCookie\|auth.api.getSession\|toNextJsHandler\|betterAuth" .agent/skills/auth-systems/references/better-auth-patterns.md && grep -c "svix\|WebhookEvent\|idempoten" .agent/skills/auth-systems/references/clerk-patterns.md</automated>
    <manual>Confirm: better-auth-patterns.md exists with Better Auth config, middleware, session access, and OAuth sections. clerk-patterns.md has webhook handler with svix verification and idempotency check. authjs-patterns.md is stubbed or deleted.</manual>
  </verify>
  <done>better-auth-patterns.md exists as a complete Better Auth reference (setup, middleware, session access in server components/actions/routes, OAuth provider setup, client-side usage). clerk-patterns.md includes the full webhook handler with svix verification and svix-id idempotency check, and the DAL pattern with cache(). authjs-patterns.md is replaced with a deprecation stub.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls .agent/skills/auth-systems/references/` — must list better-auth-patterns.md and clerk-patterns.md; authjs-patterns.md should be stubbed/empty
2. `wc -l .agent/skills/auth-systems/SKILL.md` — must be under 500 lines
3. `grep "Quick Start" .agent/skills/auth-systems/SKILL.md` — must exist
4. `grep "better-auth-patterns.md" .agent/skills/auth-systems/SKILL.md` — must exist (replacing authjs reference)
5. `grep "getSessionCookie\|auth.api.getSession" .agent/skills/auth-systems/SKILL.md | wc -l` — must be 2+ (Better Auth middleware patterns)
6. `grep "cache()\|import { cache" .agent/skills/auth-systems/SKILL.md | wc -l` — must be 1+ (DAL pattern present)
7. `grep "svix\|WebhookEvent" .agent/skills/auth-systems/references/clerk-patterns.md | wc -l` — must be 3+ (webhook implementation present)
8. `grep "betterAuth\|toNextJsHandler" .agent/skills/auth-systems/references/better-auth-patterns.md | wc -l` — must be 2+
</verification>

<success_criteria>
The auth-systems skill is shippable when:
- SKILL.md opens with a Clerk quick-start (copy-paste ready), numbered sections 1-4, side-by-side protected-route middleware (Clerk and Better Auth), OAuth config for both providers, session access patterns for server components/actions/routes, Clerk webhook handler, and Gotchas section with CVE-2025-29927 + DAL pattern
- better-auth-patterns.md is a complete Better Auth reference replacing authjs-patterns.md
- clerk-patterns.md includes the full webhook handler with svix verification and idempotency
- No remaining references to Auth.js as a recommended new-project choice
- All files combined represent a developer implementing Clerk or Better Auth without external docs
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-skills/11-02-SUMMARY.md` using the summary template.
</output>
