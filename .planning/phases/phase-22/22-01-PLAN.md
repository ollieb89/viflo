<plan phase="22" plan="1">
  <overview>
    <phase_name>Database Ops for Integration</phase_name>
    <goal>Create PostgreSQL migration infrastructure with local and CI integration</goal>
  </overview>

  <dependencies>
    <complete>Phase 21: Test Reliability and Budget Guards</complete>
  </dependencies>

  <tasks>
    <task type="auto" priority="1">
      <name>Create packages/db directory structure</name>
      <files>packages/db/</files>
      <action>
        Set up database package structure:
        - src/models/__init__.py (empty SQLAlchemy models dir)
        - src/migrations/versions/ (Alembic migrations)
        - src/connection.py (database connection/session)
        - tests/integration/ (integration tests)
        - docker-compose.yml (local PostgreSQL)
        - alembic.ini (Alembic configuration)
        - pyproject.toml (Python dependencies)
      </action>
      <verify>Directory structure matches planned layout</verify>
      <done>packages/db/ created with all subdirectories</done>
    </task>

    <task type="auto" priority="1">
      <name>Set up Alembic configuration</name>
      <files>packages/db/alembic.ini, packages/db/src/migrations/env.py</files>
      <action>
        Configure Alembic for PostgreSQL:
        - Database URL from environment (DATABASE_URL)
        - Async-compatible setup (optional but recommended)
        - Migration directory pointing to src/migrations/versions/
        - Logging configured
      </action>
      <verify>alembic --config packages/db/alembic.ini current runs without error</verify>
      <done>Alembic configured with PostgreSQL driver</done>
    </task>

    <task type="auto" priority="1">
      <name>Create initial migration</name>
      <files>packages/db/src/migrations/versions/001_initial.py</files>
      <action>
        Create baseline migration:
        - Create projects table as example (id, name, created_at)
        - Include down migration (drop table)
        - Use UUID primary key (aligns with skill patterns)
      </action>
      <verify>Migration applies cleanly: alembic upgrade head</verify>
      <done>Initial migration creates projects table</done>
    </task>

    <task type="auto" priority="1">
      <name>Create database connection module</name>
      <files>packages/db/src/connection.py</files>
      <action>
        Implement connection management:
        - SQLAlchemy 2.0 engine creation
        - SessionLocal factory
        - get_session() context manager
        - Async support (optional but future-proof)
      </action>
      <verify>Connection module imports without errors</verify>
      <done>connection.py with engine and session factory</done>
    </task>

    <task type="auto" priority="1">
      <name>Create example SQLAlchemy model</name>
      <files>packages/db/src/models/project.py</files>
      <action>
        Implement Project model:
        - UUID primary key
        - name: str (indexed)
        - created_at: datetime
        - __tablename__ = 'projects'
      </action>
      <verify>Model imports and creates table on migration</verify>
      <done>Project model in packages/db/src/models/</done>
    </task>

    <task type="auto" priority="1">
      <name>Set up docker-compose for local PostgreSQL</name>
      <files>packages/db/docker-compose.yml</files>
      <action>
        Create Docker Compose service:
        - postgres:16-alpine image
        - Healthcheck configured
        - Volume for data persistence
        - Environment from .env file
        - Port 5432 exposed
      </action>
      <verify>docker-compose up -d postgres starts successfully</verify>
      <done>docker-compose.yml with PostgreSQL service</done>
    </task>

    <task type="auto" priority="1">
      <name>Add pnpm scripts for database operations</name>
      <files>packages/db/package.json, root package.json</files>
      <action>
        Add workspace scripts:
        - db:up - Start PostgreSQL container
        - db:down - Stop PostgreSQL container
        - db:migrate - Run Alembic migrations
        - db:reset - Reset database (down, up, migrate)
        - db:revision - Create new migration
      </action>
      <verify>pnpm db:up && pnpm db:migrate completes successfully</verify>
      <done>Database scripts in package.json</done>
    </task>

    <task type="auto" priority="2">
      <name>Create integration test</name>
      <files>packages/db/tests/integration/test_migrations.py</files>
      <action>
        Implement migration integration test:
        - Connect to test database
        - Run migrations
        - Verify projects table exists
        - Insert and retrieve test record
      </action>
      <verify>pytest packages/db/tests/integration/ passes</verify>
      <done>Integration test covers connect + migrate + CRUD</done>
    </task>

    <task type="auto" priority="2">
      <name>Update .env.template with database variables</name>
      <files>.env.template</files>
      <action>
        Add database configuration:
        - DATABASE_URL=postgresql://user:pass@localhost:5432/dbname
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=postgres
        - POSTGRES_DB=viflo
      </action>
      <verify>.env.template updated and documented</verify>
      <done>Database environment variables documented</done>
    </task>

    <task type="auto" priority="2">
      <name>Add CI integration job</name>
      <files>.github/workflows/ci.yml</files>
      <action>
        Add integration job to CI workflow:
        - Service: postgres:16-alpine
        - Steps: checkout → setup → install → migrate → test
        - Environment: DATABASE_URL pointing to service
      </action>
      <verify>CI workflow passes with integration job</verify>
      <done>Integration job in CI workflow</done>
    </task>

    <task type="auto" priority="3">
      <name>Create MIGRATIONS.md documentation</name>
      <files>packages/db/MIGRATIONS.md</files>
      <action>
        Document migration workflow:
        - Local setup (docker-compose up)
        - Creating new migrations
        - Running migrations
        - CI integration process
        - Troubleshooting common issues
      </action>
      <verify>Documentation reviewed and accurate</verify>
      <done>MIGRATIONS.md with local and CI workflows</done>
    </task>

  </tasks>
</plan>
