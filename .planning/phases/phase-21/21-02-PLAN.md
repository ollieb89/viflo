<plan phase="21" plan="2">
  <overview>
    <phase_name>LLM Test Budget Guards</phase_name>
    <goal>Implement fail-closed opt-in gating for LLM-assisted tests with low-cost/local profile enforcement</goal>
  </overview>

  <dependencies>
    <complete>Phase 21 Plan 1: Test Reliability Baseline</complete>
  </dependencies>

  <tasks>
    <task type="auto" priority="1">
      <name>Create LLM test gate utility</name>
      <files>apps/web/src/validation/llm-test-gate.ts</files>
      <action>
        Implement evaluateLlmTestGate() function:
        - Default deny when RUN_LLM_TESTS is not set
        - Accept opt-in via RUN_LLM_TESTS=1 or true
        - Require TEST_MODEL_PROFILE (local|budget)
        - Fail closed on invalid profile
        - Return structured decision with reason
      </action>
      <verify>Gate denies by default, allows with valid profile</verify>
      <done>llm-test-gate.ts with strict fail-closed logic</done>
    </task>

    <task type="auto" priority="1">
      <name>Create LLM test gate tests</name>
      <files>apps/web/src/validation/llm-test-gate.test.ts</files>
      <action>
        Implement comprehensive tests for evaluateLlmTestGate():
        - Test default denial (no opt-in)
        - Test opt-in with local profile
        - Test opt-in with budget profile
        - Test denial with missing profile
        - Test denial with unsupported profile
      </action>
      <verify>5 tests pass covering all gate scenarios</verify>
      <done>llm-test-gate.test.ts with 5 test cases</done>
    </task>

    <task type="auto" priority="1">
      <name>Create LLM test runner script</name>
      <files>scripts/run-llm-tests.sh</files>
      <action>
        Create shell script for LLM test execution:
        - Check RUN_LLM_TESTS env var (default: skip gracefully)
        - Validate TEST_MODEL_PROFILE (local|budget only)
        - Print clear error with remediation on invalid config
        - Route to package test:llm script when allowed
      </action>
      <verify>Script exits 0 when disabled, 2 on invalid config</verify>
      <done>run-llm-tests.sh with proper env validation</done>
    </task>

    <task type="auto" priority="1">
      <name>Add package.json test:llm script</name>
      <files>apps/web/package.json</files>
      <action>
        Add test:llm script placeholder:
        - Initially just logs "No LLM tests defined"
        - Ready for future LLM-assisted test suites
        - Protected by run-llm-tests.sh gate
      </action>
      <verify>pnpm run test:llm runs via gate script</verify>
      <done>test:llm script defined and gated</done>
    </task>

    <task type="manual" priority="2">
      <name>Document LLM test opt-in procedure</name>
      <action>
        Update contributor documentation:
        - Add LLM_TESTING.md or section in CONTRIBUTING.md
        - Document RUN_LLM_TESTS=1 requirement
        - Document TEST_MODEL_PROFILE=local|budget requirement
        - Show example commands
      </action>
      <verify>Documentation reviewed and merged</verify>
    </task>

  </tasks>
</plan>
