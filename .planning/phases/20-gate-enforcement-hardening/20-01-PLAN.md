---
phase: 20-gate-enforcement-hardening
plan: "01"
type: execute
mode: standard
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - scripts/quality-gate.sh
  - package.json
  - .planning/phases/20-gate-enforcement-hardening/README-gates.md
autonomous: true
requirements:
  - GATE-01
  - GATE-02

must_haves:
  truths:
    - "CI enforcement runs on both pull_request and push, with push limited to main and release/*, and pull_request triggers covering opened/synchronize/reopened including drafts."
    - "Merge-required status checks remain individual gate checks named lint, typecheck, test, and build; aggregate visibility does not replace individual required gates."
    - "One canonical root command path executes lint/typecheck/test/build in deterministic order, exits non-zero on any failed gate, and emits sectioned plain-text output by gate."
    - "Canonical gate runner supports optional JSON output mode for machine consumers while preserving human-readable default output."
    - "Gate failure output provides concrete next-step commands and never auto-applies fixes."
    - "Skipped checks are documented and configured as non-satisfying for required merge gating."
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "PR and push gate execution policy with individual lint/typecheck/test/build checks and optional aggregate status."
    - path: "scripts/quality-gate.sh"
      provides: "Single source-of-truth gate runner with plain-text sections, optional --json contract, final summary, and non-zero failure exit."
    - path: "package.json"
      provides: "Canonical and per-gate command entrypoints aligned with CI execution path."
    - path: ".planning/phases/20-gate-enforcement-hardening/README-gates.md"
      provides: "Repository-local gate policy note listing required checks and required-check setup guidance."
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "scripts/quality-gate.sh"
      via: "workflow jobs invoke canonical runner with gate-specific mode"
      pattern: "quality-gate\\.sh"
    - from: "package.json"
      to: "scripts/quality-gate.sh"
      via: "quality gate scripts map to canonical runner"
      pattern: "quality-gate"
---

<objective>
Harden repository quality gate enforcement and local parity with one deterministic command path shared by CI and local execution.

Purpose: satisfy GATE-01 and GATE-02 with lockstep CI/local behavior, strict individual required checks, and reproducible output contracts.
Output: updated CI workflow triggers/check jobs, canonical `scripts/quality-gate.sh`, package scripts for canonical/per-gate runs, and explicit gate policy documentation.
</objective>

<execution_context>
@/home/ollie/.config/opencode/agents/gsd-planner.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/20-gate-enforcement-hardening/20-CONTEXT.md
@.planning/phases/20-gate-enforcement-hardening/20-RESEARCH.md
@.github/workflows/ci.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build canonical quality-gate runner with deterministic text and JSON contracts</name>
  <files>scripts/quality-gate.sh, package.json</files>
  <action>
Create `scripts/quality-gate.sh` as the canonical root command path for quality parity.

Implementation requirements:

1. Support full-run mode (default) and optional gate-scoped mode (`--gate lint|typecheck|test|build`) so CI can emit individual required checks while still using one source-of-truth runner.
2. Execute gates in deterministic order: lint -> typecheck -> test -> build for full run.
3. Emit sectioned plain-text output by gate with explicit PASS/FAIL status.
4. Emit final summary section and exit non-zero if any executed gate fails.
5. Add optional `--json` mode with machine-readable structure including: run id/timestamp, executed gates, per-gate status, command, duration_ms, and suggested_command for failures.
6. Add concrete suggested follow-up command per failed gate; do not run any auto-fix command.
7. Keep behavior deterministic: no random ordering, no conditional skip shortcuts, no path-filter-based internal skipping.

Update `package.json` scripts:

- Add one canonical script (for example `quality-gate`) that invokes `scripts/quality-gate.sh`.
- Add per-gate shortcuts (for example `gate:lint`, `gate:typecheck`, `gate:test`, `gate:build`) mapped through canonical runner.

The canonical script is the only documented source of truth; shortcuts are iteration helpers.
</action>
<verify>
<automated>bash scripts/quality-gate.sh && bash scripts/quality-gate.sh --json >/tmp/quality-gate.json && jq -e '.gates | length > 0' /tmp/quality-gate.json</automated>
<manual>Intentionally fail one gate locally (for example lint) and confirm final exit code is non-zero, failure section is shown, and output only suggests commands without auto-fixing.</manual>
</verify>
<done>Canonical quality-gate command is implemented, deterministic, sectioned, has optional JSON mode, and fails closed on any gate failure.</done>
</task>

<task type="auto">
  <name>Task 2: Rework CI triggers and jobs to enforce individual required checks on PR and push policy</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Update CI workflow to match locked trigger and enforcement policy exactly.

Trigger policy:

1. `pull_request` includes types `opened`, `synchronize`, `reopened` and runs for target branches `main` and `release/*`.
2. PR checks run for draft PRs (informative at draft stage; merge enforcement is handled by required checks/rules when PR is Ready for review).
3. `push` runs only on `main` and `release/*`.
4. Include `merge_group` trigger if repository uses merge queue to keep required checks deterministic during queue merges.

Gate job policy:

1. Ensure independent required-check jobs exist for `lint`, `typecheck`, `test`, and `build`.
2. Each required-check job executes canonical runner in gate mode (not duplicated command logic).
3. Optional aggregate/summary job is allowed for visibility but must not be named/used as a replacement required check.
4. Remove/avoid trigger filters or conditionals that cause required gate jobs to be skipped as a normal success path.

Enforcement note:
Document in workflow comments that merge blocking is keyed to individual required checks and skipped checks do not satisfy gate requirements by default.
</action>
<verify>
<automated>yq '.on' .github/workflows/ci.yml && yq '.jobs | keys' .github/workflows/ci.yml | rg 'lint|typecheck|test|build'</automated>
<manual>Open a draft PR touching trivial files and verify lint/typecheck/test/build jobs run and report status; after marking Ready for review, required checks remain the merge gate.</manual>
</verify>
<done>CI workflow enforces PR+push policy and preserves merge-blocking via individual lint/typecheck/test/build checks.</done>
</task>

<task type="auto">
  <name>Task 3: Add gate-policy implementation note for required-check setup and local parity usage</name>
  <files>.planning/phases/20-gate-enforcement-hardening/README-gates.md</files>
  <action>
Create `.planning/phases/20-gate-enforcement-hardening/README-gates.md` with explicit policy and operator instructions:
1. List canonical local command and per-gate shortcuts.
2. List exact required check names to configure in branch protection/rulesets: `lint`, `typecheck`, `test`, `build`.
3. State that aggregate status is visibility-only and cannot replace individual required checks.
4. State that skipped checks do not satisfy required merge gates by default.
5. Include note that `hotfix/*` should follow `release/*` push policy if introduced later.

This file is phase-local implementation guidance so executors can verify deterministic enforcement configuration without ambiguity.
</action>
<verify>
<automated>rg -n 'lint|typecheck|test|build|skipped checks|aggregate' .planning/phases/20-gate-enforcement-hardening/README-gates.md</automated>
<manual>Cross-check the documented required check names against actual CI job names and ensure 1:1 alignment.</manual>
</verify>
<done>Required-check configuration guidance is explicit, aligned to workflow job names, and deterministic for maintainers.</done>
</task>

</tasks>

<verification>
Run from repo root:

```bash
pnpm run quality-gate
pnpm run gate:lint
pnpm run gate:typecheck
pnpm run gate:test
pnpm run gate:build
bash scripts/quality-gate.sh --json | jq '.'
```

Validate CI workflow shape:

```bash
yq '.on' .github/workflows/ci.yml
yq '.jobs | keys' .github/workflows/ci.yml
```

Expected:

- Canonical local parity command and per-gate shortcuts execute through one script.
- Full run exits non-zero when any gate fails.
- CI has distinct lint/typecheck/test/build jobs with PR+push trigger policy as locked.
  </verification>

<success_criteria>

- GATE-01 and GATE-02 implementation artifacts exist and are internally consistent.
- Required-check jobs are individual and stable; aggregate status does not replace them.
- Local parity is deterministic, reproducible, and machine-consumable.
  </success_criteria>

<output>
After execution, create `.planning/phases/20-gate-enforcement-hardening/20-01-SUMMARY.md`.
</output>
