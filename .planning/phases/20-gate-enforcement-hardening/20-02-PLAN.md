---
phase: 20-gate-enforcement-hardening
plan: "02"
type: execute
mode: standard
wave: 2
depends_on:
  - "20-01"
files_modified:
  - .github/workflows/ci-override-audit.yml
  - .github/pull_request_template.md
  - scripts/verify-ci-override.sh
  - scripts/setup-dev.sh
  - scripts/setup-security-hooks.sh
  - scripts/quality-gate.sh
  - .pre-commit-config.yaml
  - CODEOWNERS
  - README.md
  - CONTRIBUTING.md
autonomous: true
requirements:
  - GATE-01
  - SEC-01
  - SEC-02

must_haves:
  truths:
    - "Override path uses one label (`ci-override`) and is restricted to an authorized team, with mandatory PR audit evidence: reason, scope (gate + skip/fail), tracking link, expiry, and approver evidence."
    - "Override implementation does not introduce per-gate labels and allows override label persistence through merge when audit evidence is complete."
    - "Pre-commit secret scanning blocks commits immediately for all contributors when gitleaks or detect-secrets findings exist."
    - "Baseline/allowlist files are protected by CODEOWNERS and require auditable PR rationale for changes."
    - "Security hook setup has auto-attempt and explicit rerun command path; setup failures continue onboarding with loud actionable warning and exact remediation command."
    - "Hook drift/version mismatch is auto-refreshed during setup and reported by parity command on each run."
    - "Canonical setup instructions are present in both README and CONTRIBUTING with cross-links."
  artifacts:
    - path: ".github/workflows/ci-override-audit.yml"
      provides: "Audited override validation workflow keyed to ci-override label and required evidence fields."
    - path: ".github/pull_request_template.md"
      provides: "Required override evidence structure and checklist for audit completeness."
    - path: "scripts/verify-ci-override.sh"
      provides: "Automated validation of override scope/evidence and authorized actor/team constraints."
    - path: "scripts/setup-security-hooks.sh"
      provides: "Deterministic install/refresh command for pre-commit hooks and hook drift remediation."
    - path: "scripts/setup-dev.sh"
      provides: "Auto-attempt hook install/refresh with fail-open onboarding warning and remediation output."
    - path: "scripts/quality-gate.sh"
      provides: "Parity-time hook drift check/report before running quality gates."
    - path: "CODEOWNERS"
      provides: "Security/maintainer ownership rules for baseline/allowlist files."
    - path: "README.md"
      provides: "Canonical hook setup guidance and cross-link to CONTRIBUTING."
    - path: "CONTRIBUTING.md"
      provides: "Contributor-level setup/recovery details and cross-link to README."
  key_links:
    - from: ".github/workflows/ci-override-audit.yml"
      to: "scripts/verify-ci-override.sh"
      via: "workflow executes override audit validator"
      pattern: "verify-ci-override\\.sh"
    - from: "scripts/setup-dev.sh"
      to: "scripts/setup-security-hooks.sh"
      via: "onboarding invokes deterministic hook setup/refresh path"
      pattern: "setup-security-hooks\\.sh"
    - from: "scripts/quality-gate.sh"
      to: "scripts/setup-security-hooks.sh"
      via: "drift check references same install target/version expectations"
      pattern: "pre-commit"
---

<objective>
Complete Phase 20 hardening by enforcing audited override policy, strict secret-scan blocking, and reproducible hook bootstrap/refresh with documented local remediation.

Purpose: satisfy SEC-01 and SEC-02 and finish locked enforcement/audit decisions without adding deferred scope.
Output: override audit workflow and validation script, hardened hook setup/refresh behavior, drift checks in parity path, CODEOWNERS guardrails, and cross-linked setup docs.
</objective>

<execution_context>
@/home/ollie/.config/opencode/agents/gsd-planner.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/20-gate-enforcement-hardening/20-CONTEXT.md
@.planning/phases/20-gate-enforcement-hardening/20-RESEARCH.md
@.planning/phases/20-gate-enforcement-hardening/20-01-PLAN.md
@.pre-commit-config.yaml
@scripts/setup-dev.sh
@README.md
@CONTRIBUTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement audited ci-override policy with authorized-team enforcement</name>
  <files>.github/workflows/ci-override-audit.yml, scripts/verify-ci-override.sh, .github/pull_request_template.md</files>
  <action>
Implement locked override policy using one label (`ci-override`) and auditable evidence fields.

Required implementation:

1. Add `.github/workflows/ci-override-audit.yml` that runs on PR label changes and PR updates, and validates override evidence only when `ci-override` is present.
2. Add `scripts/verify-ci-override.sh` to validate:
   - label name is exactly `ci-override`;
   - override scope is declared and includes gate(s) (`lint|typecheck|test|build`) and condition (`skip|fail`);
   - evidence fields exist in PR body/comment/checklist: reason, scope, tracking link, expiry, approver evidence;
   - label applier/approver belongs to configured authorized team (for example `maintainers` or `release-managers`).
3. Update `.github/pull_request_template.md` with fixed override evidence section/checklist for the mandatory fields.
4. Do not add per-gate override labels (deferred/out of scope).
5. Keep override label persistence through merge allowed when required evidence is complete.

If team membership checks require GitHub API calls, use workflow token permissions required for read-only org/team membership checks and fail closed when verification cannot confirm authorization.
</action>
<verify>
<automated>bash scripts/verify-ci-override.sh --help && yq '.on' .github/workflows/ci-override-audit.yml && rg -n 'ci-override|reason|scope|tracking|expiry|approver' .github/pull_request_template.md</automated>
<manual>Create a PR with `ci-override` and incomplete evidence; confirm override-audit check fails. Add complete evidence + authorized applier and confirm check passes.</manual>
</verify>
<done>Override policy is implemented with one label, authorized-team restriction, mandatory audit evidence, and fail-closed validation behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Harden pre-commit secret enforcement and deterministic hook bootstrap/refresh</name>
  <files>.pre-commit-config.yaml, scripts/setup-security-hooks.sh, scripts/setup-dev.sh, scripts/quality-gate.sh</files>
  <action>
Enforce immediate blocking secret scanning and deterministic hook lifecycle.

Implementation requirements:

1. Keep/enforce `.pre-commit-config.yaml` with `gitleaks` and `detect-secrets --baseline .secrets.baseline` as hard-blocking hooks for all contributors; no first-commit bypass path.
2. Add `scripts/setup-security-hooks.sh` as explicit rerun command that:
   - installs pre-commit hooks;
   - installs hook environments;
   - refreshes/reinstalls on drift/version mismatch;
   - returns clear exit codes for success/failure.
3. Update `scripts/setup-dev.sh` to auto-attempt hook setup via `scripts/setup-security-hooks.sh`; if it fails, continue onboarding with loud warning that commits/PRs will fail CI until hooks are installed, plus exact remediation command/docs pointer.
4. Update `scripts/quality-gate.sh` (from 20-01) to check hook drift on each run and report drift details with remediation command (no auto-fix in parity path).
5. Keep remediation deterministic and explicit; no silent skips.

Drift check can validate hook presence and pre-commit hook metadata/version compatibility; report mismatch details directly in output.
</action>
<verify>
<automated>bash scripts/setup-security-hooks.sh && pre-commit run detect-secrets --all-files && pre-commit run gitleaks --all-files</automated>
<manual>Break local hook state intentionally (remove `.git/hooks/pre-commit`), run `pnpm run quality-gate`, and confirm drift is reported with exact rerun command. Confirm setup-dev warning path appears when setup command fails.</manual>
</verify>
<done>Secret scans hard-block, setup has auto-attempt + explicit rerun path, setup failures are loudly actionable, and parity run reports hook drift every time.</done>
</task>

<task type="auto">
  <name>Task 3: Lock baseline ownership and document canonical security setup in README + CONTRIBUTING</name>
  <files>CODEOWNERS, README.md, CONTRIBUTING.md</files>
  <action>
Implement ownership and docs requirements for reproducible contributor setup.

1. Update `CODEOWNERS` so baseline/allowlist artifacts (at minimum `.secrets.baseline` and `.gitleaks.toml`) are owned by security/maintainer owners.
2. In `README.md`, add canonical setup section that references auto-attempt onboarding and explicit rerun command.
3. In `CONTRIBUTING.md`, add detailed troubleshooting for hook failures/drift with exact commands and explain that CI will fail until hooks are installed.
4. Cross-link README and CONTRIBUTING sections bidirectionally.
5. Document false-positive handling policy: allowlist/baseline updates require auditable PR rationale and standard CODEOWNERS review (no special override team routing).
   </action>
   <verify>
   <automated>rg -n '\\.secrets\\.baseline|\\.gitleaks\\.toml' CODEOWNERS && rg -n 'setup-security-hooks|quality-gate|CI will fail|CONTRIBUTING|README' README.md CONTRIBUTING.md</automated>
   <manual>Follow docs from a clean clone and confirm one command path for setup + one explicit rerun path are discoverable without guessing.</manual>
   </verify>
   <done>Baseline ownership and contributor docs are aligned with locked security behavior and reproducible local setup constraints.</done>
   </task>

</tasks>

<verification>
Run from repo root:

```bash
bash scripts/setup-security-hooks.sh
pnpm run quality-gate
pre-commit run --all-files
yq '.on' .github/workflows/ci-override-audit.yml
```

Manual PR checks:

1. Apply `ci-override` without required evidence -> override audit fails.
2. Add complete evidence and authorized approver path -> override audit passes.
3. Confirm lint/typecheck/test/build required checks remain the merge gates.

Expected:

- Security hooks are reproducible and enforce immediate blocking.
- Override behavior is audited, authorized, and explicit.
- Docs and ownership constraints prevent silent weakening of secret-scan policy.
  </verification>

<success_criteria>

- SEC-01 and SEC-02 are fully implemented and tied into deterministic local/CI workflows.
- Override path is explicit, auditable, and constrained to authorized team operations.
- Repository-level quality/security gate posture is deterministic, active, and reproducible locally.
  </success_criteria>

<output>
After execution, create `.planning/phases/20-gate-enforcement-hardening/20-02-SUMMARY.md`.
</output>
