---
phase: 21-test-reliability-and-budget-guards
plan: "01"
type: execute
mode: standard
wave: 1
depends_on: []
files_modified:
  - package.json
  - scripts/quality-gate.sh
  - .github/workflows/ci.yml
  - apps/web/package.json
  - apps/web/scripts/coverage-ratchet.ts
  - apps/web/src/live/coverage-ratchet.test.ts
autonomous: true
requirements:
  - TEST-01
  - TEST-02
  - TEST-03

must_haves:
  truths:
    - "The canonical test gate path used by CI and local parity executes `apps/web` Vitest reliably and deterministically from one shared command flow."
    - "At least five baseline `apps/web` unit tests for core components/utilities remain green in CI-path execution."
    - "Coverage ratchet is enforced in merge-gating CI path and fails closed on baseline regressions."
    - "Coverage baseline is explicit and version-controlled (`apps/web/.coverage/baseline.json`), with intentional update flow only."
    - "Any flaky test found in this phase (especially coverage-ratchet live path) is stabilized or replaced before phase completion."
  artifacts:
    - path: "scripts/quality-gate.sh"
      provides: "Single source-of-truth test gate execution path for CI/local parity."
    - path: "package.json"
      provides: "Canonical root scripts that route test gate through deterministic CI-equivalent path."
    - path: ".github/workflows/ci.yml"
      provides: "CI test job wired to canonical gate path that includes coverage regression enforcement."
    - path: "apps/web/scripts/coverage-ratchet.ts"
      provides: "Coverage regression guard that fails on drop below locked baseline."
    - path: "apps/web/src/live/coverage-ratchet.test.ts"
      provides: "Deterministic tests validating ratchet behavior without environment-dependent runner flake."
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "scripts/quality-gate.sh"
      via: "test job invokes canonical gate runner"
      pattern: "quality-gate\\.sh --gate test"
    - from: "scripts/quality-gate.sh"
      to: "package.json"
      via: "test gate command maps to canonical root test entrypoint"
      pattern: "pnpm run"
    - from: "package.json"
      to: "apps/web/package.json"
      via: "root scripts delegate to workspace web test + coverage commands"
      pattern: "@viflo/web"
---

<objective>
Lock in reliable, measurable `apps/web` test enforcement by making CI/local test parity deterministic and coverage-regression blocking part of the required gate path.

Purpose: satisfy TEST-01, TEST-02, and TEST-03 using existing Vitest + ratchet stack with stronger execution reliability.
Output: canonical test gate wiring updates, CI enforcement alignment, and stabilized coverage-ratchet test execution.
</objective>

<execution_context>
@/home/ollie/.config/opencode/agents/gsd-planner.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-test-reliability-and-budget-guards/21-CONTEXT.md
@.planning/phases/21-test-reliability-and-budget-guards/21-RESEARCH.md
@package.json
@scripts/quality-gate.sh
@.github/workflows/ci.yml
@apps/web/package.json
@apps/web/scripts/coverage-ratchet.ts
@apps/web/src/live/coverage-ratchet.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route canonical test gate through CI-equivalent test+coverage-ratchet command path</name>
  <files>package.json, scripts/quality-gate.sh, apps/web/package.json</files>
  <action>
Update root and web scripts so the `test` gate path enforces unit tests plus coverage ratchet with one deterministic invocation chain.

Implementation requirements:

1. Define a dedicated root script for CI-equivalent web test enforcement (for example `test:web:ci`) that runs:
   - `pnpm --filter @viflo/web run test`
   - `pnpm --filter @viflo/web run test:coverage:ratchet`
2. Point canonical test-gate execution in `scripts/quality-gate.sh` to this CI-equivalent root script for `test` gate mode.
3. Keep fast local iteration commands available (for example existing raw `apps/web` `test` and `test:watch`) without weakening gate path.
4. Preserve deterministic output and non-zero failure behavior from `scripts/quality-gate.sh`.
5. Ensure no LLM-assisted path is included in default test gate flow.
   </action>
   <verify>
   <automated>bash scripts/quality-gate.sh --gate test --json | tee /tmp/phase21-gate-test.json >/dev/null && jq -e '.executed_gates == ["test"]' /tmp/phase21-gate-test.json</automated>
   <manual>Run `pnpm run gate:test` and confirm output includes test-gate section and fails if either unit tests or ratchet check fails.</manual>
   </verify>
   <done>Canonical test gate path is deterministic and enforces both test execution and coverage ratchet via shared root command wiring.</done>
   </task>

<task type="auto">
  <name>Task 2: Enforce coverage regression in required CI test gate with clear failure contract</name>
  <files>.github/workflows/ci.yml, apps/web/scripts/coverage-ratchet.ts</files>
  <action>
Ensure required CI `test` check explicitly enforces ratchet behavior in the same command path used locally.

Implementation requirements:

1. Keep CI `test` job invoking canonical gate runner (`bash scripts/quality-gate.sh --gate test`), now including ratchet via Task 1 wiring.
2. Add/retain workflow comments clarifying test gate includes coverage regression enforcement and is required for merge protection.
3. Keep ratchet fail-closed behavior in CI when baseline is missing or regressed.
4. Keep update flow explicit (`test:coverage:update`) and never auto-update baseline in check mode.
5. Ensure failure messages remain actionable (show expected baseline and remediation command).
   </action>
   <verify>
   <automated>rg -n 'Run test gate|quality-gate\\.sh --gate test' .github/workflows/ci.yml && cd apps/web && pnpm run test:coverage:ratchet</automated>
   <manual>Temporarily lower coverage in a local branch and confirm `pnpm run gate:test` exits non-zero with ratchet regression message.</manual>
   </verify>
   <done>Coverage regression is enforced by the merge-gating test path and baseline updates remain intentional/reviewable.</done>
   </task>

<task type="auto">
  <name>Task 3: Stabilize coverage-ratchet live test runner behavior to remove environment-dependent flake</name>
  <files>apps/web/src/live/coverage-ratchet.test.ts</files>
  <action>
Refactor coverage-ratchet live test execution so it does not rely on temp-directory `npx` resolution that can hang or behave nondeterministically in CI/non-interactive shells.

Implementation requirements:

1. Replace direct `execFileSync('npx', ['tsx', ...])` with a deterministic invocation strategy tied to repository-installed tooling.
2. Keep test coverage of existing behaviors:
   - baseline auto-create locally when missing;
   - fail in CI when baseline missing;
   - no auto-update on improved coverage in check mode.
3. Keep tests isolated with temp directories and cleanup.
4. Preserve fast runtime for live suite and avoid network or package-install side effects.
   </action>
   <verify>
   <automated>pnpm --filter @viflo/web run test src/live/coverage-ratchet.test.ts</automated>
   <manual>Run the same test twice in a row and confirm deterministic pass/fail behavior with no process hang.</manual>
   </verify>
   <done>`coverage-ratchet.test.ts` executes deterministically without temp-dir tool resolution flake and preserves prior behavioral assertions.</done>
   </task>

</tasks>

<verification>
Run from repo root:

```bash
pnpm run gate:test
bash scripts/quality-gate.sh --gate test --json
pnpm --filter @viflo/web run test
pnpm --filter @viflo/web run test:coverage:ratchet
pnpm --filter @viflo/web run test src/live/coverage-ratchet.test.ts
```

Expected:

- `gate:test` covers both unit tests and coverage ratchet through one canonical path.
- Coverage regression fails gate path with clear remediation message.
- `apps/web` baseline test suite remains green and includes at least five unit tests.
- Coverage-ratchet live test no longer depends on flaky temp-dir `npx` resolution.
  </verification>

<success_criteria>

- TEST-01/TEST-02/TEST-03 artifacts are implemented and internally consistent.
- Required CI test check and local gate:test path remain parity-aligned and deterministic.
- Coverage baseline enforcement is active and fail-closed in CI-equivalent execution.
- Known reliability flake in coverage-ratchet live test is removed.
  </success_criteria>

<output>
After execution, create `.planning/phases/21-test-reliability-and-budget-guards/21-01-SUMMARY.md`.
</output>
