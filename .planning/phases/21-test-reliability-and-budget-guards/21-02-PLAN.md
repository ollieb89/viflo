---
phase: 21-test-reliability-and-budget-guards
plan: "02"
type: execute
mode: standard
wave: 2
depends_on:
  - "21-01"
files_modified:
  - scripts/run-llm-tests.sh
  - package.json
  - apps/web/package.json
  - apps/web/src/validation/llm-test-gate.ts
  - apps/web/src/validation/llm-test-gate.test.ts
  - README.md
  - CONTRIBUTING.md
autonomous: true
requirements:
  - COST-01
  - TEST-01

must_haves:
  truths:
    - "LLM-assisted test paths are disabled by default and never run as part of canonical `test` or `gate:test` commands."
    - "Enabling LLM-assisted tests requires explicit runtime opt-in and approved low-cost/local profile selection."
    - "Guard logic fails closed when opt-in constraints are missing or invalid."
    - "LLM test policy is executable and test-covered (unit tests for policy validation and script path behavior)."
    - "Contributor docs clearly describe default-off behavior, explicit opt-in command, and allowed profiles."
  artifacts:
    - path: "scripts/run-llm-tests.sh"
      provides: "Fail-closed runtime guard wrapper for optional LLM-assisted test execution."
    - path: "apps/web/src/validation/llm-test-gate.ts"
      provides: "Deterministic policy validation for opt-in/profile constraints."
    - path: "apps/web/src/validation/llm-test-gate.test.ts"
      provides: "Unit tests covering allow/deny policy scenarios."
    - path: "package.json"
      provides: "Explicit command surface separating default test path from opt-in LLM test path."
    - path: "README.md"
      provides: "Top-level operator guidance for default-off and opt-in usage."
    - path: "CONTRIBUTING.md"
      provides: "Contributor troubleshooting and expected fail-closed behavior for LLM test guard."
  key_links:
    - from: "package.json"
      to: "scripts/run-llm-tests.sh"
      via: "opt-in command delegates to fail-closed guard wrapper"
      pattern: "run-llm-tests\\.sh"
    - from: "scripts/run-llm-tests.sh"
      to: "apps/web/src/validation/llm-test-gate.ts"
      via: "guard script enforces the same policy contract validated by unit tests"
      pattern: "local|budget"
    - from: "README.md"
      to: "CONTRIBUTING.md"
      via: "cross-linked LLM test policy and troubleshooting guidance"
      pattern: "LLM"
---

<objective>
Implement explicit budget-safe controls for optional LLM-assisted test paths, keeping default reliability gates deterministic and cost-free.

Purpose: satisfy COST-01 while preserving TEST-01 parity behavior from Plan 21-01.
Output: fail-closed opt-in guard command, policy unit tests, and clear contributor documentation.
</objective>

<execution_context>
@/home/ollie/.config/opencode/agents/gsd-planner.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-test-reliability-and-budget-guards/21-CONTEXT.md
@.planning/phases/21-test-reliability-and-budget-guards/21-RESEARCH.md
@.planning/phases/21-test-reliability-and-budget-guards/21-01-PLAN.md
@package.json
@apps/web/package.json
@README.md
@CONTRIBUTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fail-closed LLM test guard wrapper and explicit opt-in command surface</name>
  <files>scripts/run-llm-tests.sh, package.json, apps/web/package.json</files>
  <action>
Create an explicit wrapper command for optional LLM-assisted tests that is off by default and constrained to low-cost/local profiles.

Implementation requirements:

1. Add `scripts/run-llm-tests.sh` with strict shell mode (`set -euo pipefail`).
2. Guard contract:
   - If explicit opt-in flag/env is absent, do not run LLM tests and exit with actionable message.
   - If opt-in is present, require profile env value in approved set (for example `local` or `budget`).
   - Invalid/missing profile in opt-in mode must fail closed with non-zero exit and clear remediation.
3. Add root script alias (for example `test:llm`) that routes through guard wrapper.
4. Add/retain workspace script target invoked by wrapper (for example `@viflo/web test:llm`) while keeping it absent from default `test` and `gate:test` paths.
5. Ensure no premium/default-on model mode is reachable through this command path.
   </action>
   <verify>
   <automated>bash scripts/run-llm-tests.sh || true && RUN_LLM_TESTS=1 TEST_MODEL_PROFILE=invalid bash scripts/run-llm-tests.sh; test $? -ne 0</automated>
   <manual>Run `pnpm run test` and `pnpm run gate:test` to confirm they do not invoke LLM guard path by default.</manual>
   </verify>
   <done>LLM-assisted test path is explicit opt-in only, profile-constrained, and fail-closed when constraints are not met.</done>
   </task>

<task type="auto">
  <name>Task 2: Add unit-tested policy module for LLM test gate validation</name>
  <files>apps/web/src/validation/llm-test-gate.ts, apps/web/src/validation/llm-test-gate.test.ts</files>
  <action>
Implement reusable validation logic so LLM test gating rules are testable and shared between script/runtime integrations.

Implementation requirements:

1. Create policy module that evaluates runtime inputs (opt-in flag, requested profile) and returns structured decision:
   - `allowed` boolean
   - `reason`/`error` message
   - normalized profile when allowed
2. Cover test cases at minimum:
   - default mode (no opt-in) -> disallowed with explicit default-off message
   - opt-in + approved `local` profile -> allowed
   - opt-in + approved `budget` profile -> allowed
   - opt-in + missing profile -> denied
   - opt-in + unsupported profile (`premium`, empty, arbitrary) -> denied
3. Keep policy deterministic and independent from network/model providers.
4. Ensure test naming clearly communicates guard semantics for future maintainers.
   </action>
   <verify>
   <automated>pnpm --filter @viflo/web run test src/validation/llm-test-gate.test.ts</automated>
   <manual>Review test file and confirm policy scenarios map exactly to CONTEXT.md locked decision: default off + explicit low-cost/local opt-in only.</manual>
   </verify>
   <done>LLM test gating policy is codified and unit-tested with fail-closed semantics.</done>
   </task>

<task type="auto">
  <name>Task 3: Document LLM test budget policy and usage in README + CONTRIBUTING</name>
  <files>README.md, CONTRIBUTING.md</files>
  <action>
Add concise docs so contributors understand default behavior, opt-in path, and failure remediation.

Documentation requirements:

1. README includes:
   - default-off statement for LLM-assisted tests;
   - explicit opt-in command example;
   - allowed profile values (`local`, `budget`);
   - note that standard CI/local quality gates remain non-LLM.
2. CONTRIBUTING includes:
   - troubleshooting for guard failures (missing opt-in, invalid profile);
   - explicit env vars/flags required to run LLM tests intentionally;
   - reminder that unsupported profiles fail closed by design.
3. Cross-link README and CONTRIBUTING sections for discoverability.
   </action>
   <verify>
   <automated>rg -n 'LLM|test:llm|RUN_LLM_TESTS|TEST_MODEL_PROFILE|local|budget' README.md CONTRIBUTING.md</automated>
   <manual>Follow docs from a fresh shell and confirm it is obvious how default tests differ from optional LLM-assisted tests.</manual>
   </verify>
   <done>Budget-control policy is documented, actionable, and aligned with default-off + explicit low-cost/local opt-in behavior.</done>
   </task>

</tasks>

<verification>
Run from repo root:

```bash
pnpm run test
pnpm run gate:test
bash scripts/run-llm-tests.sh || true
RUN_LLM_TESTS=1 TEST_MODEL_PROFILE=local bash scripts/run-llm-tests.sh
RUN_LLM_TESTS=1 TEST_MODEL_PROFILE=premium bash scripts/run-llm-tests.sh; test $? -ne 0
pnpm --filter @viflo/web run test src/validation/llm-test-gate.test.ts
```

Expected:

- Default test paths remain non-LLM and deterministic.
- LLM path is off by default, requires explicit opt-in, and only allows low-cost/local profiles.
- Invalid profiles fail closed with clear remediation.
- Policy module tests pass and document intended behavior.
  </verification>

<success_criteria>

- COST-01 enforcement artifacts exist and are wired to explicit opt-in command path.
- Default CI/local quality gates are unaffected by optional LLM test mode.
- LLM gating behavior is fail-closed, deterministic, and test-covered.
- Contributor docs make policy and usage unambiguous.
  </success_criteria>

<output>
After execution, create `.planning/phases/21-test-reliability-and-budget-guards/21-02-SUMMARY.md`.
</output>
